<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0d1b2a">
  <title>ADV Teammate Handbook — The Retail Odyssey Company</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=DM+Serif+Display&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    :root {
      --navy-950: #060e1a;
      --navy-900: #0d1b2a;
      --navy-800: #1b2d4a;
      --navy-700: #243b5e;
      --navy-600: #2e4a72;
      --blue-500: #4a90c4;
      --blue-400: #6aaddb;
      --blue-300: #7cb9d8;
      --blue-200: #a3d5e8;
      --blue-100: #d4ecf5;
      --blue-50: #eef7fb;
      --slate-900: #0f172a;
      --slate-800: #1e293b;
      --slate-700: #334155;
      --slate-600: #475569;
      --slate-500: #64748b;
      --slate-400: #94a3b8;
      --slate-300: #cbd5e1;
      --slate-200: #e2e8f0;
      --slate-100: #f1f5f9;
      --slate-50: #f8fafc;
      --white: #ffffff;
      --red-500: #ef4444;
      --green-500: #22c55e;
      --amber-500: #f59e0b;
      --bottom-nav-height: calc(68px * 1.2);
      --bottom-nav-scale: 1.2;
      --reader-controls-scale: 0.5;
      --menu-btn-size: 40px;
      --menu-btn-gap: 12px;
      --watermark-logo: url('ro_logo.png');
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
    body {
      font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
      background: var(--navy-950);
      color: var(--slate-800);
      line-height: 1.6;
      min-height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* ═══════════════════════════════════════════════════
       LOADING SCREEN
       ═══════════════════════════════════════════════════ */
    #loadingScreen {
      position: fixed; inset: 0; z-index: 9999;
      background: var(--navy-900);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      transition: opacity 0.6s ease, visibility 0.6s ease;
    }
    #loadingScreen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .loading-logo {
      height: clamp(40px, 8vw, 56px);
      max-width: 60vw;
      object-fit: contain;
      margin-bottom: 2rem;
      animation: loadPulse 2s ease-in-out infinite;
    }
    .loading-bar-track { width: 200px; height: 3px; background: rgba(74,144,196,0.15); border-radius: 3px; overflow: hidden; }
    .loading-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--blue-500), var(--blue-300)); border-radius: 3px; transition: width 0.3s ease; }
    .loading-text { color: var(--slate-400); font-size: 0.8rem; margin-top: 1rem; letter-spacing: 0.05em; }
    @keyframes loadPulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

    /* ═══════════════════════════════════════════════════
       TOC / LANDING VIEW
       ═══════════════════════════════════════════════════ */
    #tocView {
      position: fixed; inset: 0; z-index: 50;
      background: var(--navy-900);
      overflow-y: auto; overflow-x: hidden;
      transition: opacity 0.4s ease, transform 0.4s ease;
      isolation: isolate;
    }
    #tocView::before,
    #readerView::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: var(--watermark-logo);
      background-repeat: repeat;
      background-position: center top;
      background-size: min(220px, 26vw);
      opacity: 0.06;
      pointer-events: none;
      z-index: 0;
    }
    #tocView::before { display: none; }
    #tocView.hidden {
      opacity: 0; transform: translateY(20px);
      pointer-events: none; visibility: hidden;
    }

    .toc-header {
      position: relative;
      padding: 2.5rem 2rem 2.25rem;
      text-align: center;
      background: linear-gradient(180deg, var(--navy-950) 0%, var(--navy-900) 100%);
      overflow: hidden;
    }
    .toc-header::before {
      content: '';
      position: absolute; top: -80px; right: -60px;
      width: 300px; height: 300px;
      background: radial-gradient(circle, rgba(74,144,196,0.08) 0%, transparent 70%);
      border-radius: 50%;
    }
    .toc-header::after {
      content: '';
      position: absolute; bottom: -100px; left: -40px;
      width: 250px; height: 250px;
      background: radial-gradient(circle, rgba(106,173,219,0.06) 0%, transparent 70%);
      border-radius: 50%;
    }
    .toc-header-content {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      max-width: 100%;
      position: relative;
      z-index: 2;
    }
    .toc-logo {
      width: auto;
      max-width: 100%;
      height: auto;
      object-fit: contain;
      margin-bottom: 1.5rem;
      display: block;
    }
    .toc-title {
      font-family: 'DM Serif Display', serif;
      font-size: clamp(1.6rem, 4vw, 2.2rem);
      color: var(--white);
      margin-bottom: 0.4rem;
      display: inline-block;
    }
    .toc-subtitle {
      color: var(--slate-400);
      font-size: 0.85rem;
      font-weight: 400;
      position: relative; z-index: 1;
    }
    .toc-actions {
      display: flex; gap: 0.75rem;
      justify-content: center;
      margin-top: 1.5rem;
      position: relative; z-index: 1;
      flex-wrap: wrap;
    }
    .toc-action-btn {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.65rem 1.4rem;
      border-radius: 8px;
      font-family: inherit; font-size: 0.85rem; font-weight: 600;
      cursor: pointer; border: none;
      transition: all 0.2s ease;
      text-decoration: none;
    }
    .toc-action-btn.primary {
      background: var(--blue-500);
      color: var(--white);
    }
    .toc-action-btn.primary:hover { background: var(--blue-400); transform: translateY(-1px); }
    .toc-action-btn.secondary {
      background: rgba(74,144,196,0.12);
      color: var(--blue-300);
      border: 1px solid rgba(74,144,196,0.25);
    }
    .toc-action-btn.secondary:hover { background: rgba(74,144,196,0.2); }
    .toc-action-btn svg { width: 16px; height: 16px; }

    .toc-body {
      max-width: 720px;
      margin: 0 auto;
      padding: 1.5rem 1.5rem calc(10rem + var(--bottom-nav-height));
      position: relative;
      z-index: 2;
    }
    .toc-watermark {
      position: absolute;
      inset: 0;
      background-image: var(--watermark-logo);
      background-repeat: repeat;
      background-position: center top;
      background-size: min(220px, 26vw);
      opacity: 0.07;
      pointer-events: none;
      z-index: 1;
    }
    #tocView .toc-watermark { display: none; }

    .toc-search-bar {
      position: relative; margin-bottom: 1.5rem;
    }
    .toc-search-bar input {
      width: 100%; padding: 0.75rem 1rem 0.75rem 2.75rem;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 10px;
      font-family: inherit; font-size: 0.9rem;
      color: var(--white);
      outline: none;
      transition: border-color 0.2s, background 0.2s;
    }
    .toc-search-bar input::placeholder { color: var(--slate-500); }
    .toc-search-bar input:focus {
      border-color: var(--blue-500);
      background: rgba(255,255,255,0.08);
    }
    .toc-search-bar .search-icon {
      position: absolute; left: 0.85rem; top: 50%; transform: translateY(-50%);
      width: 18px; height: 18px; color: var(--slate-500);
      pointer-events: none;
    }
    .toc-search-results {
      display: none;
      margin-top: 0.5rem;
    }
    .toc-search-results.show { display: block; }
    .toc-search-item {
      padding: 0.85rem 1rem;
      border-radius: 10px;
      background: rgba(74,144,196,0.08);
      border: 1px solid rgba(74,144,196,0.12);
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    .toc-search-item:hover { background: rgba(74,144,196,0.16); }
    .toc-search-item.visited { opacity: 0.6; }
    .toc-search-item .result-title {
      font-size: 0.85rem; color: var(--white); font-weight: 600; margin-bottom: 0.25rem;
    }
    .toc-search-item .result-meta {
      font-size: 0.72rem; color: var(--slate-500); text-transform: uppercase; letter-spacing: 0.05em;
    }
    .toc-search-item .result-snippet {
      font-size: 0.78rem; color: var(--slate-300); line-height: 1.5;
    }
    .toc-search-item .result-snippet mark {
      background: rgba(74,144,196,0.3);
      color: var(--blue-200);
      border-radius: 2px; padding: 0 2px;
    }

    .toc-group { margin-bottom: 0.5rem; }
    .toc-group-header {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.85rem 1rem;
      background: rgba(74,144,196,0.08);
      border: 1px solid rgba(74,144,196,0.12);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 2px;
    }
    .toc-group-header:hover { background: rgba(74,144,196,0.14); }
    .toc-group-header .section-number {
      width: 28px; height: 28px;
      background: var(--blue-500);
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 700; color: var(--white);
      flex-shrink: 0;
    }
    .toc-group-header .section-title {
      flex: 1;
      font-size: 0.9rem; font-weight: 700;
      color: var(--white);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .toc-group-header .section-page {
      font-size: 0.75rem; color: var(--slate-400);
      font-weight: 500;
    }
    .toc-group-header .chevron {
      width: 16px; height: 16px; color: var(--slate-500);
      transition: transform 0.25s ease;
      flex-shrink: 0;
    }
    .toc-group.open .toc-group-header .chevron { transform: rotate(90deg); }

    .toc-subitems {
      max-height: 0; overflow: hidden;
      transition: max-height 0.35s ease;
      padding-left: 0.5rem;
    }
    .toc-group.open .toc-subitems { max-height: 2000px; }

    .toc-subitem {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.55rem 1rem 0.55rem 3.25rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .toc-subitem:hover { background: rgba(74,144,196,0.08); }
    .toc-subitem .sub-title {
      flex: 1;
      font-size: 0.84rem; color: var(--slate-300);
      font-weight: 400;
    }
    .toc-subitem .sub-page {
      font-size: 0.72rem; color: var(--slate-500);
      font-weight: 500;
      min-width: 24px; text-align: right;
    }

    /* ═══════════════════════════════════════════════════
       PDF READER VIEW
       ═══════════════════════════════════════════════════ */
    #readerView {
      position: fixed; inset: 0; z-index: 40;
      background: var(--navy-950);
      display: flex; flex-direction: column;
      transition: opacity 0.3s ease;
      isolation: isolate;
    }
    #readerView.hidden { opacity: 0; pointer-events: none; visibility: hidden; }

    /* Top Toolbar */
    .reader-toolbar {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      padding-left: calc(max(0.75rem, env(safe-area-inset-left)) + var(--menu-btn-size) + var(--menu-btn-gap));
      background: var(--navy-900);
      border-bottom: 1px solid rgba(74,144,196,0.12);
      flex-shrink: 0;
      z-index: 10;
    }
    .toolbar-logo {
      height: clamp(18px, 4vw, 32px);
      width: auto;
      max-width: min(220px, 45vw);
      object-fit: contain;
      margin-right: 0.25rem;
      cursor: pointer;
    }
    .toolbar-divider { width: 1px; height: 24px; background: rgba(74,144,196,0.15); margin: 0 0.25rem; }
    .toolbar-page-info { display: none; }
    .toolbar-spacer { flex: 1; }
    .toolbar-btn {
      display: flex; align-items: center; justify-content: center; gap: 0.35rem;
      padding: 0.4rem 0.6rem;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: var(--slate-400);
      font-family: inherit; font-size: 0.75rem; font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }
    .toolbar-btn:disabled { opacity: 0.35; cursor: not-allowed; }
    .toolbar-btn:hover { background: rgba(74,144,196,0.1); color: var(--blue-300); }
    .toolbar-btn.active { background: rgba(74,144,196,0.15); color: var(--blue-400); border-color: rgba(74,144,196,0.25); }
    .toolbar-btn svg, .toolbar-btn .icon-img { width: 16px; height: 16px; flex-shrink: 0; }
    .toolbar-btn .icon-img.supplement-icon { width: 16px; height: 12.96px; }
    .toolbar-btn .btn-label { display: inline; }
    @media (max-width: 640px) { .toolbar-btn .btn-label { display: none; } }

    .toolbar-btn.ack-btn {
      background: var(--blue-500);
      color: var(--white);
      border-color: var(--blue-500);
      text-decoration: none;
    }
    .toolbar-btn.ack-btn:hover { background: var(--blue-400); border-color: var(--blue-400); }

    /* Zoom controls */
    .zoom-controls {
      display: flex; align-items: center; gap: 2px;
      background: rgba(255,255,255,0.04);
      border-radius: 6px;
      padding: 2px;
    }
    .zoom-btn {
      display: flex; align-items: center; justify-content: center;
      width: 30px; height: 30px;
      background: transparent; border: none; border-radius: 4px;
      color: var(--slate-400); cursor: pointer;
      transition: all 0.15s ease;
    }
    .zoom-btn:hover { background: rgba(74,144,196,0.15); color: var(--blue-300); }
    .zoom-btn svg { width: 15px; height: 15px; }
    .zoom-level {
      font-size: 0.72rem; color: var(--slate-400); font-weight: 600;
      min-width: 38px; text-align: center;
      user-select: none;
    }

    /* App Menu (hamburger) */
    .app-menu-button {
      position: fixed;
      top: max(0.5rem, env(safe-area-inset-top));
      left: max(0.5rem, env(safe-area-inset-left));
      width: var(--menu-btn-size); height: var(--menu-btn-size);
      display: flex; align-items: center; justify-content: center;
      background: rgba(13,27,42,0.92);
      border: 1px solid rgba(74,144,196,0.35);
      border-radius: 10px;
      color: var(--blue-200);
      cursor: pointer;
      z-index: 130;
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
      transition: all 0.15s ease;
      backdrop-filter: blur(4px);
    }
    .app-menu-button:hover { background: rgba(13,27,42,1); color: var(--blue-100); }
    .app-menu-button.active { background: rgba(74,144,196,0.2); color: var(--blue-100); border-color: rgba(74,144,196,0.5); }
    .app-menu-button svg { width: 20px; height: 20px; }

    .app-menu-backdrop {
      position: fixed; inset: 0; z-index: 120;
      background: rgba(6,14,26,0.55);
      opacity: 0; visibility: hidden;
      transition: all 0.2s ease;
    }
    .app-menu-backdrop.show { opacity: 1; visibility: visible; }

    .app-menu-panel {
      position: fixed;
      top: max(3.25rem, calc(env(safe-area-inset-top) + 3rem));
      left: max(0.5rem, env(safe-area-inset-left));
      width: min(320px, 92vw);
      max-height: calc(100vh - 5rem);
      overflow: auto;
      background: var(--navy-900);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 12px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.45);
      opacity: 0; visibility: hidden; transform: translateY(-6px);
      transition: all 0.2s ease;
      z-index: 130;
    }
    .app-menu-panel.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .app-menu-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.85rem 1rem; border-bottom: 1px solid rgba(74,144,196,0.12);
      color: var(--white); font-weight: 600; font-size: 0.9rem;
    }
    .app-menu-close {
      width: 32px; height: 32px; border-radius: 8px;
      border: 1px solid transparent; background: transparent; color: var(--slate-300);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    }
    .app-menu-close:hover { background: rgba(74,144,196,0.15); color: var(--white); }
    .app-menu-section { padding: 0.75rem 1rem 0.25rem; }
    .app-menu-title { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--slate-400); margin-bottom: 0.5rem; }
    .app-menu-item {
      width: 100%;
      display: flex; align-items: center; justify-content: space-between;
      gap: 0.5rem;
      padding: 0.55rem 0.6rem;
      margin-bottom: 0.35rem;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(74,144,196,0.15);
      border-radius: 8px;
      color: var(--slate-100);
      font-size: 0.82rem; font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .app-menu-item:hover { background: rgba(74,144,196,0.16); color: var(--white); }
    .app-menu-kbd {
      font-size: 0.7rem; font-weight: 600; color: var(--slate-300);
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 6px; padding: 0.1rem 0.4rem; white-space: nowrap;
      background: rgba(15,23,42,0.5);
    }
    .app-menu-shortcut {
      display: flex; align-items: center; justify-content: space-between;
      color: var(--slate-200); font-size: 0.78rem;
      padding: 0.35rem 0.1rem;
      border-bottom: 1px dashed rgba(74,144,196,0.12);
    }
    .app-menu-shortcut:last-child { border-bottom: none; }

    /* Page Canvas Area */
    .reader-canvas-area {
      flex: 1; overflow: auto;
      display: flex; align-items: flex-start; justify-content: center;
      padding: 1rem 1rem calc(1rem + var(--bottom-nav-height) + env(safe-area-inset-bottom));
      position: relative;
      touch-action: pan-y pinch-zoom;
    }
    .reader-canvas-area.swiping { touch-action: none; }
    .resources-overlay {
      position: absolute;
      background: #ffffff;
      color: #0f172a;
      border-radius: 6px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.25);
      padding: 1.5rem 1.75rem;
      overflow: auto;
      display: none;
      z-index: 3;
    }
    .resources-overlay.show { display: block; }
    .resources-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
      color: #0d1b2a;
    }
    .resources-sub {
      font-size: 0.78rem;
      color: #64748b;
      margin-bottom: 1.25rem;
    }
    .resources-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.86rem;
    }
    .resources-table td {
      padding: 0.45rem 0;
      vertical-align: top;
    }
    .resources-table td:first-child {
      width: 34%;
      font-weight: 600;
      color: #0f172a;
      padding-right: 1rem;
    }
    .resources-table a {
      color: #1d4ed8;
      text-decoration: none;
      word-break: break-word;
    }
    .resources-table a:hover { text-decoration: underline; }
    .resources-note {
      color: #475569;
      font-size: 0.78rem;
      margin-top: 0.25rem;
    }

    #pdfCanvas {
      background: var(--white);
      box-shadow: 0 4px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.05);
      border-radius: 4px;
      max-width: none;
      transition: transform 0.15s ease;
      position: relative;
      z-index: 1;
    }

    .search-highlight-layer {
      position: absolute;
      pointer-events: none;
      z-index: 2;
    }
    .search-highlight {
      position: absolute;
      background: rgba(250,204,21,0.32);
      border: 1px solid rgba(250,204,21,0.6);
      border-radius: 2px;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
    }
    .textLayer {
      position: absolute;
      pointer-events: none;
      color: transparent;
      z-index: 2;
    }
    .textLayer span {
      position: absolute;
      white-space: pre;
      transform-origin: 0 0;
      line-height: 1;
    }
    .textLayer .search-text-hit {
      background: rgba(250,204,21,0.35);
      box-shadow: 0 0 0 1px rgba(250,204,21,0.7);
      border-radius: 2px;
      color: transparent;
    }

    .search-nav-overlay {
      position: fixed;
      top: 1rem;
      right: 1rem;
      bottom: auto;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 12px;
      padding: 0.6rem 0.75rem;
      color: var(--white);
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      width: min(360px, 92vw);
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      opacity: 0;
      transform: translateY(8px);
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 70;
      cursor: grab;
      touch-action: none;
    }
    .search-nav-overlay.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .search-nav-overlay.dragging { cursor: grabbing; }
    .search-nav-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .search-nav-input {
      flex: 1;
      min-width: 0;
      padding: 0.35rem 0.5rem;
      border-radius: 8px;
      border: 1px solid rgba(74,144,196,0.25);
      background: rgba(255,255,255,0.08);
      color: var(--white);
      font-size: 0.8rem;
      outline: none;
    }
    .search-nav-input::placeholder { color: var(--slate-300); }
    .search-nav-actions {
      display: inline-flex;
      gap: 0.35rem;
    }
    .search-nav-action {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid rgba(74,144,196,0.2);
      background: rgba(74,144,196,0.12);
      color: var(--white);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .search-nav-action svg { width: 14px; height: 14px; }
    .search-nav-action:hover { background: rgba(74,144,196,0.2); }
    .search-nav-overlay.minimized .search-nav-meta,
    .search-nav-overlay.minimized .search-nav-section,
    .search-nav-overlay.minimized .search-nav-controls {
      display: none;
    }
    .search-nav-meta {
      font-size: 0.78rem;
      color: var(--slate-300);
      line-height: 1.3;
    }
    .search-nav-section {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--white);
    }
    .search-nav-controls {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      justify-content: flex-end;
    }
    .search-nav-results-btn {
      margin-right: auto;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    .search-nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      padding: 0.35rem 0.55rem;
      border-radius: 8px;
      border: 1px solid rgba(74,144,196,0.2);
      background: rgba(74,144,196,0.12);
      color: var(--white);
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.15s ease;
    }
    .search-nav-btn svg { width: 14px; height: 14px; }
    .search-nav-btn:hover { background: rgba(74,144,196,0.2); }
    .search-nav-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }
    .search-nav-close {
      margin-left: auto;
      background: transparent;
      border: none;
      color: var(--slate-400);
      cursor: pointer;
      padding: 0.2rem;
    }
    .search-nav-close:hover { color: var(--white); }

    .home-bottom-nav {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: calc(0.5rem * var(--bottom-nav-scale)) calc(0.75rem * var(--bottom-nav-scale)) max(calc(0.5rem * var(--bottom-nav-scale)), env(safe-area-inset-bottom));
      background: rgba(6,14,26,0.98);
      border-top: 1px solid rgba(74,144,196,0.15);
      gap: calc(0.5rem * var(--bottom-nav-scale));
      z-index: 60;
    }
    .home-bottom-nav .toolbar-btn {
      flex: 1;
      justify-content: center;
      padding: calc(0.4rem * var(--bottom-nav-scale)) calc(0.6rem * var(--bottom-nav-scale));
      font-size: calc(0.75rem * var(--bottom-nav-scale));
      border-radius: calc(6px * var(--bottom-nav-scale));
    }
    .home-bottom-nav .toolbar-btn svg {
      width: calc(16px * var(--bottom-nav-scale));
      height: calc(16px * var(--bottom-nav-scale));
    }
    .home-bottom-nav .reader-controls {
      display: none;
      align-items: center;
      gap: calc(0.5rem * var(--reader-controls-scale));
      flex: 1 1 100%;
      padding: calc(0.35rem * var(--reader-controls-scale)) calc(0.25rem * var(--reader-controls-scale)) calc(0.15rem * var(--reader-controls-scale));
    }
    body.reader-active .home-bottom-nav .reader-controls { display: flex; }
    .nav-btn {
      display: flex; align-items: center; justify-content: center;
      width: calc(40px * var(--reader-controls-scale));
      height: calc(34px * var(--reader-controls-scale));
      background: rgba(74,144,196,0.08);
      border: 1px solid rgba(74,144,196,0.15);
      border-radius: calc(8px * var(--reader-controls-scale));
      color: var(--slate-400);
      cursor: pointer;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }
    .nav-btn:hover { background: rgba(74,144,196,0.18); color: var(--blue-300); }
    .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .nav-btn svg {
      width: calc(18px * var(--reader-controls-scale));
      height: calc(18px * var(--reader-controls-scale));
    }

    .page-slider-container {
      flex: 1;
      display: flex;
      align-items: center;
      padding: 0 calc(0.35rem * var(--reader-controls-scale));
    }
    .page-slider-wrap { position: relative; width: 100%; }
    .page-slider {
      width: 100%; height: calc(4px * var(--reader-controls-scale));
      -webkit-appearance: none; appearance: none;
      background: rgba(74,144,196,0.15);
      border-radius: calc(4px * var(--reader-controls-scale));
      outline: none;
      cursor: pointer;
    }
    .page-slider::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: calc(16px * var(--reader-controls-scale));
      height: calc(16px * var(--reader-controls-scale));
      background: var(--blue-500);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(74,144,196,0.4);
    }
    .page-slider::-moz-range-thumb {
      width: calc(16px * var(--reader-controls-scale));
      height: calc(16px * var(--reader-controls-scale));
      background: var(--blue-500);
      border-radius: 50%; border: none;
      cursor: pointer;
    }
    .page-bubble {
      position: absolute;
      top: calc(-34px * var(--reader-controls-scale));
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.92);
      color: var(--white);
      font-size: calc(0.72rem * var(--reader-controls-scale));
      padding: calc(0.2rem * var(--reader-controls-scale)) calc(0.5rem * var(--reader-controls-scale));
      border-radius: calc(6px * var(--reader-controls-scale));
      border: 1px solid rgba(74,144,196,0.35);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
      white-space: nowrap;
    }
    .page-bubble.show { opacity: 1; }

    /* ═══════════════════════════════════════════════════
       TOC OVERLAY (in reader)
       ═══════════════════════════════════════════════════ */
    .overlay-backdrop {
      position: fixed; inset: 0; z-index: 60;
      background: rgba(6,14,26,0.7);
      backdrop-filter: blur(4px);
      opacity: 0; visibility: hidden;
      transition: all 0.3s ease;
    }
    .overlay-backdrop.show { opacity: 1; visibility: visible; }

    .toc-overlay {
      position: fixed; top: 0; left: 0; bottom: 0;
      width: min(380px, 85vw); z-index: 61;
      background: var(--navy-900);
      border-right: 1px solid rgba(74,144,196,0.15);
      transform: translateX(-100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
      display: flex; flex-direction: column;
    }
    .toc-overlay.show { transform: translateX(0); }

    .toc-overlay-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid rgba(74,144,196,0.12);
      flex-shrink: 0;
    }
    .toc-overlay-header h3 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.1rem; color: var(--white);
    }
    .toc-overlay-close {
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.06);
      border: none; border-radius: 6px;
      color: var(--slate-400); cursor: pointer;
      transition: all 0.15s;
    }
    .toc-overlay-close:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .toc-overlay-close svg { width: 16px; height: 16px; }

    .toc-overlay-body { flex: 1; overflow-y: auto; padding: 0.75rem 0.75rem 3rem; }

    .toc-ol-group { margin-bottom: 0.25rem; }
    .toc-ol-section {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.6rem 0.75rem;
      border-radius: 8px; cursor: pointer;
      transition: background 0.15s;
    }
    .toc-ol-section:hover { background: rgba(74,144,196,0.1); }
    .toc-ol-section.current { background: rgba(74,144,196,0.15); }
    .toc-ol-section .ol-dot {
      width: 6px; height: 6px;
      background: var(--blue-500);
      border-radius: 50%; flex-shrink: 0;
    }
    .toc-ol-section.current .ol-dot { box-shadow: 0 0 6px var(--blue-400); }
    .toc-ol-section .ol-title {
      flex: 1; font-size: 0.82rem; font-weight: 600;
      color: var(--white);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .toc-ol-section .ol-page {
      font-size: 0.7rem; color: var(--slate-500);
      font-weight: 500;
    }

    .toc-ol-sub {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.4rem 0.75rem 0.4rem 2rem;
      border-radius: 6px; cursor: pointer;
      transition: background 0.15s;
    }
    .toc-ol-sub:hover { background: rgba(74,144,196,0.08); }
    .toc-ol-sub.current { background: rgba(74,144,196,0.1); }
    .toc-ol-sub .ol-title {
      flex: 1; font-size: 0.78rem; color: var(--slate-300);
      font-weight: 400;
    }
    .toc-ol-sub .ol-page {
      font-size: 0.68rem; color: var(--slate-500);
      font-weight: 500;
    }

    /* ═══════════════════════════════════════════════════
       SEARCH OVERLAY
       ═══════════════════════════════════════════════════ */
    .search-overlay {
      position: fixed; top: 0; right: 0; bottom: 0;
      width: min(420px, 90vw); z-index: 61;
      background: var(--navy-900);
      border-left: 1px solid rgba(74,144,196,0.15);
      transform: translateX(100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column;
    }
    .search-overlay.show { transform: translateX(0); }

    .search-overlay-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid rgba(74,144,196,0.12);
      flex-shrink: 0;
    }
    .search-overlay-header .search-row {
      display: flex; align-items: center; gap: 0.5rem;
    }
    .search-overlay-header input {
      flex: 1; padding: 0.65rem 0.9rem;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 8px;
      font-family: inherit; font-size: 0.88rem;
      color: var(--white); outline: none;
      transition: border-color 0.2s;
    }
    .search-overlay-header input:focus { border-color: var(--blue-500); }
    .search-overlay-header input::placeholder { color: var(--slate-500); }
    .search-count { font-size: 0.75rem; color: var(--slate-500); margin-top: 0.5rem; }

    .search-results { flex: 1; overflow-y: auto; padding: 0.5rem 0.5rem 3rem; }
    .search-result-item {
      padding: 0.75rem; border-radius: 8px;
      cursor: pointer; transition: background 0.15s;
      margin-bottom: 2px;
    }
    .search-result-item:hover { background: rgba(74,144,196,0.08); }
    .search-result-item.visited { opacity: 0.6; }
    .search-result-item .result-page {
      font-size: 0.72rem; color: var(--blue-400);
      font-weight: 600; margin-bottom: 0.25rem;
    }
    .search-result-item .result-context {
      font-size: 0.8rem; color: var(--slate-300);
      line-height: 1.5;
    }
    .search-result-item .result-context mark {
      background: rgba(74,144,196,0.3);
      color: var(--blue-200);
      border-radius: 2px; padding: 0 2px;
    }

    /* ═══════════════════════════════════════════════════
       STATE SUPPLEMENT OVERLAY
       ═══════════════════════════════════════════════════ */
    .supplement-overlay {
      position: fixed; inset: 0; z-index: 62;
      background: rgba(6,14,26,0.7);
      backdrop-filter: blur(6px);
      display: none; align-items: center; justify-content: center;
      padding: 1.5rem;
    }
    .supplement-overlay.show { display: flex; }
    .supplement-panel {
      width: min(720px, 94vw);
      background: var(--navy-900);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 16px;
      box-shadow: 0 24px 64px rgba(0,0,0,0.45);
      display: flex; flex-direction: column;
      max-height: min(78vh, 760px);
    }
    .supplement-header {
      padding: 1.25rem 1.5rem 1rem;
      border-bottom: 1px solid rgba(74,144,196,0.12);
      display: flex; align-items: center; justify-content: space-between; gap: 1rem;
    }
    .supplement-header h3 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.25rem; font-weight: 400; color: var(--white);
    }
    .supplement-header p {
      font-size: 0.8rem; color: var(--slate-400);
    }
    .supplement-body { padding: 1rem 1.5rem 3rem; overflow-y: auto; }
    .supplement-search {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.6rem 0.8rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    .supplement-search input {
      flex: 1; background: transparent; border: none; outline: none;
      font-family: inherit; font-size: 0.9rem; color: var(--white);
    }
    .supplement-search input::placeholder { color: var(--slate-500); }
    .supplement-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.6rem;
    }
    .supplement-state {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.65rem 0.85rem;
      border-radius: 10px;
      background: rgba(74,144,196,0.08);
      border: 1px solid rgba(74,144,196,0.15);
      color: var(--slate-200);
      font-size: 0.88rem; font-weight: 600;
      cursor: pointer; transition: all 0.15s ease;
    }
    .supplement-state:hover { background: rgba(74,144,196,0.18); color: var(--white); }
    .supplement-state small { font-size: 0.7rem; color: var(--slate-500); font-weight: 600; }
    .supplement-footer {
      padding: 0.9rem 1.5rem 1.25rem;
      border-top: 1px solid rgba(74,144,196,0.12);
      display: flex; align-items: center; justify-content: space-between; gap: 1rem;
      color: var(--slate-500); font-size: 0.78rem;
    }
    .supplement-close {
      display: inline-flex; align-items: center; gap: 0.4rem;
      padding: 0.45rem 0.85rem;
      border-radius: 8px; border: 1px solid rgba(74,144,196,0.2);
      background: rgba(255,255,255,0.05);
      color: var(--slate-300); cursor: pointer;
      transition: background 0.15s ease;
    }
    .supplement-close:hover { background: rgba(255,255,255,0.12); }

    /* ═══════════════════════════════════════════════════
       SECTION TOOLS POPOVER
       ═══════════════════════════════════════════════════ */
    .section-tools-pop {
      position: fixed; z-index: 55;
      background: var(--navy-800);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 10px;
      padding: 0.5rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      opacity: 0; visibility: hidden;
      transform: translateY(4px);
      transition: all 0.2s ease;
    }
    .section-tools-pop.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .section-tool-btn {
      display: flex; align-items: center; gap: 0.6rem;
      width: 100%; padding: 0.55rem 0.85rem;
      background: transparent; border: none; border-radius: 6px;
      color: var(--slate-300); font-family: inherit;
      font-size: 0.8rem; cursor: pointer;
      transition: background 0.15s;
      white-space: nowrap;
    }
    .section-tool-btn:hover { background: rgba(74,144,196,0.12); color: var(--white); }
    .section-tool-btn svg { width: 15px; height: 15px; flex-shrink: 0; color: var(--blue-400); }

    /* ═══════════════════════════════════════════════════
       TOAST NOTIFICATION
       ═══════════════════════════════════════════════════ */
    .toast {
      position: fixed; bottom: 5rem; left: 50%; transform: translateX(-50%) translateY(20px);
      background: var(--navy-800);
      border: 1px solid rgba(74,144,196,0.2);
      color: var(--white);
      padding: 0.65rem 1.25rem;
      border-radius: 8px;
      font-size: 0.82rem; font-weight: 500;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      opacity: 0; visibility: hidden;
      transition: all 0.3s ease;
      z-index: 100;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .toast svg { width: 16px; height: 16px; color: var(--green-500); }

    /* ═══════════════════════════════════════════════════
       UTILITY & ANIMATIONS
       ═══════════════════════════════════════════════════ */
    .fade-in { animation: fadeIn 0.4s ease forwards; }
    .stagger-1 { animation-delay: 0.05s; opacity: 0; }
    .stagger-2 { animation-delay: 0.1s; opacity: 0; }
    .stagger-3 { animation-delay: 0.15s; opacity: 0; }
    .stagger-4 { animation-delay: 0.2s; opacity: 0; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(74,144,196,0.2); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(74,144,196,0.35); }

    /* Print styles */
    @media print {
      body { overflow: visible; background: white; }
      #tocView, .reader-toolbar, .reader-bottom, .overlay-backdrop,
      .toc-overlay, .search-overlay, .toast, .section-tools-pop,
      .app-menu-button, .app-menu-panel, .app-menu-backdrop { display: none !important; }
      #readerView { position: static; }
      .reader-canvas-area { overflow: visible; padding: 0; }
      #pdfCanvas { box-shadow: none; max-width: 100%; }
    }

    /* ═══════════════════════════════════════════════════
       MOBILE: TABLET (≤768px)
       ═══════════════════════════════════════════════════ */
    @media (max-width: 768px) {
      .toc-overlay { width: min(420px, 92vw); }
      .search-overlay { width: min(420px, 92vw); }
      .toc-group-header { padding: 0.95rem 1rem; }
      .toc-subitem { padding: 0.65rem 1rem 0.65rem 3.25rem; }
      .toc-ol-section { padding: 0.75rem 0.85rem; }
      .toc-ol-sub { padding: 0.55rem 0.85rem 0.55rem 2rem; }
      .search-result-item { padding: 0.85rem; }
    }

    /* ═══════════════════════════════════════════════════
       MOBILE: PHONE (≤640px)
       ═══════════════════════════════════════════════════ */
    @media (max-width: 640px) {
      body { -webkit-tap-highlight-color: transparent; }

      /* Safe area for notched phones */
      .reader-toolbar { padding: 0.4rem max(0.5rem, env(safe-area-inset-left)) 0.4rem max(0.5rem, env(safe-area-inset-right)); }
      .reader-toolbar { padding-left: calc(max(0.5rem, env(safe-area-inset-left)) + var(--menu-btn-size) + 8px); }
      .reader-bottom { padding: 0.5rem max(0.75rem, env(safe-area-inset-left)) max(0.5rem, env(safe-area-inset-bottom)) max(0.75rem, env(safe-area-inset-right)); }

      /* TOC Landing */
      .toc-header { padding: 2rem 1.25rem 1.75rem; }
      .toc-logo { height: auto; }
      .toc-title { font-size: 1.5rem; }
      .toc-body { padding: 1rem 0.75rem calc(7rem + var(--bottom-nav-height)); }
      .toc-action-btn { justify-content: center; padding: 0.75rem 1.2rem; font-size: 0.9rem; }
      .toc-search-bar input { padding: 0.85rem 1rem 0.85rem 2.75rem; font-size: 1rem; }

      /* TOC items — larger touch targets */
      .toc-group-header { padding: 1rem; min-height: 52px; }
      .toc-group-header .section-title { font-size: 0.85rem; }
      .toc-subitem { padding: 0.7rem 1rem 0.7rem 3.25rem; min-height: 44px; }
      .toc-subitem .sub-title { font-size: 0.85rem; }

      /* Toolbar — compact info-only row */
      .reader-toolbar { gap: 0.2rem; }
      .reader-toolbar .toolbar-btn, .zoom-controls { display: none; }
      .toolbar-logo { height: 24px; margin-right: 0.15rem; }
      .toolbar-divider { display: none; }
      .toolbar-page-info { font-size: 0.72rem; min-width: 58px; }

      /* Zoom — move inline, smaller */
      .zoom-controls { padding: 1px; gap: 1px; }
      .zoom-btn { width: 28px; height: 28px; }
      .zoom-btn svg { width: 14px; height: 14px; }
      .zoom-level { font-size: 0.65rem; min-width: 32px; }

      /* Canvas area — edge-to-edge */
      .reader-canvas-area { padding: 0.5rem 0.25rem calc(0.5rem + var(--bottom-nav-height) + env(safe-area-inset-bottom)); }
      #pdfCanvas { border-radius: 2px; }

      /* Bottom nav — larger touch targets */
      .nav-btn { width: 44px; height: 44px; }
      .nav-btn svg { width: 20px; height: 20px; }
      .page-slider { height: 6px; }
      .page-slider::-webkit-slider-thumb { width: 22px; height: 22px; }
      .page-slider::-moz-range-thumb { width: 22px; height: 22px; }
      .reader-actions { display: flex; }

      /* Overlays — full screen on mobile */
      .toc-overlay { width: 100vw; border-right: none; }
      .search-overlay { width: 100vw; border-left: none; }
      .toc-overlay-header { padding: 0.85rem 1rem; padding-top: max(0.85rem, env(safe-area-inset-top)); }
      .search-overlay-header { padding: 0.85rem 1rem; padding-top: max(0.85rem, env(safe-area-inset-top)); }
      .search-overlay-header input { padding: 0.75rem 0.9rem; font-size: 1rem; }
      .toc-overlay-close { width: 40px; height: 40px; }
      .toc-overlay-close svg { width: 18px; height: 18px; }
      .toc-ol-section { padding: 0.8rem 0.85rem; min-height: 48px; }
      .toc-ol-sub { padding: 0.6rem 0.85rem 0.6rem 2rem; min-height: 44px; }
      .search-result-item { padding: 0.9rem 0.85rem; min-height: 48px; }

      /* State supplement overlay */
      .supplement-overlay { padding: 0; align-items: stretch; }
      .supplement-panel {
        width: 100vw; max-height: none; height: 100vh;
        border-radius: 0;
      }
      .supplement-header { padding: 1rem; padding-top: max(1rem, env(safe-area-inset-top)); }
      .supplement-body { padding: 0.85rem 1rem; }
      .supplement-footer { padding: 0.85rem 1rem max(0.85rem, env(safe-area-inset-bottom)); }

      /* Section tools — bottom sheet on mobile */
      .section-tools-pop {
        position: fixed !important;
        top: auto !important; right: 0 !important; bottom: 0 !important; left: 0 !important;
        width: 100vw;
        border-radius: 16px 16px 0 0;
        padding: 0.75rem 0.75rem max(0.75rem, env(safe-area-inset-bottom));
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      }
      .section-tools-pop.show { transform: translateY(0); }
      .section-tool-btn { padding: 0.85rem 1rem; font-size: 0.88rem; min-height: 48px; }
      .section-tool-btn svg { width: 18px; height: 18px; }

      /* Toast — above bottom bar */
      .toast { bottom: 5.5rem; font-size: 0.85rem; padding: 0.7rem 1.2rem; }
    }

    /* ═══════════════════════════════════════════════════
       MOBILE: SMALL PHONE (≤380px)
       ═══════════════════════════════════════════════════ */
    @media (max-width: 380px) {
      .toc-header { padding: 1.5rem 1rem 1.5rem; }
      .toc-logo { height: auto; }
      .toc-title { font-size: 1.3rem; }
      .toolbar-logo { height: 20px; }
      .toolbar-page-info { font-size: 0.65rem; min-width: 50px; }
      .toolbar-btn { padding: 0.4rem; min-width: 32px; min-height: 32px; }
      .zoom-controls { display: none; }
      .reader-canvas-area { padding: 0.25rem 0 calc(0.25rem + var(--bottom-nav-height) + env(safe-area-inset-bottom)); }
    }

    /* ═══════════════════════════════════════════════════
       LANDSCAPE PHONE
       ═══════════════════════════════════════════════════ */
    @media (max-height: 500px) and (orientation: landscape) {
      .reader-toolbar { padding: 0.25rem 0.5rem; }
      .reader-toolbar { padding-left: calc(0.5rem + var(--menu-btn-size) + 8px); }
      .toolbar-logo { height: 22px; }
      .toolbar-btn { padding: 0.3rem 0.4rem; min-height: 30px; }
      .toolbar-btn .btn-label { display: none; }
      .reader-bottom { padding: 0.3rem 0.75rem; }
      .nav-btn { width: 34px; height: 34px; }
      .reader-canvas-area { padding: 0.25rem 0.25rem calc(0.25rem + var(--bottom-nav-height) + env(safe-area-inset-bottom)); }
    }

    /* Touch-action on all interactive elements */
    button, a, .toc-group-header, .toc-subitem, .toc-ol-section, .toc-ol-sub,
    .search-result-item, .section-tool-btn, .nav-btn, .toolbar-btn, .zoom-btn {
      touch-action: manipulation;
    }
  </style>
</head>
<body>

  <!-- ═══════ LOADING SCREEN ═══════ -->
  <div id="loadingScreen">
    <img src="logo.png" alt="Retail Odyssey" class="loading-logo">
    <div class="loading-bar-track"><div class="loading-bar-fill" id="loadingBar"></div></div>
    <div class="loading-text" id="loadingText">Loading handbook…</div>
  </div>

  <!-- ═══════ APP MENU (ALWAYS AVAILABLE) ═══════ -->
  <button class="app-menu-button" id="appMenuButton" onclick="toggleAppMenu()" aria-label="Open app menu" title="Menu">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M3.75 17.25h16.5"/></svg>
  </button>
  <div class="app-menu-backdrop" id="appMenuBackdrop" onclick="closeAppMenu()"></div>
  <div class="app-menu-panel" id="appMenuPanel" role="dialog" aria-label="App menu">
    <div class="app-menu-header">
      Quick Menu
      <button class="app-menu-close" onclick="closeAppMenu()" title="Close menu">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="app-menu-section">
      <div class="app-menu-title">Navigation</div>
      <button class="app-menu-item" onclick="showTocView(); closeAppMenu();">
        Home / Contents <span class="app-menu-kbd">Home</span>
      </button>
      <button class="app-menu-item" onclick="focusHomeSearch(); closeAppMenu();">
        Search (Home)
      </button>
      <button class="app-menu-item" onclick="toggleSearch(); closeAppMenu();">
        Search (Reader) <span class="app-menu-kbd">Ctrl/⌘+F</span>
      </button>
      <button class="app-menu-item" onclick="toggleTocOverlay(); closeAppMenu();">
        Handbook Contents
      </button>
      <button class="app-menu-item" onclick="openSupplementOverlay(); closeAppMenu();">
        State Supplements
      </button>
      <button class="app-menu-item" onclick="goToAcknowledgement(); closeAppMenu();">
        Sign Acknowledgement
      </button>
    </div>
    <div class="app-menu-section">
      <div class="app-menu-title">Reader Tools</div>
      <button class="app-menu-item" onclick="prevPage(); closeAppMenu();">
        Previous Page <span class="app-menu-kbd">←</span>
      </button>
      <button class="app-menu-item" onclick="nextPage(); closeAppMenu();">
        Next Page <span class="app-menu-kbd">→</span>
      </button>
      <button class="app-menu-item" onclick="zoomIn(); closeAppMenu();">
        Zoom In <span class="app-menu-kbd">+</span>
      </button>
      <button class="app-menu-item" onclick="zoomOut(); closeAppMenu();">
        Zoom Out <span class="app-menu-kbd">−</span>
      </button>
      <button class="app-menu-item" onclick="toggleSectionTools(document.getElementById('toolsToggle')); closeAppMenu();">
        Section Tools
      </button>
      <button class="app-menu-item" onclick="printCurrentPage(); closeAppMenu();">
        Print Current Page
      </button>
      <button class="app-menu-item" onclick="downloadHandbook(); closeAppMenu();">
        Download PDF
      </button>
      <button class="app-menu-item" onclick="copyPageLink(); closeAppMenu();">
        Copy Page Link
      </button>
      <button class="app-menu-item" onclick="copySectionLink(); closeAppMenu();">
        Copy Section Link
      </button>
    </div>
    <div class="app-menu-section">
      <div class="app-menu-title">Shortcuts</div>
      <div class="app-menu-shortcut">Previous / Next page <span class="app-menu-kbd">← / →</span></div>
      <div class="app-menu-shortcut">First / Last page <span class="app-menu-kbd">Home / End</span></div>
      <div class="app-menu-shortcut">Zoom In / Out <span class="app-menu-kbd">+ / −</span></div>
      <div class="app-menu-shortcut">Search <span class="app-menu-kbd">Ctrl/⌘+F</span></div>
      <div class="app-menu-shortcut">Close overlays <span class="app-menu-kbd">Esc</span></div>
    </div>
  </div>

  <!-- ═══════ TOC / LANDING VIEW ═══════ -->
  <div id="tocView" class="hidden">
    <header class="toc-header">
      <div class="toc-header-content">
        <img src="headliner_logo.png" alt="Retail Odyssey" class="toc-logo">
        <h1 class="toc-title">Advantage Teammate Handbook</h1>
        <p class="toc-subtitle">This page revised February 2026 &nbsp;·&nbsp; 56 Pages</p>
      </div>
    </header>

    <div class="toc-body">
      <div class="toc-watermark" aria-hidden="true"></div>
      <div class="toc-search-bar">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/></svg>
        <input type="text" id="tocSearchInput" placeholder="Search handbook and supplements…" autocomplete="off">
      </div>
      <div id="tocSearchResults" class="toc-search-results"></div>
      <div id="tocSections"></div>
    </div>
  </div>

  <!-- ═══════ PDF READER VIEW ═══════ -->
  <div id="readerView" class="hidden">
    <!-- Top Toolbar -->
    <div class="reader-toolbar">
      <img src="headliner_logo.png" alt="Retail Odyssey" class="toolbar-logo" onclick="showTocView()" title="Back to Contents">
      <div class="toolbar-divider"></div>
      <div class="toolbar-page-info" id="pageInfo">Page <strong>1</strong> of 56</div>
      <div class="toolbar-spacer"></div>

      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM13.5 10.5h-6"/></svg>
        </button>
        <span class="zoom-level" id="zoomLevel">100%</span>
        <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6"/></svg>
        </button>
      </div>
      <div class="toolbar-divider"></div>

      <button class="toolbar-btn" id="searchToggle" onclick="toggleSearch()">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#B7950B"/></g><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#F1C40F"/></svg>
        <span class="btn-label">Search</span>
      </button>
      <button class="toolbar-btn" id="tocToggle" onclick="toggleTocOverlay()">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1.5, 1.5)"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zM6.5 18c-1.65 0-3.35.3-4.75 1.05V7.5C3.1 6.75 5.05 6.5 6.5 6.5c1.95 0 4.05.4 5.5 1.5v11.5c-1.45-1.1-3.55-1.5-5.5-1.5z" fill="#117A65"/></g><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zM6.5 18c-1.65 0-3.35.3-4.75 1.05V7.5C3.1 6.75 5.05 6.5 6.5 6.5c1.95 0 4.05.4 5.5 1.5v11.5c-1.45-1.1-3.55-1.5-5.5-1.5z" fill="#2ECC71"/></svg>
        <span class="btn-label">Handbook</span>
      </button>
      <button class="toolbar-btn" id="supplementToggle" onclick="openSupplementOverlay()">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M2 12l2-3 4 1 2-3 5-1 4 3 1 2 2 7-6 1-3 3H8l-3-5-3-1v-4z" fill="#5B2C6F"/></g><path d="M2 12l2-3 4 1 2-3 5-1 4 3 1 2 2 7-6 1-3 3H8l-3-5-3-1v-4z" fill="#9B59B6"/></svg>
        <span class="btn-label">Supplements</span>
      </button>
      <button class="toolbar-btn" id="toolsToggle" onclick="toggleSectionTools(this)">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
        <span class="btn-label">Tools</span>
      </button>
      <button class="toolbar-btn" onclick="goToAcknowledgement()">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M15.5 5.5L13 8 6 15l-1 3 3-1 7-7 2.5-2.5-2-2zm-2 2l1.5 1.5" fill="#C2185B"/><path d="M2 18c2.5-2 4.5-4 7.5-4 3.5 0 5.5 4 9.5 4" stroke="#C2185B" stroke-width="3" stroke-linecap="round"/></g><path d="M15.5 5.5L13 8 6 15l-1 3 3-1 7-7 2.5-2.5-2-2zm-2 2l1.5 1.5" fill="#E91E63"/><path d="M2 18c2.5-2 4.5-4 7.5-4 3.5 0 5.5 4 9.5 4" stroke="#E91E63" stroke-width="3" stroke-linecap="round"/></svg>
        <span class="btn-label">Sign</span>
      </button>
    </div>

    <!-- Canvas Area -->
    <div class="reader-canvas-area" id="canvasArea">
      <canvas id="pdfCanvas"></canvas>
      <div class="textLayer" id="textLayer"></div>
      <div class="resources-overlay" id="resourcesOverlay"></div>
      <div class="search-highlight-layer" id="searchHighlightLayer"></div>
    </div>

    <!-- Bottom Nav -->

    <!-- Search navigation overlay -->
    <div class="search-nav-overlay" id="searchNavOverlay">
      <div class="search-nav-header">
        <input class="search-nav-input" id="searchNavInput" type="text" placeholder="Search…" autocomplete="off">
        <div class="search-nav-actions">
          <button class="search-nav-action" id="searchNavRun" onclick="runSearchFromNav()" title="Search">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-4.35-4.35m0 0A7.5 7.5 0 1 0 5.5 5.5a7.5 7.5 0 0 0 11.15 11.15Z"/></svg>
          </button>
          <button class="search-nav-action" id="searchNavMinimize" onclick="toggleSearchNavMinimize()" title="Minimize search navigation">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14"/></svg>
          </button>
          <button class="search-nav-action" onclick="clearSearchNavigation()" title="Close search navigation">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>
      <div class="search-nav-meta" id="searchNavMeta">Result 0 of 0</div>
      <div class="search-nav-section" id="searchNavSection">Search results</div>
      <div class="search-nav-controls">
        <button class="search-nav-btn search-nav-results-btn" onclick="openSearchResultsFromNav()" title="Back to results">
          Results
        </button>
        <button class="search-nav-btn" id="searchNavPrev" onclick="prevSearchResult()" title="Previous result">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5"/></svg>
          Prev
        </button>
        <button class="search-nav-btn" id="searchNavNext" onclick="nextSearchResult()" title="Next result">
          Next
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- ═══════ OVERLAY BACKDROP ═══════ -->
  <div class="overlay-backdrop" id="overlayBackdrop" onclick="closeAllOverlays()"></div>

  <!-- ═══════ TOC OVERLAY (reader sidebar) ═══════ -->
  <div class="toc-overlay" id="tocOverlay">
    <div class="toc-overlay-header">
      <h3>Contents</h3>
      <button class="toc-overlay-close" onclick="closeTocOverlay()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="toc-overlay-body" id="tocOverlayBody"></div>
  </div>

  <!-- ═══════ SEARCH OVERLAY ═══════ -->
  <div class="search-overlay" id="searchOverlay">
    <div class="search-overlay-header">
      <div class="search-row">
        <input type="text" id="searchInput" placeholder="Search handbook and supplements…" autocomplete="off">
        <button class="toc-overlay-close" onclick="closeSearch()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="search-count" id="searchCount"></div>
    </div>
    <div class="search-results" id="searchResults"></div>
  </div>

  <!-- ═══════ STATE SUPPLEMENT OVERLAY ═══════ -->
  <div class="supplement-overlay" id="supplementOverlay" onclick="closeSupplementOverlayOnBackdrop(event)">
    <div class="supplement-panel">
      <div class="supplement-header">
        <div>
          <h3>State Supplements</h3>
          <p>Select your state to view the 2025 supplement.</p>
        </div>
        <button class="supplement-close" onclick="closeSupplementOverlay()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
          Close
        </button>
      </div>
      <div class="supplement-body">
        <div class="supplement-search">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/></svg>
          <input type="text" id="supplementSearch" placeholder="Search your state">
        </div>
        <div class="supplement-grid" id="supplementGrid"></div>
      </div>
      <div class="supplement-footer">
        <span>Source: State Supplement 2025.pdf</span>
        <button class="supplement-close" onclick="closeSupplementOverlay()">Done</button>
      </div>
    </div>
  </div>

  <!-- ═══════ SECTION TOOLS POPOVER ═══════ -->
  <div class="section-tools-pop" id="sectionToolsPop">
    <button class="section-tool-btn" onclick="printCurrentPage()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m0 0a48.159 48.159 0 0 1 12.5 0m-12.5 0V4.875c0-.621.504-1.125 1.125-1.125h8.25c.621 0 1.125.504 1.125 1.125v2.234"/></svg>
      Print Current Page
    </button>
    <button class="section-tool-btn" onclick="downloadHandbook()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
      Download Full PDF
    </button>
    <button class="section-tool-btn" onclick="copyPageLink()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244"/></svg>
      Copy Link to This Page
    </button>
    <button class="section-tool-btn" onclick="copySectionLink()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z"/></svg>
      Copy Link to This Section
    </button>
  </div>

  <!-- ═══════ TOAST ═══════ -->
  <div class="toast" id="toast">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5"/></svg>
    <span id="toastMsg">Link copied!</span>
  </div>

  <div class="home-bottom-nav">
    <div class="reader-controls" aria-label="Reader navigation">
      <button class="nav-btn" id="btnPrev" onclick="prevPage()" title="Previous Page">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5"/></svg>
      </button>
      <div class="page-slider-container">
        <div class="page-slider-wrap">
          <input type="range" class="page-slider" id="pageSlider" min="1" max="56" value="1">
          <div class="page-bubble" id="pageBubble">Section</div>
        </div>
      </div>
      <button class="nav-btn" id="btnNext" onclick="nextPage()" title="Next Page">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"/></svg>
      </button>
    </div>
    <button class="toolbar-btn" id="backNavBtn" onclick="goBackNav()" title="Back" disabled>
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="#1565C0"/></g><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="#42A5F5"/></svg>
      <span class="btn-label">Back</span>
    </button>
    <button class="toolbar-btn" onclick="showTocView()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 20v2h14v-2h-2v-6.086l-.707.707L12 19.293l-4.293-4.293-.707-.707V20H5z" fill="#A93226"/><path d="M13 3.707l8 8 .707.707-1.414 1.414-.707-.707L12 5.121 4.414 12.707l-.707.707-1.414-1.414.707-.707 8-8 .707-.707.707.707z" fill="#A93226"/><path d="M4 20h16v-8h2l-10-9-10 9h2v8z" fill="#E74C3C"/><path d="M12 3L2 12h3v8h14v-8h3L12 3z" fill="#F1948A"/></svg>
      <span class="btn-label">Home</span>
    </button>
    <button class="toolbar-btn" onclick="openSearchNavInput()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#B7950B"/></g><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#F1C40F"/></svg>
      <span class="btn-label">Search</span>
    </button>
    <button class="toolbar-btn" onclick="openHandbookPage(1)">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1.5, 1.5)"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zM6.5 18c-1.65 0-3.35.3-4.75 1.05V7.5C3.1 6.75 5.05 6.5 6.5 6.5c1.95 0 4.05.4 5.5 1.5v11.5c-1.45-1.1-3.55-1.5-5.5-1.5z" fill="#117A65"/></g><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zM6.5 18c-1.65 0-3.35.3-4.75 1.05V7.5C3.1 6.75 5.05 6.5 6.5 6.5c1.95 0 4.05.4 5.5 1.5v11.5c-1.45-1.1-3.55-1.5-5.5-1.5z" fill="#2ECC71"/></svg>
      <span class="btn-label">Handbook</span>
    </button>
    <button class="toolbar-btn" onclick="openSupplementOverlay()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M2 12l2-3 4 1 2-3 5-1 4 3 1 2 2 7-6 1-3 3H8l-3-5-3-1v-4z" fill="#5B2C6F"/></g><path d="M2 12l2-3 4 1 2-3 5-1 4 3 1 2 2 7-6 1-3 3H8l-3-5-3-1v-4z" fill="#9B59B6"/></svg>
      <span class="btn-label">Supplements</span>
    </button>
    <button class="toolbar-btn" onclick="goToAcknowledgement()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M15.5 5.5L13 8 6 15l-1 3 3-1 7-7 2.5-2.5-2-2zm-2 2l1.5 1.5" fill="#C2185B"/><path d="M2 18c2.5-2 4.5-4 7.5-4 3.5 0 5.5 4 9.5 4" stroke="#C2185B" stroke-width="3" stroke-linecap="round"/></g><path d="M15.5 5.5L13 8 6 15l-1 3 3-1 7-7 2.5-2.5-2-2zm-2 2l1.5 1.5" fill="#E91E63"/><path d="M2 18c2.5-2 4.5-4 7.5-4 3.5 0 5.5 4 9.5 4" stroke="#E91E63" stroke-width="3" stroke-linecap="round"/></svg>
      <span class="btn-label">Sign</span>
    </button>
  </div>

  <script>
/* ═══════════════════════════════════════════════════════════
   TABLE OF CONTENTS DATA (from PDF bookmarks)
   ═══════════════════════════════════════════════════════════ */
const TOC = [
  { title: 'Welcome', page: 6, subs: [] },
  { title: 'Introduction', page: 7, subs: [
    { title: 'Important Notice About the ADV Teammate Handbook', page: 7 }
  ]},
  { title: 'Employment', page: 8, subs: [
    { title: 'At-Will Employment', page: 8 },
    { title: 'Voluntary Open Door Policy', page: 8 },
    { title: 'Equal Employment Opportunity', page: 9 },
    { title: 'Anti-harassment and Anti-discrimination', page: 10 },
    { title: 'Business Ethics and Conduct', page: 12 },
    { title: 'Immigration Law Compliance', page: 13 },
    { title: 'Disability and Accommodation', page: 13 },
    { title: 'Religious Accommodation', page: 13 },
    { title: 'Pregnancy Accommodation', page: 14 },
    { title: 'References / Verification of Employment', page: 14 },
    { title: 'Employment of Related Parties', page: 14 },
    { title: 'Company Property and Teammate Privacy', page: 15 },
    { title: 'Personal Information Protection Policy', page: 16 },
    { title: 'Access to Personnel Records', page: 17 },
    { title: 'Personal Data Changes', page: 18 },
    { title: 'Additional Privacy Policies', page: 18 }
  ]},
  { title: 'Employment Status and Practices', page: 18, subs: [
    { title: 'Employment Classifications', page: 18 },
    { title: 'Employment of a Minor', page: 19 },
    { title: 'Job Duties', page: 19 },
    { title: 'Teammate Benefits', page: 19 },
    { title: 'Background Check Policy', page: 20 },
    { title: 'Introductory Period', page: 20 },
    { title: 'Job Posting', page: 20 },
    { title: 'Transfer Policy', page: 21 },
    { title: 'Performance Reviews', page: 21 },
    { title: 'Separation of Employment', page: 21 },
    { title: 'Flex Schedule / Telework', page: 22 },
    { title: 'Life Assistance and Work/Life Support Program', page: 22 },
    { title: 'Outside Employment', page: 22 }
  ]},
  { title: 'Pay Practices', page: 23, subs: [
    { title: 'Timekeeping / Payroll', page: 23 },
    { title: 'Meal and Rest Periods', page: 24 },
    { title: 'Lactation Policy', page: 25 },
    { title: 'Paydays', page: 26 },
    { title: 'Payroll Corrections', page: 26 },
    { title: 'Payroll Deductions', page: 26 },
    { title: 'Discussion of Wages', page: 27 },
    { title: 'Overtime Compensation', page: 27 },
    { title: 'Work Schedules', page: 28 },
    { title: 'Business Travel and Reimbursement', page: 28 },
    { title: 'Bonuses and Awards', page: 28 }
  ]},
  { title: 'Time Away from Work', page: 29, subs: [
    { title: 'Company Holidays', page: 29 },
    { title: 'Floating Holidays', page: 29 },
    { title: 'Vacation', page: 30 },
    { title: 'Sick Time', page: 32 },
    { title: 'Family and Medical Leave of Absence', page: 33 },
    { title: 'Medical Leave of Absence', page: 36 },
    { title: 'Bereavement Leave', page: 37 },
    { title: 'Military Leave', page: 37 },
    { title: 'Jury Duty', page: 37 },
    { title: 'Witness Duty', page: 37 },
    { title: 'Parental Leave for School Visits', page: 38 },
    { title: 'Time Off to Vote', page: 38 },
    { title: 'State and Local Laws', page: 38 }
  ]},
  { title: 'Teammate Conduct and Working Conditions', page: 38, subs: [
    { title: 'Teammate Conduct and Work Rules Policy', page: 38 },
    { title: 'Drug and Alcohol Free Workplace Policy', page: 40 },
    { title: "Company's Right to Search", page: 42 },
    { title: 'Attendance and Punctuality', page: 42 },
    { title: 'Dress and Presentation', page: 43 },
    { title: 'Gifts, Meals, and Entertainment', page: 44 },
    { title: 'Outside Contacts', page: 45 },
    { title: 'Media Inquiries', page: 45 },
    { title: 'Client / Customer Assignment Policy', page: 45 },
    { title: 'Document Retention Policy', page: 46 },
    { title: 'Document Disposal Policy', page: 46 },
    { title: 'Social Media Policy', page: 46 }
  ]},
  { title: 'Safety and Security', page: 47, subs: [
    { title: 'Workplace Safety', page: 48 },
    { title: 'Workplace Violence Prevention', page: 48 },
    { title: 'Foodborne Illness for Teammates Handling Food', page: 49 },
    { title: 'Occupational Injury and Illness', page: 50 },
    { title: 'Solicitation / Distribution', page: 50 },
    { title: 'Parking', page: 51 },
    { title: 'Visitors in The Workplace', page: 51 },
    { title: 'Smoke-free Workplace', page: 51 },
    { title: 'Hazardous and Toxic Materials', page: 52 },
    { title: 'Inclement Weather / Office Closure', page: 52 },
    { title: 'Technology Policy', page: 52 },
    { title: 'Use of Mobile Phones and Devices While Driving', page: 54 },
    { title: 'Unauthorized Recordings', page: 54 },
    { title: 'Clean Workspace', page: 54 }
  ]},
  { title: 'Acknowledgement of Receipt', page: 55, subs: [] },
  { title: 'Key Resources', page: 56, subs: [] }
];

/* ═══════════════════════════════════════════════════════════
   STATE
   ═══════════════════════════════════════════════════════════ */
let pdfDoc = null;
let currentPage = 1;
let totalPages = 56;
let scale = 1.5;
let baseScale = 1.5;
let zoomFactor = 1.0;
let rendering = false;
let pageTextCache = {};
let touchStartX = 0;
let touchStartY = 0;
let touchStartTime = 0;
let handbookDoc = null;
let supplementDoc = null;
let currentDocType = 'handbook';
let currentSupplementState = '';
let handbookTextCache = {};
let supplementTextCache = {};
let handbookTextReady = false;
let supplementTextReady = false;
let tocSearchVisited = new Set();
const KEY_RESOURCES = [
  {
    title: 'Anonymous Reporting Hotline',
    lines: [
      { label: 'adv.ethicspoint.com', href: 'http://adv.ethicspoint.com' },
      { label: '(888) 325-7882', href: 'tel:8883257882' }
    ]
  },
  {
    title: 'HR Shared Services',
    lines: [
      { label: 'advantageprod.service-now.com/now/nav/ui/classic/params/target/esc', href: 'https://advantageprod.service-now.com/now/nav/ui/classic/params/target/esc' },
      { label: '(888) 900-4276', href: 'tel:8889004276' }
    ]
  },
  {
    title: 'Teammate Resources',
    lines: [
      { label: 'advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/AssociateResources.aspx', href: 'https://advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/AssociateResources.aspx' }
    ]
  },
  {
    title: 'Benefits',
    lines: [
      { label: 'www.advantagebenefits.net/', href: 'https://www.advantagebenefits.net/' }
    ]
  },
  {
    title: 'Company Intranet',
    lines: [
      { label: 'advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Welcome.aspx?wa=wsignin1.0', href: 'https://advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Welcome.aspx?wa=wsignin1.0' }
    ]
  },
  {
    title: 'Expense Management',
    lines: [
      { label: 'advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Travel%26Expenses.aspx?web=1', href: 'https://advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Travel%26Expenses.aspx?web=1' }
    ]
  },
  {
    title: 'Human Resources',
    lines: [
      { label: 'advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/HumanResources.aspx', href: 'https://advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/HumanResources.aspx' }
    ]
  },
  {
    title: 'Leave of Absence',
    lines: [
      { label: 'Online Portal: abilityadvantage.thehartford.com', href: 'https://abilityadvantage.thehartford.com' },
      { label: 'Dedicated Phone Line: 866-689-5707', href: 'tel:8666895707' }
    ]
  },
  {
    title: 'Legal Department',
    lines: [
      { label: 'advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Legal.aspx', href: 'https://advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Legal.aspx' }
    ]
  },
  {
    title: 'Military Leave',
    lines: [
      { label: 'www.advantagebenefits.net/', href: 'https://www.advantagebenefits.net/' },
      { label: 'Refer to Work/Life, Leave of Absence', textOnly: true }
    ]
  },
  {
    title: 'Payroll Services',
    lines: [
      { label: 'advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Payroll-Services.aspx', href: 'https://advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Payroll-Services.aspx' }
    ]
  },
  {
    title: 'Policies & Procedures',
    lines: [
      { label: 'advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Policies-&-Procedures.aspx?web=1', href: 'https://advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Policies-&-Procedures.aspx?web=1' }
    ]
  },
  {
    title: 'Safety & Workers’ Compensation',
    lines: [
      { label: 'advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Safety-WorkersCompensation.aspx', href: 'https://advantagesolutionsnet.sharepoint.com/sites/ConnectsHub/SitePages/Safety-WorkersCompensation.aspx' }
    ]
  },
  {
    title: 'State Supplements to the ADV Teammate Handbook',
    lines: [
      { label: 'advantagesolutionsnet.sharepoint.com/:b:/s/ConnectsHub/EbDZjA8iXNBPpLNA6TlK4hoBcASkyRqcleObFNuKmBx0hA?e=1SQd4k', href: 'https://advantagesolutionsnet.sharepoint.com/:b:/s/ConnectsHub/EbDZjA8iXNBPpLNA6TlK4hoBcASkyRqcleObFNuKmBx0hA?e=1SQd4k' }
    ]
  },
  {
    title: 'Workplace Accommodations',
    lines: [
      { label: 'www.advantagebenefits.net/', href: 'https://www.advantagebenefits.net/' },
      { label: 'Refer to Work/Life, Workplace Accommodations', textOnly: true }
    ]
  }
];

const HANDBOOK_URL = '2025_Teammate_Handbook.pdf';
const SUPPLEMENT_URL = 'State Supplement 2025.pdf';
const SUPPLEMENT_PAGE_OFFSET = 3;
const STATE_PAGES = {
  'Alaska': 2,
  'Arizona': 3,
  'California': 6,
  'Colorado': 53,
  'Connecticut': 69,
  'Delaware': 83,
  'District of Columbia': 85,
  'Illinois': 98,
  'Kentucky': 113,
  'Louisiana': 114,
  'Maine': 116,
  'Maryland': 120,
  'Massachusetts': 129,
  'Michigan': 141,
  'Minnesota': 146,
  'Missouri': 156,
  'Montana': 159,
  'Nevada': 160,
  'New Hampshire': 164,
  'New Jersey': 165,
  'New York': 186,
  'North Dakota': 209,
  'Oregon': 210,
  'Pennsylvania': 222,
  'Rhode Island': 230,
  'South Carolina': 237,
  'Tennessee': 238,
  'Vermont': 241,
  'Virginia': 247,
  'Washington': 248,
  'Wisconsin': 263
};
const STATE_LIST = Object.keys(STATE_PAGES);

/* ═══════════════════════════════════════════════════════════
   INIT
   ═══════════════════════════════════════════════════════════ */
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

async function init() {
  const bar = document.getElementById('loadingBar');
  const txt = document.getElementById('loadingText');

  try {
    txt.textContent = 'Loading handbook…';
    bar.style.width = '20%';

    const loadingTask = pdfjsLib.getDocument(HANDBOOK_URL);
    loadingTask.onProgress = (p) => {
      if (p.total > 0) {
        const pct = Math.min(90, Math.round((p.loaded / p.total) * 80) + 10);
        bar.style.width = pct + '%';
      }
    };

    handbookDoc = await loadingTask.promise;
    pdfDoc = handbookDoc;
    totalPages = pdfDoc.numPages;

    bar.style.width = '95%';
    txt.textContent = 'Preparing viewer…';

    document.getElementById('pageSlider').max = totalPages;
    buildTocLanding();
    buildTocOverlay();
    syncTocLogoWidth();

    // Compute base scale for good fit
    computeBaseScale();

    bar.style.width = '100%';

    setTimeout(() => {
      document.getElementById('loadingScreen').classList.add('hidden');
      handleHash();
    }, 300);

    initSearchNavDrag();

    // Start background text extraction for search
    extractAllText();

  } catch (err) {
    txt.textContent = 'Error loading PDF. Please refresh.';
    console.error(err);
  }
}

function showLoading(message) {
  const screen = document.getElementById('loadingScreen');
  const txt = document.getElementById('loadingText');
  const bar = document.getElementById('loadingBar');
  txt.textContent = message || 'Loading…';
  bar.style.width = '60%';
  screen.classList.remove('hidden');
}

function hideLoading() {
  document.getElementById('loadingScreen').classList.add('hidden');
}

async function ensureSupplementDoc() {
  if (supplementDoc) return supplementDoc;
  showLoading('Loading state supplements…');
  const task = pdfjsLib.getDocument(SUPPLEMENT_URL);
  supplementDoc = await task.promise;
  hideLoading();
  return supplementDoc;
}

async function ensureHandbookText() {
  if (handbookTextReady || !handbookDoc) return;
  handbookTextCache = {};
  const pages = handbookDoc.numPages;
  for (let i = 1; i <= pages; i++) {
    try {
      const page = await handbookDoc.getPage(i);
      const content = await page.getTextContent();
      handbookTextCache[i] = content.items.map(item => item.str).join(' ');
    } catch (e) {
      handbookTextCache[i] = '';
    }
  }
  handbookTextReady = true;
}

async function ensureSupplementText() {
  if (supplementTextReady) return;
  await ensureSupplementDoc();
  supplementTextCache = {};
  const pages = supplementDoc.numPages;
  for (let i = 1; i <= pages; i++) {
    try {
      const page = await supplementDoc.getPage(i);
      const content = await page.getTextContent();
      supplementTextCache[i] = content.items.map(item => item.str).join(' ');
    } catch (e) {
      supplementTextCache[i] = '';
    }
  }
  supplementTextReady = true;
}

function computeBaseScale() {
  const area = document.getElementById('canvasArea');
  const isMobile = window.innerWidth <= 640;
  const padding = isMobile ? 8 : 32;
  const areaW = area.clientWidth - padding;
  const areaH = area.clientHeight - padding;
  // Estimate based on letter size (612 x 792 pt)
  const fitW = areaW / 612;
  const fitH = areaH / 792;
  // On mobile: prioritize width-fit so text is readable
  if (isMobile) {
    baseScale = fitW;
  } else {
    baseScale = Math.min(fitW, fitH, 2.0);
  }
  baseScale = Math.max(baseScale, 0.5);
  scale = baseScale * zoomFactor;
}

function syncTocLogoWidth() {
  const title = document.querySelector('.toc-title');
  const logo = document.querySelector('.toc-logo');
  if (!title || !logo) return;
  const width = Math.ceil(title.getBoundingClientRect().width);
  if (width > 0) {
    logo.style.width = `${width}px`;
  }
}

/* ═══════════════════════════════════════════════════════════
   BUILD TOC LANDING
   ═══════════════════════════════════════════════════════════ */
function buildTocLanding() {
  const container = document.getElementById('tocSections');
  let html = '';
  TOC.forEach((section, i) => {
    const hasSubs = section.subs.length > 0;
    html += `<div class="toc-group fade-in stagger-${(i % 4) + 1}" data-search="${section.title.toLowerCase()} ${section.subs.map(s=>s.title.toLowerCase()).join(' ')}">`;
    html += `<div class="toc-group-header" onclick="${hasSubs ? `toggleTocGroup(this.parentElement)` : `openHandbookPage(${section.page})`}">`;
    html += `<span class="section-number">${section.page}</span>`;
    html += `<span class="section-title">${section.title}</span>`;
    html += `<span class="section-page">p. ${section.page}</span>`;
    if (hasSubs) {
      html += `<svg class="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"/></svg>`;
    }
    html += `</div>`;
    if (hasSubs) {
      html += `<div class="toc-subitems">`;
      section.subs.forEach(sub => {
        html += `<div class="toc-subitem" onclick="openHandbookPage(${sub.page})">`;
        html += `<span class="sub-title">${sub.title}</span>`;
        html += `<span class="sub-page">${sub.page}</span>`;
        html += `</div>`;
      });
      html += `</div>`;
    }
    html += `</div>`;
  });
  const supplementIndex = (TOC.length % 4) + 1;
  html += `<div class="toc-group fade-in stagger-${supplementIndex}" data-search="state supplements ${STATE_LIST.map(s=>s.toLowerCase()).join(' ')}">`;
  html += `<div class="toc-group-header" onclick="toggleTocGroup(this.parentElement)">`;
  html += `<span class="section-number">SS</span>`;
  html += `<span class="section-title">State Supplements</span>`;
  html += `<span class="section-page">2025</span>`;
  html += `<svg class="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"/></svg>`;
  html += `</div>`;
  html += `<div class="toc-subitems">`;
  STATE_LIST.forEach(state => {
    const page = STATE_PAGES[state];
    html += `<div class="toc-subitem" onclick="openSupplementState('${state.replace(/'/g, "\\'")}')">`;
    html += `<span class="sub-title">${state} Supplement</span>`;
    html += `<span class="sub-page">${page}</span>`;
    html += `</div>`;
  });
  html += `</div></div>`;
  container.innerHTML = html;
}

function toggleTocGroup(el) {
  el.classList.toggle('open');
}

/* ═══════════════════════════════════════════════════════════
   BUILD TOC OVERLAY (reader sidebar)
   ═══════════════════════════════════════════════════════════ */
function buildTocOverlay() {
  const body = document.getElementById('tocOverlayBody');
  let html = '';
  TOC.forEach(section => {
    html += `<div class="toc-ol-group">`;
    html += `<div class="toc-ol-section" data-page="${section.page}" onclick="openHandbookPage(${section.page}); closeTocOverlay();">`;
    html += `<span class="ol-dot"></span>`;
    html += `<span class="ol-title">${section.title}</span>`;
    html += `<span class="ol-page">${section.page}</span>`;
    html += `</div>`;
    section.subs.forEach(sub => {
      html += `<div class="toc-ol-sub" data-page="${sub.page}" onclick="openHandbookPage(${sub.page}); closeTocOverlay();">`;
      html += `<span class="ol-title">${sub.title}</span>`;
      html += `<span class="ol-page">${sub.page}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  });
  html += `<div class="toc-ol-group">`;
  html += `<div class="toc-ol-section" onclick="openSupplementOverlay()">`;
  html += `<span class="ol-dot"></span>`;
  html += `<span class="ol-title">State Supplements</span>`;
  html += `<span class="ol-page">2025</span>`;
  html += `</div>`;
  STATE_LIST.forEach(state => {
    html += `<div class="toc-ol-sub" onclick="openSupplementState('${state.replace(/'/g, "\\'")}')">`;
    html += `<span class="ol-title">${state} Supplement</span>`;
    html += `<span class="ol-page">${STATE_PAGES[state]}</span>`;
    html += `</div>`;
  });
  html += `</div>`;
  body.innerHTML = html;
}

function highlightTocOverlay() {
  document.querySelectorAll('#tocOverlayBody [data-page]').forEach(el => {
    el.classList.remove('current');
  });
  if (currentDocType !== 'handbook') return;
  // Find the current section
  let currentSection = null;
  for (let i = TOC.length - 1; i >= 0; i--) {
    if (currentPage >= TOC[i].page) { currentSection = TOC[i]; break; }
  }
  if (currentSection) {
    document.querySelectorAll(`#tocOverlayBody [data-page="${currentSection.page}"]`).forEach(el => {
      if (el.classList.contains('toc-ol-section')) el.classList.add('current');
    });
  }
  // Highlight sub
  let currentSub = null;
  for (const section of TOC) {
    for (let i = section.subs.length - 1; i >= 0; i--) {
      if (currentPage >= section.subs[i].page) { currentSub = section.subs[i]; break; }
    }
    if (currentSub) break;
  }
}

/* ═══════════════════════════════════════════════════════════
   NAVIGATION
   ═══════════════════════════════════════════════════════════ */
let navHistory = [];
let isRestoringNavState = false;

function getNavState() {
  return {
    view: document.getElementById('readerView').classList.contains('hidden') ? 'toc' : 'reader',
    docType: currentDocType,
    page: currentPage,
    supplementState: currentSupplementState,
    overlays: {
      toc: document.getElementById('tocOverlay').classList.contains('show'),
      search: document.getElementById('searchOverlay').classList.contains('show'),
      supplement: document.getElementById('supplementOverlay').classList.contains('show'),
      tools: document.getElementById('sectionToolsPop').classList.contains('show'),
      appMenu: document.getElementById('appMenuPanel').classList.contains('show')
    }
  };
}

function updateBackButton() {
  const btn = document.getElementById('backNavBtn');
  if (!btn) return;
  btn.disabled = navHistory.length === 0;
}

function pushNavState() {
  if (isRestoringNavState) return;
  navHistory.push(getNavState());
  if (navHistory.length > 20) navHistory.shift();
  updateBackButton();
}

function restoreOverlays(overlays) {
  if (!overlays) return;
  const backdrop = document.getElementById('overlayBackdrop');
  const tocOverlay = document.getElementById('tocOverlay');
  const searchOverlay = document.getElementById('searchOverlay');
  const supplementOverlay = document.getElementById('supplementOverlay');
  const toolsPop = document.getElementById('sectionToolsPop');
  const toolsToggle = document.getElementById('toolsToggle');
  const appMenuBackdrop = document.getElementById('appMenuBackdrop');
  const appMenuPanel = document.getElementById('appMenuPanel');
  const appMenuButton = document.getElementById('appMenuButton');

  if (overlays.toc) {
    tocOverlay.classList.add('show');
    backdrop.classList.add('show');
    document.getElementById('tocToggle').classList.add('active');
    highlightTocOverlay();
  }
  if (overlays.search) {
    searchOverlay.classList.add('show');
    backdrop.classList.add('show');
    document.getElementById('searchToggle').classList.add('active');
  }
  if (overlays.supplement) {
    supplementOverlay.classList.add('show');
  }
  if (overlays.tools) {
    const isMobile = window.innerWidth <= 640;
    if (!isMobile) {
      const rect = toolsToggle.getBoundingClientRect();
      toolsPop.style.top = (rect.bottom + 6) + 'px';
      toolsPop.style.right = (window.innerWidth - rect.right) + 'px';
    }
    toolsPop.classList.add('show');
    toolsToggle.classList.add('active');
    if (isMobile) backdrop.classList.add('show');
  }
  if (overlays.appMenu) {
    appMenuBackdrop.classList.add('show');
    appMenuPanel.classList.add('show');
    appMenuButton.classList.add('active');
  }
}

async function goBackNav() {
  if (!navHistory.length) return;
  const state = navHistory.pop();
  updateBackButton();
  isRestoringNavState = true;
  closeAllOverlays();

  if (state.view === 'toc') {
    document.getElementById('tocView').classList.remove('hidden');
    document.getElementById('readerView').classList.add('hidden');
    document.body.classList.remove('reader-active');
    clearSearchNavigation();
    window.location.hash = '';
  } else {
    if (state.docType !== currentDocType) {
      await switchDocument(state.docType);
    }
    currentSupplementState = state.supplementState || '';
    goToPage(state.page, state.supplementState || currentSupplementState);
  }

  restoreOverlays(state.overlays);
  isRestoringNavState = false;
}

function showTocView() {
  if (!document.getElementById('readerView').classList.contains('hidden')) {
    pushNavState();
  }
  document.getElementById('tocView').classList.remove('hidden');
  document.getElementById('readerView').classList.add('hidden');
  document.body.classList.remove('reader-active');
  closeAllOverlays();
  clearSearchNavigation();
  window.location.hash = '';
  highlightBottomNav();
}

function focusHomeSearch() {
  showTocView();
  const input = document.getElementById('tocSearchInput');
  if (!input) return;
  input.scrollIntoView({ behavior: 'smooth', block: 'center' });
  setTimeout(() => input.focus(), 150);
}

function showReaderView() {
  document.getElementById('tocView').classList.add('hidden');
  document.getElementById('readerView').classList.remove('hidden');
  document.body.classList.add('reader-active');
  highlightBottomNav();
}

function goToAcknowledgement() {
  const inReader = !document.getElementById('readerView').classList.contains('hidden');
  const lastPage = inReader ? currentPage : 1;
  localStorage.setItem('handbookLastPage', String(lastPage));
  localStorage.setItem('handbookLastView', inReader ? 'reader' : 'toc');
  window.location.href = 'acknowledgement.html';
}

async function switchDocument(type, targetPage) {
  if (type === currentDocType) return;
  if (type === 'supplement') {
    await ensureSupplementDoc();
    pdfDoc = supplementDoc;
    currentDocType = 'supplement';
  } else {
    pdfDoc = handbookDoc;
    currentDocType = 'handbook';
  }
  totalPages = pdfDoc.numPages;
  document.getElementById('pageSlider').max = totalPages;
  computeBaseScale();
  if (typeof targetPage === 'number') {
    currentPage = Math.max(1, Math.min(targetPage, totalPages));
    rendering = false;
    renderPage(currentPage);
    updateUI();
  }
}

async function openHandbookPage(page) {
  pushNavState();
  currentSupplementState = '';
  await switchDocument('handbook', page);
  goToPage(page);
}

function buildHash(page, state) {
  const params = new URLSearchParams();
  params.set('page', page);
  params.set('pdf', currentDocType);
  if (currentDocType === 'supplement' && state) params.set('state', state);
  return params.toString();
}

function goToPage(num, state) {
  num = Math.max(1, Math.min(num, totalPages));
  currentPage = num;
  showReaderView();
  renderPage(num);
  updateUI();
  window.location.hash = buildHash(num, state || currentSupplementState);
}

async function openSupplementState(state) {
  pushNavState();
  currentSupplementState = state;
  const targetPage = (STATE_PAGES[state] || 1) + SUPPLEMENT_PAGE_OFFSET;
  await switchDocument('supplement', targetPage);
  closeSupplementOverlay();
  closeTocOverlay();
  goToPage(targetPage, state);
}

async function openSupplementPage(page) {
  pushNavState();
  currentSupplementState = '';
  await switchDocument('supplement', page);
  closeSupplementOverlay();
  closeTocOverlay();
  goToPage(page);
}

function nextPage() {
  if (currentPage < totalPages) goToPage(currentPage + 1);
}

function prevPage() {
  if (currentPage > 1) goToPage(currentPage - 1);
}

function handleHash() {
  const hash = window.location.hash.substring(1);
  if (!hash) {
    document.getElementById('tocView').classList.remove('hidden');
    return;
  }
  const params = new URLSearchParams(hash);
  if (hash.toLowerCase() === 'supplements' || params.has('supplements')) {
    document.getElementById('tocView').classList.remove('hidden');
    openSupplementOverlay();
    return;
  }
  if (hash.toLowerCase() === 'search' || params.has('search')) {
    const query = params.get('q') || '';
    switchDocument('handbook').then(() => {
      showReaderView();
      if (query) openSearchWithQuery(query);
      else toggleSearch();
    });
    return;
  }
  if (params.has('page')) {
    const page = parseInt(params.get('page')) || 1;
    const pdfType = params.get('pdf') || 'handbook';
    if (pdfType === 'supplement') {
      const state = params.get('state') || '';
      currentSupplementState = state;
      switchDocument('supplement').then(() => goToPage(page, state));
    } else {
      switchDocument('handbook').then(() => goToPage(page));
    }
  } else if (params.has('section')) {
    const sname = params.get('section').toLowerCase();
    for (const s of TOC) {
      if (s.title.toLowerCase().includes(sname)) { openHandbookPage(s.page); return; }
      for (const sub of s.subs) {
        if (sub.title.toLowerCase().includes(sname)) { openHandbookPage(sub.page); return; }
      }
    }
    openHandbookPage(1);
  } else {
    document.getElementById('tocView').classList.remove('hidden');
  }
  highlightBottomNav();
}

window.addEventListener('hashchange', handleHash);

function updateUI() {
  document.getElementById('pageSlider').value = currentPage;
  document.getElementById('btnPrev').disabled = currentPage <= 1;
  document.getElementById('btnNext').disabled = currentPage >= totalPages;
  highlightTocOverlay();
  highlightBottomNav();
}

function highlightBottomNav() {
  const bottomNav = document.querySelector('.home-bottom-nav');
  if (!bottomNav) return;
  
  // Remove active class from all buttons
  bottomNav.querySelectorAll('.toolbar-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  const tocView = document.getElementById('tocView');
  const readerView = document.getElementById('readerView');
  const searchOverlay = document.getElementById('searchOverlay');
  const supplementOverlay = document.getElementById('supplementOverlay');
  const searchNavOverlay = document.getElementById('searchNavOverlay');
  
  const isTocVisible = tocView && !tocView.classList.contains('hidden');
  const isReaderVisible = readerView && !readerView.classList.contains('hidden');
  const isSearchOpen = searchOverlay && searchOverlay.classList.contains('show');
  const isSearchNavOpen = searchNavOverlay && searchNavOverlay.classList.contains('show');
  const isSupplementOpen = supplementOverlay && supplementOverlay.classList.contains('show');
  
  // Find and highlight the appropriate button
  bottomNav.querySelectorAll('.toolbar-btn').forEach(btn => {
    const onclickAttr = btn.getAttribute('onclick');
    if (!onclickAttr) return;
    
    // Home button - when TOC view is visible and no overlays are open
    if (onclickAttr.includes('showTocView') && isTocVisible && !isSearchOpen && !isSupplementOpen && !isSearchNavOpen) {
      btn.classList.add('active');
    }
    // Search button - when search overlay or search nav is open
    else if ((onclickAttr.includes('openSearchNavInput') || onclickAttr.includes('toggleSearch')) && (isSearchOpen || isSearchNavOpen)) {
      btn.classList.add('active');
    }
    // Handbook button - when reader view is visible
    else if (onclickAttr.includes('openHandbookPage') && isReaderVisible && !isSearchOpen && !isSupplementOpen) {
      btn.classList.add('active');
    }
    // Supplements button - when supplement overlay is open
    else if (onclickAttr.includes('openSupplementOverlay') && isSupplementOpen) {
      btn.classList.add('active');
    }
  });
}

/* ═══════════════════════════════════════════════════════════
   PAGE RENDERING
   ═══════════════════════════════════════════════════════════ */
async function renderTextLayerForPage(page, viewport) {
  const layer = document.getElementById('textLayer');
  if (!layer) return;
  const requestId = ++textLayerRequestId;
  const textContent = await page.getTextContent();
  if (requestId !== textLayerRequestId) return;
  layer.innerHTML = '';
  layer.style.width = `${viewport.width}px`;
  layer.style.height = `${viewport.height}px`;
  positionTextLayer();
  const textDivs = [];
  const task = pdfjsLib.renderTextLayer({
    textContent,
    container: layer,
    viewport,
    textDivs,
    enhanceTextSelection: false
  });
  if (task?.promise) {
    await task.promise;
  } else {
    await task;
  }
  if (requestId !== textLayerRequestId) return;
  currentTextItems = textContent.items || [];
  currentTextDivs = textDivs;
  resetTextLayerHighlights();
}

async function renderPage(num) {
  if (rendering) return;
  rendering = true;

  try {
    const page = await pdfDoc.getPage(num);
    const viewport = page.getViewport({ scale: scale });
    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');

    const dpr = window.devicePixelRatio || 1;
    canvas.width = viewport.width * dpr;
    canvas.height = viewport.height * dpr;
    canvas.style.width = viewport.width + 'px';
    canvas.style.height = viewport.height + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
    await renderTextLayerForPage(page, viewport);

    // Scroll canvas area to top
    document.getElementById('canvasArea').scrollTop = 0;
    updateResourcesOverlay();
    await applySearchHighlight();
  } catch (err) {
    console.error('Render error:', err);
  }

  rendering = false;
}

/* ═══════════════════════════════════════════════════════════
   ZOOM
   ═══════════════════════════════════════════════════════════ */
function zoomIn() {
  zoomFactor = Math.min(zoomFactor + 0.25, 3.0);
  scale = baseScale * zoomFactor;
  document.getElementById('zoomLevel').textContent = Math.round(zoomFactor * 100) + '%';
  renderPage(currentPage);
}

function zoomOut() {
  zoomFactor = Math.max(zoomFactor - 0.25, 0.5);
  scale = baseScale * zoomFactor;
  document.getElementById('zoomLevel').textContent = Math.round(zoomFactor * 100) + '%';
  renderPage(currentPage);
}

/* ═══════════════════════════════════════════════════════════
   SWIPE / TOUCH / PINCH / DOUBLE-TAP
   ═══════════════════════════════════════════════════════════ */
const canvasArea = document.getElementById('canvasArea');
let lastTapTime = 0;
let pinchStartDist = 0;
let pinchStartZoom = 1;
let isSwiping = false;
window.addEventListener('resize', positionSearchOverlays);
canvasArea.addEventListener('scroll', positionSearchOverlays);

function getTouchDist(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

canvasArea.addEventListener('touchstart', (e) => {
  // Pinch-to-zoom start
  if (e.touches.length === 2) {
    e.preventDefault();
    pinchStartDist = getTouchDist(e.touches);
    pinchStartZoom = zoomFactor;
    return;
  }
  if (e.touches.length !== 1) return;

  // Double-tap detection
  const now = Date.now();
  if (now - lastTapTime < 300) {
    e.preventDefault();
    handleDoubleTap();
    lastTapTime = 0;
    return;
  }
  lastTapTime = now;

  // Single touch — swipe start
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
  touchStartTime = now;
  isSwiping = false;
}, { passive: false });

canvasArea.addEventListener('touchmove', (e) => {
  // Pinch-to-zoom move
  if (e.touches.length === 2) {
    e.preventDefault();
    const dist = getTouchDist(e.touches);
    const ratio = dist / pinchStartDist;
    const newZoom = Math.min(3.0, Math.max(0.5, pinchStartZoom * ratio));
    if (Math.abs(newZoom - zoomFactor) > 0.02) {
      zoomFactor = newZoom;
      scale = baseScale * zoomFactor;
      document.getElementById('zoomLevel').textContent = Math.round(zoomFactor * 100) + '%';
      renderPage(currentPage);
    }
    return;
  }

  // Track horizontal movement for swipe
  if (e.touches.length === 1) {
    const dx = Math.abs(e.touches[0].clientX - touchStartX);
    const dy = Math.abs(e.touches[0].clientY - touchStartY);
    if (dx > 15 && dx > dy * 1.2) {
      isSwiping = true;
    }
  }
}, { passive: false });

canvasArea.addEventListener('touchend', (e) => {
  if (e.changedTouches.length !== 1) return;
  const dx = e.changedTouches[0].clientX - touchStartX;
  const dy = e.changedTouches[0].clientY - touchStartY;
  const dt = Date.now() - touchStartTime;

  // Swipe detection: primarily horizontal, fast enough, > 40px
  if (dt < 500 && Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy) * 1.3) {
    if (dx < 0) nextPage();
    else prevPage();
  }
}, { passive: true });

function handleDoubleTap() {
  if (zoomFactor > 1.1) {
    // Zoomed in → reset to fit
    zoomFactor = 1.0;
  } else {
    // Fit → zoom to 175%
    zoomFactor = 1.75;
  }
  scale = baseScale * zoomFactor;
  document.getElementById('zoomLevel').textContent = Math.round(zoomFactor * 100) + '%';
  renderPage(currentPage);
  showToast(zoomFactor > 1.1 ? `Zoomed to ${Math.round(zoomFactor * 100)}%` : 'Fit to width');
}

/* Keyboard navigation */
document.addEventListener('keydown', (e) => {
  if (document.getElementById('readerView').classList.contains('hidden')) return;
  if (e.target.tagName === 'INPUT') return;

  switch(e.key) {
    case 'ArrowLeft': prevPage(); e.preventDefault(); break;
    case 'ArrowRight': nextPage(); e.preventDefault(); break;
    case 'Home': goToPage(1); e.preventDefault(); break;
    case 'End': goToPage(totalPages); e.preventDefault(); break;
    case '+': case '=': zoomIn(); e.preventDefault(); break;
    case '-': zoomOut(); e.preventDefault(); break;
    case 'Escape': closeAllOverlays(); break;
    case 'f':
      if (e.ctrlKey || e.metaKey) { e.preventDefault(); toggleSearch(); }
      break;
  }
});

/* Page slider */
const pageSlider = document.getElementById('pageSlider');
const pageBubble = document.getElementById('pageBubble');

function updatePageBubble(value) {
  const percent = (value - pageSlider.min) / (pageSlider.max - pageSlider.min);
  const sliderWidth = pageSlider.offsetWidth;
  const thumbOffset = 10;
  const x = percent * (sliderWidth - thumbOffset * 2) + thumbOffset;
  pageBubble.style.left = `${x}px`;
  const label = currentDocType === 'supplement'
    ? getSupplementStateLabel(value)
    : getHandbookSectionLabel(value);
  pageBubble.textContent = label;
}

function getHandbookSectionLabel(page) {
  let sectionTitle = 'Handbook';
  let subTitle = '';
  for (const section of TOC) {
    if (page >= section.page) {
      sectionTitle = section.title;
      subTitle = '';
      for (const sub of section.subs) {
        if (page >= sub.page) subTitle = sub.title;
      }
    }
  }
  return subTitle || sectionTitle;
}

function getSupplementStateLabel(page) {
  const entries = Object.entries(STATE_PAGES)
    .map(([state, start]) => ({ state, start: start + SUPPLEMENT_PAGE_OFFSET }))
    .sort((a, b) => a.start - b.start);
  let stateLabel = currentSupplementState || 'State Supplement';
  for (let i = 0; i < entries.length; i++) {
    const curr = entries[i];
    const next = entries[i + 1];
    if (page >= curr.start && (!next || page < next.start)) {
      stateLabel = curr.state;
      break;
    }
  }
  return `${stateLabel} Supplement`;
}

function getSupplementStateName(page) {
  const entries = Object.entries(STATE_PAGES)
    .map(([state, start]) => ({ state, start: start + SUPPLEMENT_PAGE_OFFSET }))
    .sort((a, b) => a.start - b.start);
  let stateLabel = currentSupplementState || 'State Supplement';
  for (let i = 0; i < entries.length; i++) {
    const curr = entries[i];
    const next = entries[i + 1];
    if (page >= curr.start && (!next || page < next.start)) {
      stateLabel = curr.state;
      break;
    }
  }
  return stateLabel;
}

pageSlider.addEventListener('input', (e) => {
  const value = parseInt(e.target.value, 10);
  updatePageBubble(value);
  goToPage(value);
});

['mousedown', 'touchstart'].forEach(evt => {
  pageSlider.addEventListener(evt, () => {
    updatePageBubble(parseInt(pageSlider.value, 10));
    pageBubble.classList.add('show');
  });
});
['mouseup', 'touchend', 'touchcancel', 'mouseleave'].forEach(evt => {
  pageSlider.addEventListener(evt, () => pageBubble.classList.remove('show'));
});

/* ═══════════════════════════════════════════════════════════
   TEXT EXTRACTION (for search)
   ═══════════════════════════════════════════════════════════ */
async function extractAllText() {
  await ensureHandbookText();
  pageTextCache = handbookTextCache;
}

/* ═══════════════════════════════════════════════════════════
   SEARCH
   ═══════════════════════════════════════════════════════════ */
let searchTimeout = null;
let lastReaderSearchResults = [];
let lastTocSearchResults = [];
let activeSearchResults = [];
let activeSearchIndex = -1;
let highlightRequestId = 0;
let searchNavDrag = { active: false, offsetX: 0, offsetY: 0 };
let searchNavManual = false;

function getQueryPreview(query) {
  const clean = (query || '').trim();
  if (!clean) return 'Search';
  const preview = clean.length > 10 ? `${clean.slice(0, 10)}…` : clean;
  return `Search: ${preview}`;
}

function normalizeSearchString(text) {
  return (text || '')
    .replace(/[\u00ad\u200b\u200c\u200d]/g, '')
    .replace(/[\u2010-\u2014]/g, '-')
    .replace(/\u00a0/g, ' ')
    .toLowerCase();
}

function buildNormalizedIndex(text) {
  const map = [];
  let normalized = '';
  for (let i = 0; i < text.length; i++) {
    let ch = text[i];
    if (ch === '\u00ad' || ch === '\u200b' || ch === '\u200c' || ch === '\u200d') continue;
    if (ch === '\u00a0') ch = ' ';
    if (ch >= '\u2010' && ch <= '\u2014') ch = '-';
    normalized += ch.toLowerCase();
    map.push(i);
  }
  return { normalized, map };
}

function findMatchRanges(text, query) {
  const ranges = [];
  if (!text || !query) return ranges;
  const normQuery = normalizeSearchString(query);
  if (!normQuery) return ranges;
  const { normalized, map } = buildNormalizedIndex(text);
  let start = 0;
  while (start < normalized.length) {
    const idx = normalized.indexOf(normQuery, start);
    if (idx === -1) break;
    const startIdx = map[idx];
    const endMapIndex = idx + normQuery.length - 1;
    const endIdx = map[endMapIndex] != null ? map[endMapIndex] + 1 : startIdx + 1;
    ranges.push({ start: startIdx, end: endIdx });
    start = idx + normQuery.length;
  }
  return ranges;
}

function getSearchTokens(query) {
  const raw = (query || '').trim();
  if (!raw) return [];
  const tokens = raw.split(/\s+/).filter(Boolean);
  const unique = new Set([raw, ...tokens]);
  return Array.from(unique).sort((a, b) => b.length - a.length);
}

function mergeRanges(ranges) {
  if (!ranges.length) return [];
  const sorted = ranges.slice().sort((a, b) => a.start - b.start);
  const merged = [sorted[0]];
  for (let i = 1; i < sorted.length; i++) {
    const curr = sorted[i];
    const prev = merged[merged.length - 1];
    if (curr.start <= prev.end) {
      prev.end = Math.max(prev.end, curr.end);
    } else {
      merged.push({ start: curr.start, end: curr.end });
    }
  }
  return merged;
}

let textLayerRequestId = 0;
let currentTextItems = [];
let currentTextDivs = [];

function escapeHtml(text) {
  return (text || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function positionTextLayer() {
  const layer = document.getElementById('textLayer');
  const canvas = document.getElementById('pdfCanvas');
  if (!layer || !canvas) return;
  layer.style.left = canvas.offsetLeft + 'px';
  layer.style.top = canvas.offsetTop + 'px';
  layer.style.width = canvas.offsetWidth + 'px';
  layer.style.height = canvas.offsetHeight + 'px';
}

function resetTextLayerHighlights() {
  if (!currentTextDivs.length || !currentTextItems.length) return;
  for (let i = 0; i < currentTextDivs.length; i++) {
    const div = currentTextDivs[i];
    if (!div) continue;
    div.textContent = currentTextItems[i]?.str || '';
  }
}

function clearSearchHighlights() {
  const layer = document.getElementById('searchHighlightLayer');
  if (layer) {
    layer.innerHTML = '';
    layer.style.display = 'none';
  }
  resetTextLayerHighlights();
}

function normalizeSearchChar(ch) {
  if (!ch) return '';
  if (ch === '\u00ad' || ch === '\u200b' || ch === '\u200c' || ch === '\u200d') return '';
  if (ch === '\u00a0') return '';
  if (/\s/.test(ch)) return '';
  if (ch >= '\u2010' && ch <= '\u2014') return '-';
  return ch.toLowerCase();
}

function normalizeQueryForIndex(query) {
  let normalized = '';
  for (let i = 0; i < query.length; i++) {
    const n = normalizeSearchChar(query[i]);
    if (n) normalized += n;
  }
  return normalized;
}

function buildNormalizedIndexForItems(items) {
  const map = [];
  let normalized = '';
  for (let itemIndex = 0; itemIndex < items.length; itemIndex++) {
    const text = items[itemIndex]?.str || '';
    for (let charIndex = 0; charIndex < text.length; charIndex++) {
      const n = normalizeSearchChar(text[charIndex]);
      if (!n) continue;
      normalized += n;
      map.push({ itemIndex, charIndex });
    }
  }
  return { normalized, map };
}

function buildHighlightRangesByItem(items, query) {
  const rangesByItem = new Map();
  const normalizedQuery = normalizeQueryForIndex(query || '');
  if (!normalizedQuery) return rangesByItem;
  const { normalized, map } = buildNormalizedIndexForItems(items);
  let start = 0;
  while (start < normalized.length) {
    const idx = normalized.indexOf(normalizedQuery, start);
    if (idx === -1) break;
    const endIdx = idx + normalizedQuery.length;
    for (let i = idx; i < endIdx; i++) {
      const entry = map[i];
      if (!entry) continue;
      const { itemIndex, charIndex } = entry;
      const ranges = rangesByItem.get(itemIndex) || [];
      const last = ranges[ranges.length - 1];
      if (last && charIndex === last.end) {
        last.end += 1;
      } else {
        ranges.push({ start: charIndex, end: charIndex + 1 });
      }
      rangesByItem.set(itemIndex, ranges);
    }
    start = endIdx;
  }
  return rangesByItem;
}

function applyRangesToText(text, ranges) {
  if (!ranges || !ranges.length) return escapeHtml(text);
  let html = '';
  let lastIndex = 0;
  ranges.forEach(range => {
    const start = Math.max(0, Math.min(range.start, text.length));
    const end = Math.max(start, Math.min(range.end, text.length));
    html += escapeHtml(text.slice(lastIndex, start));
    html += `<span class="search-text-hit">${escapeHtml(text.slice(start, end))}</span>`;
    lastIndex = end;
  });
  html += escapeHtml(text.slice(lastIndex));
  return html;
}

function getSearchResultSection(result) {
  if (!result) return '';
  return result.docType === 'supplement'
    ? getSupplementStateLabel(result.page)
    : getHandbookSectionLabel(result.page);
}

function getSearchResultMeta(result, index, total) {
  if (!result) return { meta: '', section: '' };
  const label = result.docType === 'supplement' ? getSupplementStateLabel(result.page) : 'Handbook';
  const displayPage = result.docType === 'supplement'
    ? Math.max(1, result.page - SUPPLEMENT_PAGE_OFFSET)
    : result.page;
  const meta = `Result ${index + 1} of ${total} · ${label} · Page ${displayPage}`;
  const section = getSearchResultSection(result);
  return { meta, section };
}

function updateSearchNavOverlay() {
  const overlay = document.getElementById('searchNavOverlay');
  const meta = document.getElementById('searchNavMeta');
  const section = document.getElementById('searchNavSection');
  const prevBtn = document.getElementById('searchNavPrev');
  const nextBtn = document.getElementById('searchNavNext');
  const queryInput = document.getElementById('searchNavInput');
  if (!overlay || !meta || !section || !prevBtn || !nextBtn) return;
  const hasResults = activeSearchResults.length > 0 && activeSearchIndex >= 0;
  if (!hasResults && !searchNavManual) {
    overlay.classList.remove('show');
    return;
  }
  if (hasResults) {
    const result = activeSearchResults[activeSearchIndex];
    const labels = getSearchResultMeta(result, activeSearchIndex, activeSearchResults.length);
    meta.textContent = labels.meta;
    section.textContent = labels.section || 'Search results';
    if (queryInput && document.activeElement !== queryInput) {
      queryInput.value = result.query || '';
    }
    prevBtn.disabled = activeSearchIndex <= 0;
    nextBtn.disabled = activeSearchIndex >= activeSearchResults.length - 1;
  } else {
    meta.textContent = 'Type a search term';
    section.textContent = 'Search';
    prevBtn.disabled = true;
    nextBtn.disabled = true;
  }
  overlay.classList.add('show');
  positionSearchNavOverlay();
}

function positionSearchNavOverlay() {
  const overlay = document.getElementById('searchNavOverlay');
  if (!overlay || !overlay.classList.contains('show')) return;
  if (overlay.dataset.userPositioned === 'true') return;
  const canvas = document.getElementById('pdfCanvas');
  const nav = document.querySelector('.home-bottom-nav');
  const padding = 12;
  const viewportW = window.innerWidth;
  const viewportH = window.innerHeight;
  const maxWidth = Math.min(360, viewportW - padding * 2);
  overlay.style.maxWidth = `${maxWidth}px`;
  overlay.style.right = 'auto';
  overlay.style.bottom = 'auto';
  overlay.style.left = '0px';
  overlay.style.top = '0px';

  const anchor = canvas ? canvas.getBoundingClientRect() : {
    top: padding,
    right: viewportW - padding
  };

  requestAnimationFrame(() => {
    const rect = overlay.getBoundingClientRect();
    const navHeight = nav ? nav.getBoundingClientRect().height : 0;
    const maxBottom = viewportH - navHeight - padding;
    let left = anchor.right - rect.width;
    left = Math.min(Math.max(left, padding), viewportW - rect.width - padding);
    let top = anchor.top + padding;
    if (top + rect.height > maxBottom) {
      top = Math.max(padding, maxBottom - rect.height);
    }
    overlay.style.left = `${left}px`;
    overlay.style.top = `${top}px`;
  });
}

function positionSearchOverlays() {
  positionSearchNavOverlay();
  positionTextLayer();
}

function clampSearchNavPosition(left, top, overlay) {
  const nav = document.querySelector('.home-bottom-nav');
  const padding = 12;
  const viewportW = window.innerWidth;
  const viewportH = window.innerHeight;
  const navHeight = nav ? nav.getBoundingClientRect().height : 0;
  const rect = overlay.getBoundingClientRect();
  const maxLeft = viewportW - rect.width - padding;
  const maxTop = viewportH - navHeight - rect.height - padding;
  return {
    left: Math.min(Math.max(left, padding), Math.max(padding, maxLeft)),
    top: Math.min(Math.max(top, padding), Math.max(padding, maxTop))
  };
}

function initSearchNavDrag() {
  const overlay = document.getElementById('searchNavOverlay');
  if (!overlay) return;
  const input = document.getElementById('searchNavInput');
  if (input) {
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        runSearchFromNav();
      }
    });
  }
  overlay.addEventListener('pointerdown', (e) => {
    if (e.target.closest('button')) return;
    searchNavDrag.active = true;
    overlay.classList.add('dragging');
    overlay.dataset.userPositioned = 'true';
    const rect = overlay.getBoundingClientRect();
    searchNavDrag.offsetX = e.clientX - rect.left;
    searchNavDrag.offsetY = e.clientY - rect.top;
    overlay.setPointerCapture(e.pointerId);
  });
  overlay.addEventListener('pointermove', (e) => {
    if (!searchNavDrag.active) return;
    const nextLeft = e.clientX - searchNavDrag.offsetX;
    const nextTop = e.clientY - searchNavDrag.offsetY;
    const clamped = clampSearchNavPosition(nextLeft, nextTop, overlay);
    overlay.style.left = `${clamped.left}px`;
    overlay.style.top = `${clamped.top}px`;
  });
  overlay.addEventListener('pointerup', (e) => {
    if (!searchNavDrag.active) return;
    searchNavDrag.active = false;
    overlay.classList.remove('dragging');
    overlay.releasePointerCapture(e.pointerId);
  });
}

function clearSearchNavigation() {
  activeSearchResults = [];
  activeSearchIndex = -1;
  searchNavManual = false;
  const overlay = document.getElementById('searchNavOverlay');
  if (overlay) overlay.classList.remove('minimized');
  updateSearchNavOverlay();
  clearSearchHighlights();
  highlightBottomNav();
}

function toggleSearchNavMinimize() {
  const overlay = document.getElementById('searchNavOverlay');
  if (!overlay) return;
  overlay.classList.toggle('minimized');
  positionSearchNavOverlay();
}

function runSearchFromNav() {
  const input = document.getElementById('searchNavInput');
  if (!input) return;
  const query = (input.value || '').trim();
  if (!query) return;
  searchNavManual = false;
  openSearchResultsFromNav();
}

function openSearchResultsFromNav() {
  const overlay = document.getElementById('searchOverlay');
  const backdrop = document.getElementById('overlayBackdrop');
  const input = document.getElementById('searchInput');
  if (!overlay || !backdrop || !input) return;
  const query = (document.getElementById('searchNavInput')?.value || '').trim();
  closeAllOverlays();
  overlay.classList.add('show');
  backdrop.classList.add('show');
  document.getElementById('searchToggle').classList.add('active');
  input.value = query;
  if (query) performSearch(query);
  setTimeout(() => input.focus(), 50);
  highlightBottomNav();
}

function openSearchNavInput() {
  searchNavManual = true;
  const overlay = document.getElementById('searchNavOverlay');
  const input = document.getElementById('searchNavInput');
  if (!overlay) return;
  overlay.classList.remove('minimized');
  updateSearchNavOverlay();
  if (input) {
    setTimeout(() => input.focus(), 50);
  }
  highlightBottomNav();
}

async function applySearchHighlight() {
  const result = activeSearchResults[activeSearchIndex];
  if (!result || result.page !== currentPage || result.docType !== currentDocType) {
    clearSearchHighlights();
    return;
  }
  const query = (result.query || '').trim();
  if (!query) {
    clearSearchHighlights();
    return;
  }

  const requestId = ++highlightRequestId;
  resetTextLayerHighlights();
  if (requestId !== highlightRequestId) return;
  if (!currentTextItems.length || !currentTextDivs.length) return;
  const rangesByItem = buildHighlightRangesByItem(currentTextItems, query);
  if (!rangesByItem.size) return;
  for (const [itemIndex, ranges] of rangesByItem.entries()) {
    const div = currentTextDivs[itemIndex];
    if (!div) continue;
    const text = currentTextItems[itemIndex]?.str || '';
    div.innerHTML = applyRangesToText(text, ranges);
  }
  positionSearchNavOverlay();
}

async function navigateSearchResult(index, announce = false) {
  if (index < 0 || index >= activeSearchResults.length) return;
  const prevResult = activeSearchResults[activeSearchIndex];
  const result = activeSearchResults[index];
  activeSearchIndex = index;
  markSearchResultVisited(result);
  updateSearchNavOverlay();
  if (result.docType === 'supplement') {
    await openSupplementPage(result.page);
  } else {
    await openHandbookPage(result.page);
  }
  if (announce && prevResult) {
    const prevSection = getSearchResultSection(prevResult);
    const nextSection = getSearchResultSection(result);
    if (prevSection && nextSection && prevSection !== nextSection) {
      showToast(`Now in ${nextSection}`);
    }
  }
}

function prevSearchResult() {
  if (activeSearchIndex <= 0) return;
  navigateSearchResult(activeSearchIndex - 1, true);
}

function nextSearchResult() {
  if (activeSearchIndex >= activeSearchResults.length - 1) return;
  navigateSearchResult(activeSearchIndex + 1, true);
}

function toggleSearch() {
  const overlay = document.getElementById('searchOverlay');
  const backdrop = document.getElementById('overlayBackdrop');
  const isOpen = overlay.classList.contains('show');
  if (isOpen) {
    closeSearch();
  } else {
    pushNavState();
    closeAllOverlays();
    overlay.classList.add('show');
    backdrop.classList.add('show');
    document.getElementById('searchToggle').classList.add('active');
    setTimeout(() => document.getElementById('searchInput').focus(), 100);
  }
  highlightBottomNav();
}

function openSearchWithQuery(query) {
  const overlay = document.getElementById('searchOverlay');
  const backdrop = document.getElementById('overlayBackdrop');
  const input = document.getElementById('searchInput');
  if (!overlay || !backdrop) return;
  pushNavState();
  closeAllOverlays();
  overlay.classList.add('show');
  backdrop.classList.add('show');
  document.getElementById('searchToggle').classList.add('active');
  if (input) {
    input.value = query || '';
    if (query) performSearch(query);
    setTimeout(() => input.focus(), 100);
  }
}

function closeSearch() {
  document.getElementById('searchOverlay').classList.remove('show');
  document.getElementById('overlayBackdrop').classList.remove('show');
  document.getElementById('searchToggle').classList.remove('active');
  highlightBottomNav();
}

document.getElementById('searchInput').addEventListener('input', (e) => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => performSearch(e.target.value), 250);
});

async function performSearch(query) {
  const resultsDiv = document.getElementById('searchResults');
  const countDiv = document.getElementById('searchCount');
  const q = (query || '').trim();

  if (!q || q.length < 2) {
    resultsDiv.innerHTML = '';
    countDiv.textContent = '';
    lastReaderSearchResults = [];
    return;
  }

  const results = await collectSearchResults(q);
  lastReaderSearchResults = results;

  countDiv.textContent = `${results.length} result${results.length !== 1 ? 's' : ''} found`;

  resultsDiv.innerHTML = results.map((r, i) => {
    const id = getSearchResultId(r);
    const visited = tocSearchVisited.has(id) ? 'visited' : '';
    const highlighted = r.snippet.replace(new RegExp(`(${escapeRegex(r.query)})`, 'gi'), '<mark>$1</mark>');
    const label = r.docType === 'handbook'
      ? `Handbook - ${getHandbookSectionLabel(r.page)}`
      : `State Supplement - ${getSupplementStateName(r.page)}`;
    return `<div class="search-result-item ${visited}" data-search-id="${id}" onclick="openReaderSearchResult(${i})">
      <div class="result-page">${label}</div>
      <div class="result-context">${highlighted}</div>
    </div>`;
  }).join('');
}

async function collectSearchResults(query, includeMeta = false) {
  const q = (query || '').trim();
  const qLower = q.toLowerCase();
  await ensureHandbookText();
  await ensureSupplementText();
  const results = [];
  const addResults = (cache, docType, total) => {
    for (let i = 1; i <= total; i++) {
      const text = (cache[i] || '').toLowerCase();
      const idx = text.indexOf(qLower);
      if (idx !== -1) {
        const start = Math.max(0, idx - 60);
        const end = Math.min(text.length, idx + qLower.length + 60);
        let snippet = (cache[i] || '').substring(start, end);
        if (start > 0) snippet = '…' + snippet;
        if (end < text.length) snippet += '…';
        const entry = { docType, page: i, snippet, query: q };
        if (includeMeta) {
          entry.title = docType === 'handbook' ? 'Handbook' : 'State Supplement';
          entry.meta = docType === 'handbook'
            ? `Page ${i} of ${handbookDoc.numPages}`
            : `Page ${Math.max(1, i - SUPPLEMENT_PAGE_OFFSET)} of ${supplementDoc.numPages - SUPPLEMENT_PAGE_OFFSET}`;
        }
        results.push(entry);
      }
    }
  };
  addResults(handbookTextCache, 'handbook', handbookDoc.numPages);
  addResults(supplementTextCache, 'supplement', supplementDoc.numPages);
  return results;
}

function openReaderSearchResult(index) {
  const result = lastReaderSearchResults[index];
  if (!result) return;
  markSearchResultVisited(result);
  activeSearchResults = lastReaderSearchResults.slice();
  activeSearchIndex = index;
  updateSearchNavOverlay();
  navigateSearchResult(index, false);
  closeSearch();
}

function escapeRegex(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

/* TOC search across handbook + supplements */
let tocSearchTimeout = null;
const tocSearchResults = document.getElementById('tocSearchResults');
const tocSections = document.getElementById('tocSections');

function loadVisitedSearches() {
  try {
    const raw = localStorage.getItem('tocSearchVisited') || '[]';
    tocSearchVisited = new Set(JSON.parse(raw));
  } catch (e) {
    tocSearchVisited = new Set();
  }
}

function saveVisitedSearches() {
  localStorage.setItem('tocSearchVisited', JSON.stringify(Array.from(tocSearchVisited)));
}

function getSearchResultId(result) {
  if (!result) return '';
  return `${result.docType}-${result.page}`;
}

function markSearchResultVisitedById(id) {
  if (!id) return;
  if (!tocSearchVisited.has(id)) {
    tocSearchVisited.add(id);
    saveVisitedSearches();
  }
  document.querySelectorAll(`[data-search-id="${id}"]`).forEach((item) => {
    item.classList.add('visited');
  });
}

function markSearchResultVisited(result) {
  const id = getSearchResultId(result);
  markSearchResultVisitedById(id);
}

function renderSearchResults(results, query) {
  if (!results.length) {
    lastTocSearchResults = [];
    tocSearchResults.innerHTML = `<div class="toc-search-item"><div class="result-title">No matches found</div><div class="result-meta">Try a different keyword</div></div>`;
    return;
  }
  lastTocSearchResults = results;
  tocSearchResults.innerHTML = results.map((r, i) => {
    const id = getSearchResultId(r);
    const visited = tocSearchVisited.has(id) ? 'visited' : '';
    const highlighted = r.snippet.replace(new RegExp(`(${escapeRegex(query)})`, 'gi'), '<mark>$1</mark>');
    return `<div class="toc-search-item ${visited}" data-id="${id}" data-search-id="${id}" onclick="openSearchResult(${i})">
      <div class="result-title">${r.title}</div>
      <div class="result-meta">${r.meta}</div>
      <div class="result-snippet">${highlighted}</div>
    </div>`;
  }).join('');
}

async function performGlobalSearch(query) {
  const q = (query || '').trim();
  if (!q || q.length < 2) {
    tocSearchResults.classList.remove('show');
    tocSections.style.display = '';
    tocSearchResults.innerHTML = '';
    lastTocSearchResults = [];
    return;
  }
  tocSections.style.display = 'none';
  tocSearchResults.classList.add('show');
  tocSearchResults.innerHTML = `<div class="toc-search-item"><div class="result-title">Searching…</div><div class="result-meta">This can take a moment</div></div>`;
  const results = await collectSearchResults(q, true);
  renderSearchResults(results, q);
}

function openSearchResult(index) {
  const result = lastTocSearchResults[index];
  if (!result) return;
  markSearchResultVisited(result);
  activeSearchResults = lastTocSearchResults.slice();
  activeSearchIndex = index;
  updateSearchNavOverlay();
  navigateSearchResult(index, false);
}

document.getElementById('tocSearchInput').addEventListener('input', (e) => {
  clearTimeout(tocSearchTimeout);
  tocSearchTimeout = setTimeout(() => performGlobalSearch(e.target.value), 250);
});

loadVisitedSearches();

/* ═══════════════════════════════════════════════════════════
   STATE SUPPLEMENTS
   ═══════════════════════════════════════════════════════════ */
function buildSupplementList(filter = '') {
  const grid = document.getElementById('supplementGrid');
  const q = filter.trim().toLowerCase();
  const states = STATE_LIST.filter(state => !q || state.toLowerCase().includes(q));
  grid.innerHTML = states.map(state => {
    const page = STATE_PAGES[state];
    const pageLabel = page ? `p. ${page}` : 'View';
    return `<button class="supplement-state" type="button" onclick="openSupplementState('${state.replace(/'/g, "\\'")}')">
      <span>${state}</span>
      <small>${pageLabel}</small>
    </button>`;
  }).join('');
}

function openSupplementOverlay() {
  pushNavState();
  closeAllOverlays();
  buildSupplementList();
  document.getElementById('supplementSearch').value = '';
  document.getElementById('supplementOverlay').classList.add('show');
  document.getElementById('supplementToggle').classList.add('active');
  setTimeout(() => document.getElementById('supplementSearch').focus(), 100);
  highlightBottomNav();
}

function closeSupplementOverlay() {
  document.getElementById('supplementOverlay').classList.remove('show');
  document.getElementById('supplementToggle').classList.remove('active');
  highlightBottomNav();
}

function closeSupplementOverlayOnBackdrop(e) {
  if (e.target.id === 'supplementOverlay') closeSupplementOverlay();
}

// openSupplementState defined in navigation section

document.getElementById('supplementSearch').addEventListener('input', (e) => {
  buildSupplementList(e.target.value);
});

/* ═══════════════════════════════════════════════════════════
   APP MENU
   ═══════════════════════════════════════════════════════════ */
function toggleAppMenu() {
  const panel = document.getElementById('appMenuPanel');
  if (panel.classList.contains('show')) {
    closeAppMenu();
  } else {
    openAppMenu();
  }
}

function openAppMenu() {
  closeAllOverlays();
  document.getElementById('appMenuBackdrop').classList.add('show');
  document.getElementById('appMenuPanel').classList.add('show');
  document.getElementById('appMenuButton').classList.add('active');
}

function closeAppMenu() {
  document.getElementById('appMenuBackdrop').classList.remove('show');
  document.getElementById('appMenuPanel').classList.remove('show');
  document.getElementById('appMenuButton').classList.remove('active');
}

/* ═══════════════════════════════════════════════════════════
   OVERLAYS
   ═══════════════════════════════════════════════════════════ */
function toggleTocOverlay() {
  const overlay = document.getElementById('tocOverlay');
  const backdrop = document.getElementById('overlayBackdrop');
  const isOpen = overlay.classList.contains('show');
  if (isOpen) {
    closeTocOverlay();
  } else {
    pushNavState();
    closeAllOverlays();
    overlay.classList.add('show');
    backdrop.classList.add('show');
    document.getElementById('tocToggle').classList.add('active');
    highlightTocOverlay();
  }
}

function closeTocOverlay() {
  document.getElementById('tocOverlay').classList.remove('show');
  document.getElementById('overlayBackdrop').classList.remove('show');
  document.getElementById('tocToggle').classList.remove('active');
}

function closeAllOverlays() {
  closeTocOverlay();
  closeSearch();
  closeSupplementOverlay();
  closeSectionTools();
  closeAppMenu();
}

/* ═══════════════════════════════════════════════════════════
   SECTION TOOLS
   ═══════════════════════════════════════════════════════════ */
function toggleSectionTools(btn) {
  const pop = document.getElementById('sectionToolsPop');
  const backdrop = document.getElementById('overlayBackdrop');
  if (pop.classList.contains('show')) {
    closeSectionTools();
    return;
  }
  pushNavState();
  closeTocOverlay();
  closeSearch();
  const isMobile = window.innerWidth <= 640;
  if (!isMobile) {
    const rect = btn.getBoundingClientRect();
    pop.style.top = (rect.bottom + 6) + 'px';
    pop.style.right = (window.innerWidth - rect.right) + 'px';
  }
  pop.classList.add('show');
  if (isMobile) backdrop.classList.add('show');
  document.getElementById('toolsToggle').classList.add('active');
}

function closeSectionTools() {
  document.getElementById('sectionToolsPop').classList.remove('show');
  document.getElementById('toolsToggle').classList.remove('active');
  if (window.innerWidth <= 640) {
    // Only remove backdrop if TOC/search aren't open
    const tocOpen = document.getElementById('tocOverlay').classList.contains('show');
    const searchOpen = document.getElementById('searchOverlay').classList.contains('show');
    if (!tocOpen && !searchOpen) {
      document.getElementById('overlayBackdrop').classList.remove('show');
    }
  }
}

function printCurrentPage() {
  closeSectionTools();
  window.print();
}

function downloadHandbook() {
  closeSectionTools();
  const a = document.createElement('a');
  a.href = currentDocType === 'supplement' ? SUPPLEMENT_URL : HANDBOOK_URL;
  a.download = currentDocType === 'supplement' ? 'State Supplement 2025.pdf' : '2025_Teammate_Handbook.pdf';
  a.click();
}

function copyPageLink() {
  closeSectionTools();
  const url = window.location.origin + window.location.pathname + '#' + buildHash(currentPage, currentSupplementState);
  navigator.clipboard.writeText(url).then(() => showToast('Page link copied!')).catch(() => showToast('Could not copy link'));
}

function copySectionLink() {
  closeSectionTools();
  if (currentDocType !== 'handbook') {
    copyPageLink();
    return;
  }
  let sectionName = '';
  for (let i = TOC.length - 1; i >= 0; i--) {
    if (currentPage >= TOC[i].page) {
      sectionName = TOC[i].title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
      break;
    }
  }
  const url = window.location.origin + window.location.pathname + '#section=' + (sectionName || 'welcome');
  navigator.clipboard.writeText(url).then(() => showToast('Section link copied!')).catch(() => showToast('Could not copy link'));
}

/* ═══════════════════════════════════════════════════════════
   TOAST
   ═══════════════════════════════════════════════════════════ */
function showToast(msg) {
  const toast = document.getElementById('toast');
  document.getElementById('toastMsg').textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

function updateResourcesOverlay() {
  const overlay = document.getElementById('resourcesOverlay');
  if (currentDocType !== 'handbook' || currentPage !== 56) {
    overlay.classList.remove('show');
    return;
  }
  const canvas = document.getElementById('pdfCanvas');
  const rect = canvas.getBoundingClientRect();
  const area = document.getElementById('canvasArea');
  overlay.style.left = `${canvas.offsetLeft}px`;
  overlay.style.top = `${canvas.offsetTop}px`;
  overlay.style.width = `${rect.width}px`;
  overlay.style.height = `${rect.height}px`;
  const rows = KEY_RESOURCES.map(item => {
    const lines = item.lines.map(line => {
      if (line.textOnly) {
        return `<div class="resources-note">${line.label}</div>`;
      }
      return `<div><a href="${line.href}" target="_blank" rel="noopener">${line.label}</a></div>`;
    }).join('');
    return `<tr><td>${item.title}</td><td>${lines}</td></tr>`;
  }).join('');
  overlay.innerHTML = `
    <div class="resources-title">Key Resources</div>
    <div class="resources-sub">Revised February 2026</div>
    <table class="resources-table">${rows}</table>
  `;
  overlay.classList.add('show');
}

/* ═══════════════════════════════════════════════════════════
   RESIZE HANDLER
   ═══════════════════════════════════════════════════════════ */
/* ═══════════════════════════════════════════════════════════
   RESIZE / ORIENTATION HANDLER
   ═══════════════════════════════════════════════════════════ */
let resizeTimeout;
function handleResize() {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    syncTocLogoWidth();
    computeBaseScale();
    if (!document.getElementById('readerView').classList.contains('hidden')) {
      renderPage(currentPage);
    }
    updateResourcesOverlay();
  }, 150);
}
window.addEventListener('resize', handleResize);
window.addEventListener('orientationchange', () => {
  // Delay slightly for orientation animation to complete
  setTimeout(handleResize, 300);
});

/* Click outside popover */
document.addEventListener('click', (e) => {
  const pop = document.getElementById('sectionToolsPop');
  const btn = document.getElementById('toolsToggle');
  if (pop.classList.contains('show') && !pop.contains(e.target) && !btn.contains(e.target)) {
    closeSectionTools();
  }
});

/* ═══════════════════════════════════════════════════════════
   BOOT
   ═══════════════════════════════════════════════════════════ */
init();
</script>
</body>
</html>
