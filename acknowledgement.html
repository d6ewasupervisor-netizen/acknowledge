<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0d1b2a">
  <title>Acknowledgement of Receipt — ADV Teammate Handbook</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=DM+Serif+Display&family=Dancing+Script:wght@400;600&family=Great+Vibes&family=Pacifico&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- App configuration (gitignored — copy config.example.js to config.js) -->
  <script src="config.js"></script>
  <!-- Firebase SDK for real-time fax delivery tracking -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --navy-950: #060e1a;
      --navy-900: #0d1b2a;
      --navy-800: #1b2d4a;
      --navy-700: #243b5e;
      --navy-600: #2e4a72;
      --blue-500: #4a90c4;
      --blue-400: #6aaddb;
      --blue-300: #7cb9d8;
      --blue-200: #a3d5e8;
      --blue-100: #d4ecf5;
      --blue-50: #eef7fb;
      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-300: #cbd5e1;
      --slate-400: #94a3b8;
      --slate-500: #64748b;
      --slate-600: #475569;
      --slate-700: #334155;
      --slate-800: #1e293b;
      --slate-900: #0f172a;
      --white: #ffffff;
      --red-500: #ef4444;
      --green-500: #22c55e;
      --bottom-nav-height: calc(68px * 1.2);
      --bottom-nav-scale: 1.2;
      --menu-btn-size: 40px;
      --menu-btn-gap: 12px;
      --top-toolbar-height: 56px;
      --watermark-logo: url('ro_logo.png');
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
      background: var(--navy-950);
      color: var(--slate-800);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: var(--watermark-logo);
      background-repeat: repeat;
      background-position: center top;
      background-size: min(220px, 26vw);
      opacity: 0.06;
      pointer-events: none;
      z-index: 0;
    }

    .header {
      background: linear-gradient(135deg, var(--navy-950) 0%, var(--navy-900) 50%, var(--navy-800) 100%);
      padding: 2.25rem 2.25rem;
      padding-left: calc(2.25rem + var(--menu-btn-size) + 0.75rem);
      padding-right: calc(2.25rem + var(--menu-btn-size) + 0.75rem);
      text-align: center;
      position: relative;
      overflow: hidden;
      border-bottom: 1px solid rgba(74,144,196,0.15);
    }
    .header::before {
      content: '';
      position: absolute; top: -60%; right: -10%;
      width: 400px; height: 400px;
      background: radial-gradient(circle, rgba(74,144,196,0.08) 0%, transparent 70%);
      border-radius: 50%; pointer-events: none;
    }
    .header-inner {
      max-width: 720px; margin: 0 auto;
      position: relative; z-index: 1;
    }
    .header-logo {
      height: clamp(40px, 7vw, 56px);
      max-width: 70vw;
      object-fit: contain;
      margin-bottom: 1rem;
    }
    .header h1 {
      font-family: 'DM Serif Display', serif;
      font-size: clamp(1.3rem, 3.5vw, 1.75rem);
      font-weight: 400;
      color: var(--white);
      margin-bottom: 0.35rem;
    }
    .header p { color: var(--slate-400); font-size: 0.85rem; line-height: 1.6; }
    .header p .header-sub { display: block; }
    .header p .header-sub:first-child { margin-bottom: 0.15rem; }

    .page-shell {
      position: relative;
      z-index: 1;
      padding-top: calc(var(--top-toolbar-height) + 0.75rem);
    }

    .container { max-width: 720px; margin: 0 auto; padding: 2.25rem 1.75rem calc(4.5rem + var(--bottom-nav-height)); }

    .download-card,
    .option-card {
      background: var(--navy-900);
      border: 1px solid rgba(74,144,196,0.15);
      border-radius: 14px;
      padding: 1.5rem 1.75rem;
      margin-bottom: 1.75rem;
      display: flex; align-items: center; gap: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .download-card:hover,
    .option-card:hover { border-color: rgba(74,144,196,0.3); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
    .option-card { align-items: flex-start; gap: 1.25rem; }
    .option-card h3 {
      font-size: 0.95rem; font-weight: 700; color: var(--white);
      margin-bottom: 0.35rem;
    }
    .option-card p { font-size: 0.8rem; color: var(--slate-500); }
    .option-actions { display: grid; gap: 0.75rem; width: 100%; }
    .option-actions .sig-row { background: rgba(255,255,255,0.02); }
    .option-actions input, .option-actions select {
      width: 100%; padding: 0.6rem 0.75rem;
      border-radius: 8px; border: 1px solid rgba(74,144,196,0.2);
      background: rgba(255,255,255,0.04); color: var(--white);
      font-family: inherit; font-size: 0.88rem;
    }
    .option-btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
      padding: 0.7rem 1.1rem; border-radius: 10px; border: none;
      background: var(--blue-500); color: var(--white); font-weight: 600;
      cursor: pointer; transition: background 0.15s ease, transform 0.1s;
      min-height: 44px;
    }
    .option-btn:hover { background: var(--blue-400); }
    .option-btn:active { transform: scale(0.97); }
    .option-hint { font-size: 0.75rem; color: var(--slate-500); }
    .download-icon {
      flex-shrink: 0;
      width: 48px; height: 48px;
      background: rgba(74,144,196,0.1);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
    }
    .download-icon svg { width: 24px; height: 24px; color: var(--blue-400); }
    .download-info { flex: 1; }
    .download-info h3 { font-size: 0.9rem; font-weight: 600; color: var(--white); margin-bottom: 0.1rem; }
    .download-info p { font-size: 0.78rem; color: var(--slate-500); }
    .download-btn {
      flex-shrink: 0;
      display: inline-flex; align-items: center; gap: 0.4rem;
      background: var(--blue-500); color: var(--white);
      text-decoration: none;
      font-size: 0.82rem; font-weight: 600;
      padding: 0.6rem 1.15rem; border-radius: 10px;
      transition: background 0.2s ease, transform 0.1s;
      min-height: 40px;
    }
    .download-btn:hover { background: var(--blue-400); }
    .download-btn:active { transform: scale(0.97); }
    .download-btn svg { width: 14px; height: 14px; }

    .option-dropdown {
      padding: 0;
      display: block;
    }
    .option-dropdown summary {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem 1.75rem;
      cursor: pointer;
    }
    .option-dropdown summary::-webkit-details-marker { display: none; }
    .option-dropdown .option-summary {
      flex: 1;
    }
    .option-dropdown .option-summary h3 {
      margin-bottom: 0.25rem;
    }
    .option-dropdown .option-chevron {
      width: 18px;
      height: 18px;
      color: var(--slate-500);
      transition: transform 0.2s ease;
    }
    .option-dropdown[open] .option-chevron { transform: rotate(180deg); }
    .option-dropdown-body {
      padding: 0 1.75rem 1.5rem;
      border-top: 1px solid rgba(74,144,196,0.12);
    }

    .card {
      background: var(--navy-900);
      border: 1px solid rgba(74,144,196,0.12);
      border-radius: 14px;
      padding: 2rem 1.75rem;
      margin-bottom: 1.75rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }
    .card h2 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.25rem;
      font-weight: 400;
      color: var(--white);
      margin-bottom: 1.15rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid rgba(74,144,196,0.15);
    }
    .ack-text { font-size: 0.88rem; line-height: 1.85; color: var(--slate-300); }
    .ack-text p { margin-bottom: 0.9rem; }
    .ack-text p:last-child { margin-bottom: 0; }

    .form-row { margin-bottom: 1.5rem; }
    .form-row label {
      display: block;
      font-size: 0.75rem; font-weight: 700;
      color: var(--slate-400);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.5rem;
    }
    .form-row input[type="text"],
    .form-row input[type="date"] {
      width: 100%;
      padding: 0.75rem 0.95rem;
      font-family: inherit; font-size: 0.92rem;
      color: var(--white);
      background: rgba(255,255,255,0.05);
      border: 1.5px solid rgba(74,144,196,0.2);
      border-radius: 10px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
      min-height: 48px;
    }
    .form-row input::placeholder { color: var(--slate-600); }
    .form-row input:focus {
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px rgba(74,144,196,0.15);
      background: rgba(255,255,255,0.07);
    }
    /* Fix date input color for dark theme */
    .form-row input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(0.7);
    }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 540px) { .form-grid { grid-template-columns: 1fr; } }

    .sig-container { position: relative; }
    .sig-canvas {
      width: 100%; height: 170px;
      background: rgba(255,255,255,0.03);
      border: 1.5px solid rgba(74,144,196,0.2);
      border-radius: 10px;
      cursor: crosshair; touch-action: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .sig-canvas.disabled { cursor: not-allowed; pointer-events: none; opacity: 0.6; }
    .sig-canvas.locked { pointer-events: none; }
    .sig-canvas.active { border-color: var(--blue-500); box-shadow: 0 0 0 3px rgba(74,144,196,0.2); }
    .sig-canvas.has-signature { border-color: var(--blue-400); box-shadow: 0 0 0 2px rgba(74,144,196,0.1); }
    .sig-placeholder {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: var(--slate-600); font-size: 0.82rem;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .sig-placeholder.hidden { opacity: 0; }
    .sig-line {
      position: absolute; bottom: 36px; left: 20px; right: 20px;
      height: 1px; background: rgba(74,144,196,0.15);
      pointer-events: none;
    }
    .sig-clear,
    .sig-save {
      position: absolute; top: 8px; right: 8px;
      background: var(--navy-800);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 8px;
      padding: 0.35rem 0.65rem;
      font-size: 0.72rem; font-weight: 600;
      color: var(--slate-500);
      cursor: pointer;
      opacity: 0; transition: opacity 0.2s, color 0.15s, transform 0.1s;
      min-height: 32px;
      display: flex; align-items: center;
    }
    .sig-save { right: 68px; }
    .sig-clear.visible { opacity: 1; }
    .sig-save.visible { opacity: 1; }
    .sig-clear:hover { color: var(--red-500); }
    .sig-save:hover { color: var(--blue-200); }
    .sig-clear:active, .sig-save:active { transform: scale(0.95); }

    .sig-controls {
      display: grid; gap: 0.9rem;
      margin-bottom: 1.2rem;
    }
    .sig-toggle {
      display: grid; grid-template-columns: repeat(3, minmax(56px, 1fr));
      gap: 0.6rem;
    }
    .sig-option {
      background: rgba(74,144,196,0.08);
      border: 1.5px solid rgba(74,144,196,0.2);
      border-radius: 10px;
      padding: 0.65rem 0.7rem;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 0.8rem; font-weight: 600; color: var(--slate-300);
      cursor: pointer; transition: all 0.15s ease;
      min-height: 44px;
    }
    .sig-option.active { background: rgba(74,144,196,0.2); color: var(--white); border-color: rgba(74,144,196,0.5); box-shadow: 0 0 0 2px rgba(74,144,196,0.15); }
    .sig-option:active { transform: scale(0.96); }
    .sig-option svg {
      width: 22px;
      height: 22px;
      stroke-width: 1.8;
    }
    .sig-row {
      display: flex; flex-wrap: wrap; gap: 0.85rem; align-items: center;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(74,144,196,0.15);
      border-radius: 10px;
      padding: 0.85rem;
    }
    .sig-row label { font-size: 0.72rem; letter-spacing: 0.05em; text-transform: uppercase; color: var(--slate-500); }
    .sig-ink {
      display: flex; align-items: center; gap: 0.5rem;
    }
    .sig-color {
      width: 34px; height: 34px; border-radius: 50%;
      border: 2.5px solid rgba(255,255,255,0.3);
      cursor: pointer; transition: transform 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .sig-color.active { border-color: var(--white); transform: scale(1.08); box-shadow: 0 0 0 3px rgba(74,144,196,0.25); }
    .sig-size input[type="range"] { width: 140px; }
    .sig-action-btn {
      padding: 0.6rem 1rem; border-radius: 8px; border: 1px solid rgba(74,144,196,0.25);
      background: rgba(74,144,196,0.15); color: var(--white); font-weight: 600;
      cursor: pointer; transition: background 0.15s ease, transform 0.1s ease;
      min-height: 44px; font-size: 0.85rem;
    }
    .sig-action-btn:active:not(:disabled) { transform: scale(0.97); }
    .sig-action-btn.secondary { background: rgba(255,255,255,0.05); color: var(--slate-300); }
    .sig-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .sig-typed-controls { display: grid; gap: 0.5rem; width: 100%; }
    .sig-typed-controls input, .sig-typed-controls select {
      width: 100%; padding: 0.6rem 0.75rem;
      border-radius: 8px; border: 1px solid rgba(74,144,196,0.2);
      background: rgba(255,255,255,0.04); color: var(--white);
      font-family: inherit; font-size: 0.9rem;
    }
    .sig-hint {
      font-size: 0.75rem; color: var(--slate-500);
      margin-top: 0.4rem;
      line-height: 1.5;
    }
    .sig-hidden { display: none !important; }
    .scan-panel {
      display: grid; gap: 0.8rem;
      border: 1px dashed rgba(74,144,196,0.3);
      border-radius: 12px;
      padding: 0.9rem;
      background: rgba(255,255,255,0.02);
    }
    .scan-actions {
      display: flex; flex-wrap: wrap; gap: 0.6rem;
      align-items: center;
    }
    .scan-canvas-wrap {
      position: relative;
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      background: rgba(0,0,0,0.2);
    }
    #scanCanvas {
      width: 100%;
      height: 320px;
      display: block;
      background: #111827;
    }
    .scan-handle {
      position: absolute;
      width: 16px; height: 16px;
      background: var(--blue-300);
      border: 2px solid var(--white);
      border-radius: 50%;
      cursor: grab;
      transform: translate(-50%, -50%);
    }
    .scan-handle:active { cursor: grabbing; }
    .scan-overlay {
      position: absolute; inset: 0;
      border: 2px solid rgba(74,144,196,0.7);
      pointer-events: none;
    }

    .consent-row {
      margin: 1.65rem 0 1.4rem;
      display: flex; align-items: flex-start; gap: 0.85rem;
      padding: 1rem;
      background: rgba(74,144,196,0.04);
      border: 1px solid rgba(74,144,196,0.1);
      border-radius: 10px;
      transition: border-color 0.2s;
    }
    .consent-row:has(input:checked) {
      border-color: rgba(74,144,196,0.25);
      background: rgba(74,144,196,0.06);
    }
    .consent-row input[type="checkbox"] {
      flex-shrink: 0;
      width: 22px; height: 22px;
      margin-top: 2px;
      accent-color: var(--blue-500);
      cursor: pointer;
    }
    .consent-row label {
      font-size: 0.85rem; color: var(--slate-300);
      line-height: 1.6; cursor: pointer;
      text-transform: none; letter-spacing: normal; font-weight: 400;
    }
    .consent-row label strong { font-weight: 700; color: var(--blue-300); }

    .submit-btn {
      width: 100%;
      padding: 0.95rem 1.5rem;
      font-family: inherit; font-size: 1rem; font-weight: 700;
      color: var(--white);
      background: linear-gradient(135deg, var(--blue-500) 0%, #3a7bb8 100%);
      border: none; border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s, opacity 0.2s, box-shadow 0.2s;
      min-height: 52px;
      letter-spacing: 0.01em;
    }
    .submit-btn:hover:not(:disabled) { background: linear-gradient(135deg, var(--blue-400) 0%, var(--blue-500) 100%); box-shadow: 0 4px 16px rgba(74,144,196,0.3); }
    .submit-btn:active:not(:disabled) { transform: scale(0.98); }
    .submit-btn:disabled { opacity: 0.35; cursor: not-allowed; background: var(--slate-600); }

    .error-msg {
      font-size: 0.78rem; color: var(--red-500); margin-top: 0.4rem; display: none;
      padding: 0.35rem 0.6rem;
      background: rgba(239,68,68,0.08);
      border-radius: 6px;
      line-height: 1.4;
      animation: shakeError 0.4s ease;
    }
    .form-row.error input, .form-row.error .sig-canvas { border-color: var(--red-500) !important; box-shadow: 0 0 0 2px rgba(239,68,68,0.15) !important; }
    .form-row.error .error-msg { display: block; }
    @keyframes shakeError {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-4px); }
      40% { transform: translateX(4px); }
      60% { transform: translateX(-2px); }
      80% { transform: translateX(2px); }
    }

    /* Save Overlay */
    .save-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(6,14,26,0.75);
      backdrop-filter: blur(8px);
      z-index: 100;
      align-items: center; justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    .save-overlay.show { display: flex; }
    .save-card {
      background: var(--navy-900);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 16px;
      padding: 2.5rem 2rem;
      text-align: center;
      max-width: 480px; width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.4s ease;
    }
    .save-icon {
      width: 64px; height: 64px;
      background: rgba(34,197,94,0.12);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 1.25rem;
    }
    .save-icon svg { width: 32px; height: 32px; color: var(--green-500); }
    .save-card h3 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.3rem; font-weight: 400;
      color: var(--white);
      margin-bottom: 0.5rem;
    }
    .save-card > p { font-size: 0.88rem; color: var(--slate-400); margin-bottom: 1.5rem; line-height: 1.6; }
    .signer-detail {
      font-size: 0.8rem; color: var(--slate-400);
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(74,144,196,0.1);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 1.5rem;
      text-align: left;
    }
    .signer-detail span { display: block; margin-bottom: 0.2rem; }
    .signer-detail strong { color: var(--slate-300); }

    .save-buttons { display: flex; flex-direction: column; gap: 0.75rem; }
    .save-btn {
      display: flex; align-items: center; justify-content: center; gap: 0.6rem;
      padding: 0.85rem 1.5rem;
      border-radius: 12px;
      font-family: inherit; font-size: 0.92rem; font-weight: 600;
      cursor: pointer; border: none;
      transition: all 0.2s ease;
      text-decoration: none;
      min-height: 48px;
    }
    .save-btn:active { transform: scale(0.98); }
    .save-btn svg { width: 20px; height: 20px; flex-shrink: 0; }
    .save-btn.onedrive { background: #0078d4; color: var(--white); }
    .save-btn.onedrive:hover { background: #106ebe; }
    .save-btn.download {
      background: rgba(255,255,255,0.06);
      color: var(--slate-300);
      border: 1px solid rgba(74,144,196,0.2);
    }
    .save-btn.download:hover { background: rgba(255,255,255,0.1); }
    .save-btn.done {
      background: transparent;
      color: var(--slate-500);
      font-size: 0.82rem; font-weight: 500;
      padding: 0.5rem;
    }
    .save-btn.done:hover { color: var(--slate-300); }
    .onedrive-status { font-size: 0.75rem; color: var(--slate-500); margin-top: 0.2rem; font-style: italic; }
    .cloud-save-status {
      font-size: 0.78rem;
      color: var(--slate-400);
      margin: 0.4rem 0 1rem;
    }
    .cloud-save-status.success { color: var(--green-500); }
    .cloud-save-status.warn { color: var(--amber-500); }
    .cloud-save-status.error { color: var(--red-500); }

    #hiddenFileInput { display: none; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .footer {
      text-align: center;
      padding: 2.25rem 1rem calc(2.25rem + var(--bottom-nav-height));
      font-size: 0.75rem;
      color: var(--slate-600);
    }

    .alternate-options {
      margin-top: 0.75rem;
    }
    .alternate-label {
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--slate-500);
      margin: 0.25rem 0 0.9rem;
      padding-left: 0.35rem;
    }

    .app-toolbar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      padding-left: calc(max(0.75rem, env(safe-area-inset-left)) + var(--menu-btn-size) + var(--menu-btn-gap));
      background: var(--navy-900);
      border-bottom: 1px solid rgba(74,144,196,0.12);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--top-toolbar-height);
      z-index: 50;
    }
    .toolbar-logo {
      height: clamp(18px, 4vw, 32px);
      width: auto;
      max-width: min(220px, 45vw);
      object-fit: contain;
      margin-right: 0.25rem;
      cursor: pointer;
    }
    .toolbar-divider { width: 1px; height: 24px; background: rgba(74,144,196,0.15); margin: 0 0.25rem; }
    .toolbar-spacer { flex: 1; }

    .app-menu-button {
      position: fixed;
      top: max(0.5rem, env(safe-area-inset-top));
      left: max(0.5rem, env(safe-area-inset-left));
      width: var(--menu-btn-size);
      height: var(--menu-btn-size);
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(6,14,26,0.9);
      border: 1px solid rgba(74,144,196,0.25);
      border-radius: 12px;
      color: var(--slate-300);
      cursor: pointer;
      z-index: 80;
      transition: all 0.2s ease;
    }
    .app-menu-button:hover { background: rgba(13,27,42,1); color: var(--blue-100); }
    .app-menu-button.active { background: rgba(74,144,196,0.2); color: var(--blue-100); border-color: rgba(74,144,196,0.5); }
    .app-menu-button svg, .app-menu-button .icon-img { width: 20px; height: 20px; }

    .app-menu-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(6,14,26,0.6);
      backdrop-filter: blur(4px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 70;
    }
    .app-menu-backdrop.show { opacity: 1; visibility: visible; }

    .app-menu-panel {
      position: fixed;
      top: calc(max(0.5rem, env(safe-area-inset-top)) + var(--menu-btn-size) + 0.75rem);
      left: max(0.5rem, env(safe-area-inset-left));
      width: min(320px, 90vw);
      max-height: calc(100vh - 5rem);
      overflow: auto;
      background: rgba(13,27,42,0.96);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.45);
      opacity: 0;
      transform: translateY(6px);
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 75;
    }
    .app-menu-panel.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .app-menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.85rem 1rem 0.65rem;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--white);
      border-bottom: 1px solid rgba(74,144,196,0.15);
    }
    .app-menu-close {
      background: transparent;
      border: none;
      color: var(--slate-400);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 6px;
    }
    .app-menu-close:hover { background: rgba(74,144,196,0.15); color: var(--white); }
    .app-menu-section { padding: 0.75rem 1rem 0.25rem; }
    .app-menu-title {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--slate-400);
      margin-bottom: 0.5rem;
    }
    .app-menu-item {
      width: 100%;
      text-align: left;
      padding: 0.8rem 0.85rem;
      border-radius: 10px;
      background: transparent;
      border: 1px solid transparent;
      color: var(--slate-200);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      transition: all 0.15s ease;
      margin-bottom: 0.35rem;
      min-height: 44px;
    }
    .app-menu-item:hover { background: rgba(74,144,196,0.16); color: var(--white); }
    .app-menu-item:active { background: rgba(74,144,196,0.25); transform: scale(0.98); }
    .app-menu-kbd {
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      border-radius: 6px;
      background: rgba(74,144,196,0.18);
      color: var(--blue-200);
      font-weight: 600;
    }

    .toolbar-btn {
      display: flex; align-items: center; justify-content: center; gap: 0.35rem;
      padding: 0.4rem 0.6rem;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 8px;
      color: var(--slate-400);
      font-family: inherit; font-size: 0.75rem; font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }
    .toolbar-btn:hover { background: rgba(74,144,196,0.1); color: var(--blue-300); }
    .toolbar-btn:active { transform: scale(0.95); }
    .toolbar-btn.active { background: rgba(74,144,196,0.25); color: var(--blue-300); border-color: rgba(74,144,196,0.4); }
    .toolbar-btn svg { width: 16px; height: 16px; flex-shrink: 0; }
    .toolbar-btn .btn-label { display: inline; }
    @media (max-width: 640px) { .toolbar-btn .btn-label { display: none; } }
    .toolbar-btn.ack-btn {
      background: var(--blue-500);
      color: var(--white);
      border-color: var(--blue-500);
    }
    .toolbar-btn.ack-btn.active {
      background: var(--blue-400);
      color: var(--white);
      border-color: var(--blue-400);
    }

    .home-bottom-nav {
      display: flex;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: calc(0.5rem * var(--bottom-nav-scale)) calc(0.75rem * var(--bottom-nav-scale)) max(calc(0.5rem * var(--bottom-nav-scale)), env(safe-area-inset-bottom));
      background: rgba(6,14,26,0.98);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid rgba(74,144,196,0.15);
      gap: calc(0.35rem * var(--bottom-nav-scale));
      z-index: 60;
    }
    .home-bottom-nav .toolbar-btn {
      flex: 1;
      justify-content: center;
      flex-direction: column;
      padding: calc(0.35rem * var(--bottom-nav-scale)) calc(0.3rem * var(--bottom-nav-scale));
      font-size: calc(0.65rem * var(--bottom-nav-scale));
      border-radius: calc(8px * var(--bottom-nav-scale));
      gap: 2px;
      min-height: calc(44px * var(--bottom-nav-scale));
    }
    .home-bottom-nav .toolbar-btn svg {
      width: calc(18px * var(--bottom-nav-scale));
      height: calc(18px * var(--bottom-nav-scale));
    }
    .home-bottom-nav .toolbar-btn .btn-label {
      display: inline;
      font-size: calc(0.6rem * var(--bottom-nav-scale));
    }
    .home-bottom-nav .toolbar-btn:active { transform: scale(0.95); }
    .home-bottom-nav .toolbar-btn.active {
      background: rgba(74,144,196,0.12);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(74,144,196,0.2); border-radius: 3px; }

    @media print {
      body { background: white; color: #1e293b; }
      .download-card, .option-card, .submit-btn, .sig-clear, .consent-row,
      .header-nav, .app-toolbar, .app-menu-button, .app-menu-panel,
      .app-menu-backdrop, .home-bottom-nav { display: none !important; }
      .card { box-shadow: none; border: 1px solid #ccc; background: white; }
      .card h2 { color: #0d1b2a; border-color: #ddd; }
      .ack-text { color: #334155; }
    }

    /* ═══════════════════════════════════════════════════════════
       FAX MODAL STYLES
       ═══════════════════════════════════════════════════════════ */
    .fax-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(6,14,26,0.8);
      backdrop-filter: blur(8px);
      z-index: 200;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    .fax-modal-overlay.show { display: flex; }

    .fax-modal {
      background: var(--navy-900);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 16px;
      width: 90%;
      max-width: 520px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      overflow: hidden;
    }

    .fax-modal-header {
      padding: 1.5rem 1.5rem 1rem;
      border-bottom: 1px solid rgba(74,144,196,0.12);
      flex-shrink: 0;
    }
    .fax-modal-header h3 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.25rem;
      font-weight: 400;
      color: var(--white);
      margin-bottom: 0.35rem;
    }
    .fax-modal-header p {
      font-size: 0.82rem;
      color: var(--slate-400);
      line-height: 1.5;
    }
    .fax-modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      color: var(--slate-500);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 8px;
      transition: color 0.15s, background 0.15s;
    }
    .fax-modal-close:hover {
      color: var(--slate-300);
      background: rgba(255,255,255,0.05);
    }
    .fax-modal-close svg { width: 20px; height: 20px; }

    .fax-search-wrap {
      padding: 0 1.5rem 1rem;
      flex-shrink: 0;
    }
    .fax-search {
      width: 100%;
      padding: 0.7rem 1rem 0.7rem 2.5rem;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 10px;
      color: var(--white);
      font-family: inherit;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .fax-search::placeholder { color: var(--slate-600); }
    .fax-search:focus {
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px rgba(74,144,196,0.15);
    }
    .fax-search-icon {
      position: absolute;
      left: 0.85rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--slate-500);
      pointer-events: none;
    }
    .fax-search-icon svg { width: 16px; height: 16px; }
    .fax-search-container { position: relative; }

    .fax-store-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 0.75rem;
      min-height: 200px;
      max-height: 300px;
    }
    .fax-store-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.85rem 0.9rem;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      border: 1px solid transparent;
      min-height: 52px;
    }
    .fax-store-item:hover { background: rgba(74,144,196,0.08); }
    .fax-store-item:active { transform: scale(0.99); }
    .fax-store-item.selected {
      background: rgba(74,144,196,0.15);
      border-color: rgba(74,144,196,0.3);
    }
    .fax-store-radio {
      width: 20px;
      height: 20px;
      border: 2px solid var(--slate-500);
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.15s;
    }
    .fax-store-item.selected .fax-store-radio {
      border-color: var(--blue-400);
    }
    .fax-store-radio-inner {
      width: 10px;
      height: 10px;
      background: var(--blue-400);
      border-radius: 50%;
      opacity: 0;
      transform: scale(0);
      transition: opacity 0.15s, transform 0.15s;
    }
    .fax-store-item.selected .fax-store-radio-inner {
      opacity: 1;
      transform: scale(1);
    }
    .fax-store-info { flex: 1; }
    .fax-store-number {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--white);
    }
    .fax-store-location {
      font-size: 0.78rem;
      color: var(--slate-400);
    }
    .fax-store-check {
      color: var(--green-500);
      opacity: 0;
      transition: opacity 0.15s;
    }
    .fax-store-item.selected .fax-store-check { opacity: 1; }
    .fax-store-check svg { width: 20px; height: 20px; }

    .fax-no-results {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--slate-500);
      font-size: 0.88rem;
    }

    .fax-divider {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      color: var(--slate-500);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .fax-divider::before,
    .fax-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(74,144,196,0.15);
    }

    .fax-direct-input-wrap {
      padding: 0 1.5rem 1rem;
    }
    .fax-direct-input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 10px;
      color: var(--white);
      font-family: inherit;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .fax-direct-input::placeholder { color: var(--slate-600); }
    .fax-direct-input:focus {
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px rgba(74,144,196,0.15);
    }
    .fax-direct-hint {
      font-size: 0.75rem;
      color: var(--slate-500);
      margin-top: 0.4rem;
      padding-left: 0.25rem;
    }

    .fax-modal-footer {
      padding: 1rem 1.5rem 1.5rem;
      border-top: 1px solid rgba(74,144,196,0.12);
      flex-shrink: 0;
    }
    .fax-send-btn {
      width: 100%;
      padding: 0.9rem 1.5rem;
      background: linear-gradient(135deg, var(--blue-500) 0%, #3a7bb8 100%);
      color: var(--white);
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: background 0.2s, opacity 0.2s, transform 0.1s, box-shadow 0.2s;
      min-height: 52px;
    }
    .fax-send-btn:hover:not(:disabled) { background: linear-gradient(135deg, var(--blue-400) 0%, var(--blue-500) 100%); box-shadow: 0 4px 16px rgba(74,144,196,0.3); }
    .fax-send-btn:active:not(:disabled) { transform: scale(0.98); }
    .fax-send-btn:disabled { opacity: 0.35; cursor: not-allowed; background: var(--slate-600); }
    .fax-send-btn svg { width: 18px; height: 18px; }
    .fax-send-btn .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .fax-status {
      margin-top: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.82rem;
      text-align: center;
      display: none;
    }
    .fax-status.show { display: block; }
    .fax-status.success {
      background: rgba(34,197,94,0.1);
      color: var(--green-500);
      border: 1px solid rgba(34,197,94,0.2);
    }
    .fax-status.error {
      background: rgba(239,68,68,0.1);
      color: var(--red-500);
      border: 1px solid rgba(239,68,68,0.2);
    }
    .fax-status.info {
      background: rgba(74,144,196,0.1);
      color: var(--blue-300);
      border: 1px solid rgba(74,144,196,0.2);
    }
    .fax-status.sending {
      background: rgba(74,144,196,0.15);
      color: var(--blue-200);
      border: 1px solid rgba(74,144,196,0.3);
      animation: pulse-sending 2s ease-in-out infinite;
    }
    @keyframes pulse-sending {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .fax-status .timer {
      font-weight: 600;
      font-size: 1.1em;
      display: block;
      margin-top: 0.5rem;
    }
    .fax-status.waiting {
      background: rgba(245,158,11,0.12);
      color: #fbbf24;
      border: 1px solid rgba(245,158,11,0.25);
      animation: pulse-sending 2s ease-in-out infinite;
    }
    .fax-status.delivered {
      background: rgba(34,197,94,0.15);
      color: #4ade80;
      border: 1px solid rgba(34,197,94,0.3);
    }
    .fax-status strong {
      display: block;
      margin-bottom: 0.25rem;
    }
    .fax-status .fax-status-sub {
      display: block;
      font-size: 0.92em;
      opacity: 0.9;
    }
    .fax-status .fax-status-hint {
      display: block;
      font-size: 0.8em;
      opacity: 0.55;
      margin-top: 0.5rem;
    }
    .fax-status .fax-status-timer {
      font-weight: 600;
      font-size: 1.05em;
      display: block;
      margin-top: 0.4rem;
      opacity: 0.8;
    }

    /* Fax Trigger Card */
    .fax-trigger-card {
      background: linear-gradient(135deg, rgba(74,144,196,0.08) 0%, rgba(13,27,42,0.95) 100%);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 14px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.75rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: border-color 0.2s, transform 0.1s, box-shadow 0.2s;
    }
    .fax-trigger-card:hover {
      border-color: rgba(74,144,196,0.4);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .fax-trigger-card:active { transform: scale(0.98); }
    .fax-trigger-card[aria-disabled="true"] {
      opacity: 0.55;
      cursor: not-allowed;
      pointer-events: none;
      filter: grayscale(0.15);
    }
    .fax-trigger-icon {
      width: 48px;
      height: 48px;
      background: rgba(74,144,196,0.15);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .fax-trigger-icon svg, .fax-trigger-icon .icon-img { width: 24px; height: 24px; color: var(--blue-400); }
    .fax-trigger-content { flex: 1; }
    .fax-trigger-content h3 {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--white);
      margin-bottom: 0.25rem;
    }
    .fax-trigger-content p {
      font-size: 0.8rem;
      color: var(--slate-400);
      line-height: 1.4;
    }
    .fax-trigger-arrow {
      color: var(--slate-500);
      transition: color 0.15s, transform 0.15s;
    }
    .fax-trigger-card:hover .fax-trigger-arrow {
      color: var(--blue-400);
      transform: translateX(3px);
    }
    .fax-trigger-arrow svg { width: 20px; height: 20px; }

    /* Mobile Bottom Sheet */
    @media (max-width: 640px) {
      .fax-modal-overlay {
        align-items: flex-end;
      }
      .fax-modal {
        width: 100%;
        max-width: 100%;
        max-height: 90vh;
        border-radius: 20px 20px 0 0;
        animation: slideUpSheet 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .fax-modal-header {
        padding: 1.25rem 1.25rem 0.85rem;
        position: relative;
      }
      .fax-modal-header::before {
        content: '';
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 36px;
        height: 4px;
        background: rgba(255,255,255,0.15);
        border-radius: 2px;
      }
      .fax-modal-header h3 { font-size: 1.15rem; }
      .fax-search-wrap { padding: 0 1.25rem 0.85rem; }
      .fax-store-list { max-height: 35vh; }
      .fax-divider { padding: 0.85rem 1.25rem; }
      .fax-direct-input-wrap { padding: 0 1.25rem 0.85rem; }
      .fax-modal-footer {
        padding: 1rem 1.25rem calc(1rem + env(safe-area-inset-bottom));
      }
      .fax-trigger-card { padding: 1rem 1.15rem; gap: 0.85rem; }
      .fax-trigger-icon { width: 42px; height: 42px; }
      .fax-trigger-content h3 { font-size: 0.88rem; }
    }
    @keyframes slideUpSheet {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    /* ═══════════════════════════════════════════════════════════
       FLOATING PRINT STATUS OVERLAY
       ═══════════════════════════════════════════════════════════ */
    .print-status-overlay {
      display: none;
      position: fixed;
      bottom: calc(var(--bottom-nav-height) + 16px);
      right: 16px;
      z-index: 9999;
      width: 340px;
      max-width: calc(100vw - 32px);
      border-radius: 14px;
      background: var(--navy-900);
      border: 1px solid rgba(74,144,196,0.25);
      box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.3);
      font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
      overflow: hidden;
      transition: width 0.3s ease, height 0.3s ease, border-radius 0.3s ease, box-shadow 0.3s ease;
      animation: floatOverlayIn 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .print-status-overlay.show { display: block; }
    .print-status-overlay.minimized {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      cursor: pointer;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4), 0 0 0 2px rgba(74,144,196,0.3);
    }
    .print-status-overlay.minimized:hover {
      box-shadow: 0 4px 20px rgba(0,0,0,0.4), 0 0 0 3px rgba(74,144,196,0.5);
      transform: scale(1.05);
    }
    .print-status-overlay.minimized .pso-expanded { display: none; }
    .print-status-overlay:not(.minimized) .pso-minimized-icon { display: none; }

    @keyframes floatOverlayIn {
      from { opacity: 0; transform: translateY(24px) scale(0.92); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes floatOverlayOut {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(24px) scale(0.92); }
    }
    .print-status-overlay.closing {
      animation: floatOverlayOut 0.25s ease forwards;
    }

    /* Minimized icon (FAB) */
    .pso-minimized-icon {
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .pso-minimized-icon svg {
      width: 26px;
      height: 26px;
      color: var(--blue-400);
    }
    .pso-minimized-icon.sending svg { animation: spin 1.2s linear infinite; }
    .pso-minimized-icon.waiting svg { animation: pulse-sending 2s ease-in-out infinite; }
    .pso-minimized-icon.delivered svg { color: var(--green-500); }
    .pso-minimized-icon.error svg { color: var(--red-500); }
    .pso-minimized-icon.info svg { color: var(--blue-300); }
    .pso-notify-dot {
      display: none;
      position: absolute;
      top: 8px;
      right: 8px;
      width: 12px;
      height: 12px;
      background: var(--green-500);
      border-radius: 50%;
      border: 2px solid var(--navy-900);
      animation: notifyPulse 1.5s ease-in-out infinite;
    }
    .pso-notify-dot.show { display: block; }
    @keyframes notifyPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34,197,94,0.5); }
      50% { transform: scale(1.15); box-shadow: 0 0 0 6px rgba(34,197,94,0); }
    }

    /* Expanded overlay header (drag handle) */
    .pso-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px 8px;
      cursor: grab;
      user-select: none;
      border-bottom: 1px solid rgba(74,144,196,0.1);
    }
    .pso-header:active { cursor: grabbing; }
    .pso-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }
    .pso-header-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }
    .pso-header-icon svg { width: 20px; height: 20px; }
    .pso-header-title {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--white);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pso-header-actions {
      display: flex;
      align-items: center;
      gap: 2px;
      flex-shrink: 0;
    }
    .pso-action-btn {
      background: none;
      border: none;
      color: var(--slate-400);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: color 0.15s, background 0.15s;
    }
    .pso-action-btn:hover { color: var(--slate-200); background: rgba(255,255,255,0.06); }
    .pso-action-btn svg { width: 16px; height: 16px; }

    /* Status body */
    .pso-body {
      padding: 12px;
    }
    .pso-status-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .pso-status-icon {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .pso-status-icon svg { width: 18px; height: 18px; }
    .pso-status-icon.sending { background: rgba(74,144,196,0.15); color: var(--blue-400); }
    .pso-status-icon.sending svg { animation: spin 1.2s linear infinite; }
    .pso-status-icon.waiting { background: rgba(245,158,11,0.12); color: #fbbf24; }
    .pso-status-icon.delivered { background: rgba(34,197,94,0.12); color: var(--green-500); }
    .pso-status-icon.error { background: rgba(239,68,68,0.1); color: var(--red-500); }
    .pso-status-icon.info { background: rgba(74,144,196,0.12); color: var(--blue-300); }

    .pso-status-text { flex: 1; min-width: 0; }
    .pso-status-title {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--white);
      line-height: 1.3;
    }
    .pso-status-sub {
      font-size: 0.75rem;
      color: var(--slate-400);
      line-height: 1.4;
      margin-top: 2px;
    }
    .pso-status-timer {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--slate-500);
      margin-top: 4px;
      display: block;
    }

    /* Delivered glow effect */
    .print-status-overlay.delivered-glow {
      border-color: rgba(34,197,94,0.4);
      box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 20px rgba(34,197,94,0.15);
    }
    .print-status-overlay.error-glow {
      border-color: rgba(239,68,68,0.4);
      box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 20px rgba(239,68,68,0.15);
    }

    /* Mobile adjustments */
    @media (max-width: 640px) {
      .print-status-overlay {
        width: 300px;
        right: 10px;
        bottom: calc(var(--bottom-nav-height) + 10px);
      }
      .print-status-overlay.minimized {
        width: 50px;
        height: 50px;
      }
      .pso-minimized-icon {
        width: 50px;
        height: 50px;
      }
    }

    /* ═══════ MOBILE ═══════ */
    @media (max-width: 640px) {
      body { -webkit-tap-highlight-color: transparent; }
      .app-toolbar {
        padding: 0.4rem max(0.5rem, env(safe-area-inset-left)) 0.4rem max(0.5rem, env(safe-area-inset-right));
        padding-left: calc(max(0.5rem, env(safe-area-inset-left)) + var(--menu-btn-size) + 8px);
      }
      .header {
        padding: 1.6rem 1rem;
        padding-top: max(1.6rem, env(safe-area-inset-top));
        padding-left: calc(1rem + var(--menu-btn-size) + 0.75rem);
        padding-right: calc(1rem + var(--menu-btn-size) + 0.75rem);
      }
      .header-logo { max-height: 44px; }
      .header h1 { font-size: 1.25rem; }
      .container { padding: 1.25rem 0.85rem calc(3.25rem + var(--bottom-nav-height)); }

      .download-card, .option-card { padding: 1.1rem; gap: 0.75rem; flex-wrap: wrap; }
      .download-icon { width: 42px; height: 42px; }
      .download-info h3 { font-size: 0.85rem; }
      .download-btn { font-size: 0.8rem; padding: 0.5rem 0.9rem; }

      .card { padding: 1.5rem 1.15rem; border-radius: 12px; }
      .card h2 { font-size: 1.15rem; }
      .ack-text { font-size: 0.85rem; line-height: 1.8; }

      .form-row input[type="text"],
      .form-row input[type="date"] {
        padding: 0.85rem 0.95rem;
        font-size: 1rem; /* 16px prevents iOS zoom on focus */
        min-height: 52px;
        border-radius: 10px;
      }
      .form-row label { margin-bottom: 0.5rem; }
      .consent-row { padding: 0.85rem; }
      .consent-row input[type="checkbox"] { width: 24px; height: 24px; }
      .sig-canvas { height: 160px; }
      .sig-toggle { gap: 0.5rem; }
      .sig-option { min-height: 48px; }
      .sig-option svg { width: 24px; height: 24px; }
      .sig-color { width: 38px; height: 38px; }
      .consent-row label { font-size: 0.82rem; }
      .submit-btn { padding: 0.9rem 1.5rem; font-size: 0.95rem; }

      .save-card { padding: 2rem 1.25rem; width: 95%; max-height: 90vh; overflow-y: auto; }
      .save-card h3 { font-size: 1.15rem; }
      .save-btn { padding: 0.9rem 1rem; font-size: 0.9rem; min-height: 48px; }
      .save-btn.done { min-height: 40px; }
    }

    @media (max-width: 380px) {
      .header {
        padding: 1.3rem 0.75rem;
        padding-left: calc(0.75rem + var(--menu-btn-size) + 0.75rem);
        padding-right: calc(0.75rem + var(--menu-btn-size) + 0.75rem);
      }
      .header-logo { max-height: 36px; }
      .container { padding: 1rem 0.5rem calc(2.7rem + var(--bottom-nav-height)); }
      .card { padding: 1.15rem 0.8rem; }
      .download-card, .option-card { flex-direction: column; text-align: left; }
      .sig-toggle { grid-template-columns: repeat(3, 1fr); gap: 0.4rem; }
      .sig-row { padding: 0.75rem; }
      .consent-row { padding: 0.75rem; gap: 0.7rem; }
    }

    button, a, input[type="checkbox"], select, .fax-store-item, .fax-trigger-card { touch-action: manipulation; }
    input[type="text"], input[type="date"], input[type="tel"], select { appearance: none; -webkit-appearance: none; }
    /* Prevent pull-to-refresh interference with signature drawing */
    .sig-canvas { overscroll-behavior: none; }
    /* Smooth focus scroll on mobile */
    @supports (scroll-padding-bottom: 1px) {
      html { scroll-padding-bottom: calc(var(--bottom-nav-height) + 1rem); }
    }
  </style>
</head>
<body>

  <button class="app-menu-button" id="appMenuButton" onclick="toggleAppMenu()" aria-label="Open app menu" title="Menu">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M3.75 17.25h16.5"/></svg>
  </button>
  <div class="app-menu-backdrop" id="appMenuBackdrop" onclick="closeAppMenu()"></div>
  <div class="app-menu-panel" id="appMenuPanel" role="dialog" aria-label="App menu">
    <div class="app-menu-header">
      Quick Menu
      <button class="app-menu-close" onclick="closeAppMenu()" title="Close menu">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="app-menu-section">
      <div class="app-menu-title">Navigation</div>
      <button class="app-menu-item" onclick="goHome(); closeAppMenu();">
        Home / Contents
      </button>
      <button class="app-menu-item" onclick="goSearch(); closeAppMenu();">
        Search Handbook
      </button>
      <button class="app-menu-item" onclick="goHandbook(); closeAppMenu();">
        Handbook Reader
      </button>
      <button class="app-menu-item" onclick="goSupplements(); closeAppMenu();">
        State Supplements
      </button>
      <button class="app-menu-item" onclick="goSign(); closeAppMenu();">
        Sign Acknowledgement
      </button>
    </div>
  </div>

  <div class="app-toolbar" role="banner">
    <img src="employeeHandbook/Logos/banner.png" alt="Retail Odyssey" class="toolbar-logo" onclick="goHome()" title="Back to Contents">
    <div class="toolbar-divider"></div>
    <div class="toolbar-spacer"></div>
    <button class="toolbar-btn" type="button" onclick="goHome()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 20v2h14v-2h-2v-6.086l-.707.707L12 19.293l-4.293-4.293-.707-.707V20H5z" fill="#A93226"/><path d="M13 3.707l8 8 .707.707-1.414 1.414-.707-.707L12 5.121 4.414 12.707l-.707.707-1.414-1.414.707-.707 8-8 .707-.707.707.707z" fill="#A93226"/><path d="M4 20h16v-8h2l-10-9-10 9h2v8z" fill="#E74C3C"/><path d="M12 3L2 12h3v8h14v-8h3L12 3z" fill="#F1948A"/></svg>
      <span class="btn-label">Home</span>
    </button>
    <button class="toolbar-btn" type="button" onclick="goSearch()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#B7950B"/></g><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#F1C40F"/></svg>
      <span class="btn-label">Search</span>
    </button>
    <button class="toolbar-btn" type="button" onclick="goHandbook()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1.5, 1.5)"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zM6.5 18c-1.65 0-3.35.3-4.75 1.05V7.5C3.1 6.75 5.05 6.5 6.5 6.5c1.95 0 4.05.4 5.5 1.5v11.5c-1.45-1.1-3.55-1.5-5.5-1.5z" fill="#117A65"/></g><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zM6.5 18c-1.65 0-3.35.3-4.75 1.05V7.5C3.1 6.75 5.05 6.5 6.5 6.5c1.95 0 4.05.4 5.5 1.5v11.5c-1.45-1.1-3.55-1.5-5.5-1.5z" fill="#2ECC71"/></svg>
      <span class="btn-label">Handbook</span>
    </button>
    <button class="toolbar-btn" type="button" onclick="goSupplements()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M2 12l2-3 4 1 2-3 5-1 4 3 1 2 2 7-6 1-3 3H8l-3-5-3-1v-4z" fill="#5B2C6F"/></g><path d="M2 12l2-3 4 1 2-3 5-1 4 3 1 2 2 7-6 1-3 3H8l-3-5-3-1v-4z" fill="#9B59B6"/></svg>
      <span class="btn-label">Supplements</span>
    </button>
    <button class="toolbar-btn ack-btn" type="button" onclick="goSign()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M15.5 5.5L13 8 6 15l-1 3 3-1 7-7 2.5-2.5-2-2zm-2 2l1.5 1.5" fill="#C2185B"/><path d="M2 18c2.5-2 4.5-4 7.5-4 3.5 0 5.5 4 9.5 4" stroke="#C2185B" stroke-width="3" stroke-linecap="round"/></g><path d="M15.5 5.5L13 8 6 15l-1 3 3-1 7-7 2.5-2.5-2-2zm-2 2l1.5 1.5" fill="#E91E63"/><path d="M2 18c2.5-2 4.5-4 7.5-4 3.5 0 5.5 4 9.5 4" stroke="#E91E63" stroke-width="3" stroke-linecap="round"/></svg>
      <span class="btn-label">Sign</span>
    </button>
  </div>

  <div class="page-shell">
    <header class="header">
      <div class="header-inner">
        <img src="employeeHandbook/Logos/banner.png" alt="The Retail Odyssey Company" class="header-logo">
        <h1>Teammate Handbook Acknowledgement</h1>
        <p>
          <span class="header-sub">Current version revised February 2025</span>
          <span class="header-sub">Review, accept, and sign.</span>
        </p>
      </div>
    </header>

    <main class="container">
    <section class="card">
      <h2>Acknowledgement of Receipt</h2>
      <div class="ack-text">
        <p>I have received a copy of the Company's Handbook and the applicable Supplement(s) for the locations in which I work. I agree to read it and to comply with the policies and procedures described in the Handbook and Supplement(s). If I have any questions regarding any of the Handbook's provisions, I will consult with my supervisor, manager or Human Resources. I understand that if I do not follow the policies and procedures contained herein that I may be subject to disciplinary action, up to and including termination of employment.</p>
        <p>I also understand that this Handbook is the most up-to-date version of the Company's policies and procedures and replaces any prior written and oral communications about the subjects contained in it.</p>
        <p>I acknowledge that my employment relationship with the Company is "at-will", meaning that, regardless of anything contained in this Handbook and regardless of any custom or practice, either I or the Company may terminate my employment at any time, for any reason or no reason, with or without cause, and with or without procedural requirements. I understand that no representatives of the Company, other than the CEO in a writing signed by him/her/them, may enter into any agreements, or make any representations, written or oral, to alter my at-will status or otherwise create any contractual obligation between me and the Company.</p>
        <p>I further acknowledge that this handbook and the policies contained herein are not intended to create (and shall not be construed as creating) a contract (express or implied) for employment between the Company and any Teammate and that said policies can be modified by the Company at any time, with or without notice to me, in its sole and absolute discretion.</p>
        <p>By signing below, I acknowledge that I have received and will abide by the Company's Handbook and all the policies within it, including those on harassment, discrimination, retaliation, and bringing complaints regarding the same.</p>
      </div>
    </section>

    <section class="card">
      <h2>Sign Below</h2>
      <div class="form-row" id="nameRow">
        <label for="printedName">Printed Teammate Name</label>
        <input type="text" id="printedName" placeholder="Enter your full legal name" autocomplete="name">
        <div class="error-msg">Please enter your full name.</div>
      </div>
      <div class="form-row" id="sigRow">
        <label>Teammate Signature</label>
        <div class="sig-controls">
          <div class="sig-toggle">
            <button type="button" class="sig-option active" data-mode="draw" aria-label="Draw signature" title="Draw signature" onclick="setSignatureMode('draw')">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487 19.5 7.125m-2.638-2.638L7.5 13.849l-1.5 4.651 4.651-1.5 9.362-9.363a1.875 1.875 0 0 0-2.651-2.651Z"/></svg>
            </button>
            <button type="button" class="sig-option" data-mode="type" aria-label="Type signature" title="Type signature" onclick="setSignatureMode('type')">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 4.5h9m-9 4.5h6M4.5 6h15a1.5 1.5 0 0 1 1.5 1.5v9a1.5 1.5 0 0 1-1.5 1.5h-15A1.5 1.5 0 0 1 3 16.5v-9A1.5 1.5 0 0 1 4.5 6Z"/></svg>
            </button>
            <button type="button" class="sig-option" data-mode="upload" aria-label="Upload signature" title="Upload signature" onclick="setSignatureMode('upload')">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V6m0 0-3.75 3.75M12 6l3.75 3.75M4.5 16.5v2.25A2.25 2.25 0 0 0 6.75 21h10.5A2.25 2.25 0 0 0 19.5 18.75V16.5"/></svg>
            </button>
          </div>
          <div class="sig-row" id="drawControls">
            <button type="button" class="sig-action-btn" id="signNowBtn" onclick="enableSignaturePad()">Sign Now</button>
            <div class="sig-ink">
              <label>Ink</label>
              <button type="button" class="sig-color active" id="inkBlack" title="Black ink" style="background:#0f172a;" onclick="setInkColor('#0f172a')"></button>
              <button type="button" class="sig-color" id="inkBlue" title="Blue ink" style="background:#1d4ed8;" onclick="setInkColor('#1d4ed8')"></button>
            </div>
            <div class="sig-size">
              <label for="penSize">Point</label>
              <input type="range" id="penSize" min="1" max="6" step="0.5" value="2">
            </div>
          </div>
          <div class="sig-row sig-hidden" id="typeControls">
            <div class="sig-typed-controls">
              <label for="typedSignature">Type Your Signature</label>
              <input type="text" id="typedSignature" placeholder="Enter your full signature">
            </div>
            <div class="sig-typed-controls">
              <label for="typedFont">Signature Font</label>
              <select id="typedFont">
                <option value="'Dancing Script', cursive">Dancing Script</option>
                <option value="'Great Vibes', cursive">Great Vibes</option>
                <option value="'Pacifico', cursive">Pacifico</option>
              </select>
            </div>
            <button type="button" class="sig-action-btn secondary" onclick="applyTypedSignature()">Apply Signature</button>
          </div>
          <div class="sig-row sig-hidden" id="uploadControls">
            <div>
              <label>Upload Signature Image</label>
              <div class="sig-hint">PNG or JPG works best with a transparent or light background.</div>
            </div>
            <button type="button" class="sig-action-btn" onclick="triggerSignatureUpload()">Choose Image</button>
          </div>
          <div class="sig-row sig-hidden" id="faxControls">
            <div class="sig-typed-controls">
              <label for="faxStore">Select Fred Meyer Store</label>
              <select id="faxStore">
                <option value="">Choose a store number</option>
              </select>
            </div>
            <div class="sig-typed-controls">
              <label for="faxNumber">Printer Number</label>
              <input type="text" id="faxNumber" placeholder="+1 555 555 5555">
            </div>
            <div class="sig-hint">We will route your acknowledgement to your selected store's printer.</div>
            <div class="sig-hint">To send to any printer, enter the full number including country code.</div>
          </div>
          <div class="sig-row sig-hidden" id="scanControls">
            <div class="scan-panel">
              <div class="scan-actions">
                <button type="button" class="sig-action-btn" onclick="triggerScanCapture()">Capture Photo</button>
                <button type="button" class="sig-action-btn secondary" onclick="autoEnhanceScan()">Auto Enhance</button>
                <button type="button" class="sig-action-btn secondary" onclick="applyScanCrop()">Apply Crop</button>
                <button type="button" class="sig-action-btn secondary" onclick="resetScan()">Retake</button>
              </div>
              <div class="scan-canvas-wrap" id="scanWrap">
                <canvas id="scanCanvas"></canvas>
                <div class="scan-overlay" id="scanOverlay"></div>
                <div class="scan-handle" data-handle="tl"></div>
                <div class="scan-handle" data-handle="tr"></div>
                <div class="scan-handle" data-handle="br"></div>
                <div class="scan-handle" data-handle="bl"></div>
              </div>
              <div class="sig-hint">Drag the corner points to crop and straighten. Tap “Apply Crop” to save the refined scan.</div>
            </div>
          </div>
        </div>
        <div class="sig-container">
          <canvas id="sigCanvas" class="sig-canvas"></canvas>
          <div class="sig-line"></div>
          <span id="sigPlaceholder" class="sig-placeholder">Sign here using your mouse or finger</span>
          <button type="button" id="sigSave" class="sig-save" onclick="saveSignature()">Save</button>
          <button type="button" id="sigClear" class="sig-clear" onclick="clearSignature()">Clear</button>
        </div>
        <div class="sig-hint" id="orientationHint">Tip: rotate your device for more signing space.</div>
        <div class="error-msg" id="sigError">Please provide your signature above.</div>
      </div>
      <div class="form-grid">
        <div class="form-row" id="dateRow">
          <label for="signDate">Date</label>
          <input type="date" id="signDate">
          <div class="error-msg">Please select today's date.</div>
        </div>
      </div>
      <div class="consent-row">
        <input type="checkbox" id="digiConsent">
        <label for="digiConsent" id="consentLabel">By checking this box, I agree that my digital signature captured on this device (or uploaded signature image) is applied to this acknowledgement and is the legal equivalent of my handwritten signature. I confirm I have <strong>reviewed the ADV Teammate Handbook and my State Supplement</strong> and understand the policies and procedures described within them.</label>
      </div>
      <button type="button" class="submit-btn" id="submitBtn" disabled onclick="handleSubmit()">Submit Acknowledgement</button>
    </section>

    <!-- Fax Blank Form Trigger Card -->
    <div class="fax-trigger-card" onclick="openFaxModal('blank')" role="button" tabindex="0">
      <div class="fax-trigger-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z"/></svg>
      </div>
      <div class="fax-trigger-content">
        <h3>Print Blank Form at Your Store</h3>
        <p>Print a blank acknowledgement form at your store for manual signing.</p>
      </div>
      <div class="fax-trigger-arrow">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"/></svg>
      </div>
    </div>

    <!-- Fax Signed Copy Trigger Card -->
    <div class="fax-trigger-card" id="faxSignedTrigger" onclick="openFaxModal('signed')" role="button" tabindex="0" aria-disabled="true">
      <div class="fax-trigger-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375H7.875A3.375 3.375 0 0 0 4.5 11.625V14.25m15 0a2.25 2.25 0 0 1 2.25 2.25v.75a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3v-.75a2.25 2.25 0 0 1 2.25-2.25m15 0V9.375c0-.621-.504-1.125-1.125-1.125h-9.75c-.621 0-1.125.504-1.125 1.125V14.25m12.75 0h-9.75"/><path stroke-linecap="round" stroke-linejoin="round" d="M9 18.75h6"/></svg>
      </div>
      <div class="fax-trigger-content">
        <h3>Print Signed Copy at Your Store</h3>
        <p>Print a copy of your signed acknowledgement for your records.</p>
      </div>
      <div class="fax-trigger-arrow">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"/></svg>
      </div>
    </div>

    <section class="alternate-options">
      <div class="alternate-label">Alternate Options</div>

      <details class="option-card option-dropdown">
        <summary>
          <div class="download-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6.827 6.175 1.1-1.1a1.5 1.5 0 0 1 2.122 0l1.1 1.1h2.851a1.5 1.5 0 0 1 1.5 1.5v8.85a1.5 1.5 0 0 1-1.5 1.5H6.55a1.5 1.5 0 0 1-1.5-1.5v-8.85a1.5 1.5 0 0 1 1.5-1.5h1.277Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5Z"/></svg>
          </div>
          <div class="option-summary">
            <h3>Scan Signed Document</h3>
            <p>Use your camera to scan the signed acknowledgement and submit the enhanced image.</p>
          </div>
          <svg class="option-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6 9 6 6 6-6"/></svg>
        </summary>
        <div class="option-dropdown-body">
          <div class="option-actions">
            <button type="button" class="option-btn" onclick="setSignatureMode('scan'); document.getElementById('sigRow').scrollIntoView({ behavior: 'smooth' });">Start Scan</button>
          </div>
        </div>
      </details>
    </section>
    </main>

    <footer class="footer">&copy; 2026 Advantage Solutions Inc. &nbsp;·&nbsp; All rights reserved.</footer>
  </div>

  <div class="home-bottom-nav" aria-label="Handbook navigation">
    <button class="toolbar-btn" type="button" onclick="goHome()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 20v2h14v-2h-2v-6.086l-.707.707L12 19.293l-4.293-4.293-.707-.707V20H5z" fill="#A93226"/><path d="M13 3.707l8 8 .707.707-1.414 1.414-.707-.707L12 5.121 4.414 12.707l-.707.707-1.414-1.414.707-.707 8-8 .707-.707.707.707z" fill="#A93226"/><path d="M4 20h16v-8h2l-10-9-10 9h2v8z" fill="#E74C3C"/><path d="M12 3L2 12h3v8h14v-8h3L12 3z" fill="#F1948A"/></svg>
      <span class="btn-label">Home</span>
    </button>
    <button class="toolbar-btn" type="button" onclick="goSearch()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#B7950B"/></g><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#F1C40F"/></svg>
      <span class="btn-label">Search</span>
    </button>
    <button class="toolbar-btn" type="button" onclick="goHandbook()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1.5, 1.5)"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zM6.5 18c-1.65 0-3.35.3-4.75 1.05V7.5C3.1 6.75 5.05 6.5 6.5 6.5c1.95 0 4.05.4 5.5 1.5v11.5c-1.45-1.1-3.55-1.5-5.5-1.5z" fill="#117A65"/></g><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zM6.5 18c-1.65 0-3.35.3-4.75 1.05V7.5C3.1 6.75 5.05 6.5 6.5 6.5c1.95 0 4.05.4 5.5 1.5v11.5c-1.45-1.1-3.55-1.5-5.5-1.5z" fill="#2ECC71"/></svg>
      <span class="btn-label">Handbook</span>
    </button>
    <button class="toolbar-btn" type="button" onclick="goSupplements()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M2 12l2-3 4 1 2-3 5-1 4 3 1 2 2 7-6 1-3 3H8l-3-5-3-1v-4z" fill="#5B2C6F"/></g><path d="M2 12l2-3 4 1 2-3 5-1 4 3 1 2 2 7-6 1-3 3H8l-3-5-3-1v-4z" fill="#9B59B6"/></svg>
      <span class="btn-label">Supplements</span>
    </button>
    <button class="toolbar-btn ack-btn" type="button" onclick="goSign()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="translate(1, 1)"><path d="M15.5 5.5L13 8 6 15l-1 3 3-1 7-7 2.5-2.5-2-2zm-2 2l1.5 1.5" fill="#C2185B"/><path d="M2 18c2.5-2 4.5-4 7.5-4 3.5 0 5.5 4 9.5 4" stroke="#C2185B" stroke-width="3" stroke-linecap="round"/></g><path d="M15.5 5.5L13 8 6 15l-1 3 3-1 7-7 2.5-2.5-2-2zm-2 2l1.5 1.5" fill="#E91E63"/><path d="M2 18c2.5-2 4.5-4 7.5-4 3.5 0 5.5 4 9.5 4" stroke="#E91E63" stroke-width="3" stroke-linecap="round"/></svg>
      <span class="btn-label">Sign</span>
    </button>
  </div>

  <input type="file" id="hiddenFileInput" accept=".pdf">
  <input type="file" id="sigFileInput" accept="image/*">
  <input type="file" id="scanFileInput" accept="image/*" capture="environment">

  <div class="save-overlay" id="saveOverlay">
    <div class="save-card">
      <div class="save-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5"/></svg>
      </div>
      <h3>Acknowledgement Signed</h3>
      <p>Your signed acknowledgement PDF is ready. Choose how to save it.</p>
      <div class="signer-detail" id="signerDetail"></div>
      <div class="cloud-save-status" id="cloudSaveStatus"></div>
      <div class="save-buttons">
        <button class="save-btn onedrive" id="onedriveSaveBtn" onclick="saveToOneDrive()">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.39 4.19c1.66-.89 3.73-.78 5.28.32a5.17 5.17 0 0 1 2.2 3.54 4.38 4.38 0 0 1 2.67 1.81 4.34 4.34 0 0 1 .72 3.1 4.36 4.36 0 0 1-1.67 2.85 4.4 4.4 0 0 1-3.14.94H6.13a5.07 5.07 0 0 1-3.55-1.38A4.91 4.91 0 0 1 1.1 12a4.94 4.94 0 0 1 2.1-3.07 5.03 5.03 0 0 1 3.56-.85c.54-1.71 1.78-3.07 3.43-3.59a5.89 5.89 0 0 1 2.2-.3Z"/></svg>
          Save to OneDrive
        </button>
        <div class="onedrive-status" id="onedriveStatus"></div>
        <button class="save-btn download" id="downloadBtn" onclick="downloadPDF()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
          Download PDF to Device
        </button>
        <button class="save-btn download" onclick="printLocally()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z"/></svg>
          Print on This Device
        </button>
        <button class="save-btn download" onclick="openFaxModal('signed')">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/></svg>
          Print Signed Copy at Store
        </button>
        <button class="save-btn done" onclick="closeSaveOverlay()">Close</button>
      </div>
    </div>
  </div>

  <!-- Fax Modal -->
  <div class="fax-modal-overlay" id="faxModalOverlay" onclick="closeFaxModalOnBackdrop(event)">
    <div class="fax-modal" onclick="event.stopPropagation()">
      <div class="fax-modal-header">
        <h3 id="faxModalTitle">Print at Store</h3>
        <p id="faxModalSubtitle">Select a store to print the acknowledgement form.</p>
        <button class="fax-modal-close" onclick="closeFaxModal()" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <div class="fax-search-wrap">
        <div class="fax-search-container">
          <span class="fax-search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/></svg>
          </span>
          <input type="text" class="fax-search" id="faxStoreSearch" placeholder="Search by store number or city..." oninput="filterFaxStores()">
        </div>
      </div>

      <div class="fax-store-list" id="faxStoreList">
        <!-- Store items rendered by JS -->
      </div>

      <div class="fax-divider">Or enter printer number</div>

      <div class="fax-direct-input-wrap">
        <input type="tel" class="fax-direct-input" id="faxDirectNumber" placeholder="1 555 555 5555" oninput="onDirectFaxInput()">
        <div class="fax-direct-hint">Enter the full printer number including area code</div>
      </div>

      <div class="fax-modal-footer">
        <button class="fax-send-btn" id="faxSendBtn" onclick="sendFax()" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/></svg>
          <span id="faxSendBtnText">Send to Printer</span>
        </button>
        <div class="fax-status" id="faxStatus"></div>
      </div>
    </div>
  </div>

  <!-- Floating Print Status Overlay -->
  <div class="print-status-overlay" id="printStatusOverlay">
    <!-- Minimized FAB icon -->
    <div class="pso-minimized-icon" id="psoMinIcon" onclick="expandPrintOverlay()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z"/></svg>
      <div class="pso-notify-dot" id="psoNotifyDot"></div>
    </div>
    <!-- Expanded content -->
    <div class="pso-expanded">
      <div class="pso-header" id="psoHeader">
        <div class="pso-header-left">
          <div class="pso-header-icon" id="psoHeaderIcon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z"/></svg>
          </div>
          <span class="pso-header-title" id="psoHeaderTitle">Print Job</span>
        </div>
        <div class="pso-header-actions">
          <button class="pso-action-btn" onclick="minimizePrintOverlay()" title="Minimize">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15"/></svg>
          </button>
          <button class="pso-action-btn" onclick="dismissPrintOverlay()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>
      <div class="pso-body">
        <div class="pso-status-row">
          <div class="pso-status-icon sending" id="psoStatusIcon">
            <svg id="psoSpinnerSvg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.992 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182"/></svg>
          </div>
          <div class="pso-status-text">
            <div class="pso-status-title" id="psoStatusTitle">Sending to printer...</div>
            <div class="pso-status-sub" id="psoStatusSub">Please wait while we connect to the print server.</div>
            <span class="pso-status-timer" id="psoStatusTimer"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Read config from config.js (loaded in <head>)
    const _cfg = (typeof APP_CONFIG !== 'undefined') ? APP_CONFIG : {};
    const ONEDRIVE_CLIENT_ID = _cfg.ONEDRIVE_CLIENT_ID || '';

    // Optional: swap logos/backgrounds from local handbook assets server.
    const HANDBOOK_ASSET_BASE = 'employeeHandbook';
    function pickLogoPath(paths, kind) {
      const list = Array.isArray(paths) ? paths : [];
      if (!list.length) return '';
      const lc = list.map(p => ({ p, l: String(p).toLowerCase() }));
      const byHint = (hint) => lc.find(x => x.l.includes(hint))?.p || '';
      if (kind === 'header') {
        return byHint('banner') || byHint('header') || byHint('headliner') || byHint('logo') || list[0];
      }
      return byHint('watermark') || byHint('background') || byHint('pattern') || list[list.length - 1];
    }

    function pickIconPath(paths, hints) {
      const list = Array.isArray(paths) ? paths : [];
      if (!list.length) return '';
      const lc = list.map(p => ({ p, l: String(p).toLowerCase() }));
      for (const h of (hints || [])) {
        const hit = lc.find(x => x.l.includes(String(h).toLowerCase()));
        if (hit?.p) return hit.p;
      }
      return '';
    }

    function replaceButtonIcon(btn, url) {
      if (!btn || !url) return;
      const svg = btn.querySelector('svg');
      let img = btn.querySelector('img.icon-img');
      if (!img) {
        img = document.createElement('img');
        img.className = 'icon-img';
        img.alt = '';
        img.loading = 'lazy';
        if (svg) {
          svg.style.display = 'none';
          btn.insertBefore(img, svg);
        } else {
          btn.insertBefore(img, btn.firstChild);
        }
      }
      img.src = url;
    }

    function replaceContainerIcon(container, url) {
      if (!container || !url) return;
      const svg = container.querySelector('svg');
      let img = container.querySelector('img.icon-img');
      if (!img) {
        img = document.createElement('img');
        img.className = 'icon-img';
        img.alt = '';
        img.loading = 'lazy';
        if (svg) {
          svg.style.display = 'none';
          container.insertBefore(img, svg);
        } else {
          container.insertBefore(img, container.firstChild);
        }
      }
      img.src = url;
    }

    async function applyBrandingFromHandbookAssets() {
      try {
        const res = await fetch(`${HANDBOOK_ASSET_BASE}/manifest.json`, { cache: 'no-store' });
        if (!res.ok) return;
        const manifest = await res.json();
        const logos = manifest?.logos || [];
        const icons = manifest?.icons || [];

        if (Array.isArray(logos) && logos.length) {
          const headerLogoPath = pickLogoPath(logos, 'header');
          const bgLogoPath = pickLogoPath(logos, 'background');
          if (headerLogoPath) {
            const headerUrl = `${HANDBOOK_ASSET_BASE}/${headerLogoPath}`;
            document.querySelectorAll('img.header-logo, img.toolbar-logo').forEach(img => {
              try { img.src = headerUrl; } catch (e) { /* ignore */ }
            });
          }
          if (bgLogoPath) {
            const bgUrl = `${HANDBOOK_ASSET_BASE}/${bgLogoPath}`;
            document.documentElement.style.setProperty('--watermark-logo', `url('${bgUrl}')`);
          }
        }

        if (Array.isArray(icons) && icons.length) {
          const home = pickIconPath(icons, ['home']);
          const search = pickIconPath(icons, ['search', 'magnify']);
          const handbook = pickIconPath(icons, ['handbook', 'book', 'reader']);
          const supplements = pickIconPath(icons, ['supplement', 'state', 'map', 'usa']);
          const sign = pickIconPath(icons, ['sign', 'signature', 'pen', 'pencil']);
          const menu = pickIconPath(icons, ['menu.png', '/menu.', 'menu', 'hamburger', 'bars']);
          const printer = pickIconPath(icons, ['printer', 'print']);

          const url = (p) => p ? `${HANDBOOK_ASSET_BASE}/${p}` : '';
          document.querySelectorAll('.app-toolbar .toolbar-btn, .home-bottom-nav .toolbar-btn').forEach(btn => {
            const oc = (btn.getAttribute('onclick') || '').toLowerCase();
            if (oc.includes('gohome') && home) replaceButtonIcon(btn, url(home));
            else if (oc.includes('gosearch') && search) replaceButtonIcon(btn, url(search));
            else if (oc.includes('gohandbook') && handbook) replaceButtonIcon(btn, url(handbook));
            else if (oc.includes('gosupplements') && supplements) replaceButtonIcon(btn, url(supplements));
            else if (oc.includes('gosign') && sign) replaceButtonIcon(btn, url(sign));
          });
          if (menu) {
            const menuBtn = document.getElementById('appMenuButton');
            if (menuBtn) replaceButtonIcon(menuBtn, url(menu));
          }

          if (printer) {
            // Replace printer icon in the two fax trigger cards
            document.querySelectorAll('.fax-trigger-icon').forEach(iconWrap => {
              replaceContainerIcon(iconWrap, url(printer));
            });
          }
        }
      } catch (e) { /* ignore */ }
    }
    applyBrandingFromHandbookAssets();

    function returnToHandbook(e) {
      if (e) e.preventDefault();
      const lastPage = localStorage.getItem('handbookLastPage');
      const lastView = localStorage.getItem('handbookLastView');
      const url = lastView === 'reader' && lastPage ? `index.html#page=${lastPage}` : 'index.html';
      window.location.href = url;
    }

    function goHome() {
      window.location.href = 'index.html';
    }

    function goSearch() {
      window.location.href = 'index.html#search';
    }

    function goHandbook() {
      returnToHandbook();
    }

    function goSupplements() {
      window.location.href = 'index.html#supplements';
    }

    function goSign() {
      window.location.href = 'acknowledgement.html';
    }

    function toggleAppMenu() {
      const panel = document.getElementById('appMenuPanel');
      const backdrop = document.getElementById('appMenuBackdrop');
      const button = document.getElementById('appMenuButton');
      const isOpen = panel.classList.contains('show');
      if (isOpen) {
        closeAppMenu();
        return;
      }
      panel.classList.add('show');
      backdrop.classList.add('show');
      button.classList.add('active');
    }

    function closeAppMenu() {
      const panel = document.getElementById('appMenuPanel');
      const backdrop = document.getElementById('appMenuBackdrop');
      const button = document.getElementById('appMenuButton');
      panel.classList.remove('show');
      backdrop.classList.remove('show');
      button.classList.remove('active');
    }

    /* ═══════════════════════════════════════════════════════════
       SIGNATURE PAD
       ═══════════════════════════════════════════════════════════ */
    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    const placeholder = document.getElementById('sigPlaceholder');
    const clearBtn = document.getElementById('sigClear');
    const saveBtn = document.getElementById('sigSave');
    const signNowBtn = document.getElementById('signNowBtn');
    const orientationHint = document.getElementById('orientationHint');
    const penSizeInput = document.getElementById('penSize');
    const typedInput = document.getElementById('typedSignature');
    const typedFont = document.getElementById('typedFont');
    const sigFileInput = document.getElementById('sigFileInput');
    const faxStore = document.getElementById('faxStore');
    const faxNumber = document.getElementById('faxNumber');
    const blankFaxStore = document.getElementById('blankFaxStore');
    const blankFaxNumber = document.getElementById('blankFaxNumber');
    const signedFaxStore = document.getElementById('signedFaxStore');
    const signedFaxNumber = document.getElementById('signedFaxNumber');
    const consentLabel = document.getElementById('consentLabel');
    const scanFileInput = document.getElementById('scanFileInput');
    const scanCanvas = document.getElementById('scanCanvas');
    const scanCtx = scanCanvas.getContext('2d');
    const scanWrap = document.getElementById('scanWrap');
    const scanOverlay = document.getElementById('scanOverlay');
    const scanHandles = Array.from(document.querySelectorAll('.scan-handle'));

    // ═══════════════════════════════════════════════════════════
    // FAX CONFIGURATION (loaded from config.js)
    // ═══════════════════════════════════════════════════════════
    const FUNCTIONS_BASE = _cfg.FUNCTIONS_BASE || '';

    const FIREBASE_CONFIG = {
      apiKey: _cfg.FIREBASE_API_KEY || '',
      projectId: _cfg.FIREBASE_PROJECT_ID || ''
    };

    // Initialize Firebase Firestore (only if API key is configured)
    let firestore = null;
    if (FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.apiKey !== 'YOUR_FIREBASE_API_KEY') {
      try {
        firebase.initializeApp(FIREBASE_CONFIG);
        firestore = firebase.firestore();
        console.log('Firebase Firestore initialized for real-time fax status tracking');
      } catch (e) {
        console.warn('Firebase initialization failed:', e.message);
      }
    } else {
      console.log('Firebase not configured — fax status tracking disabled. Set FIREBASE_API_KEY in config.js to enable.');
    }

    // Embedded store data for instant dropdown load (no network call needed)
    // Format: n = storeNumber, l = location, f = faxNumber
    const STORES = [
      {n:"#005",l:"Albany",f:"15419243633"},
      {n:"#011",l:"Northern Lights",f:"19072587894"},
      {n:"#013",l:"Midtown Anchorage",f:"19072778541"},
      {n:"#017",l:"Dimond",f:"19073445621"},
      {n:"#018",l:"Abbott Loop",f:"19073367842"},
      {n:"#019",l:"Eagle River",f:"19076941235"},
      {n:"#021",l:"Wasilla",f:"19073762894"},
      {n:"#023",l:"Bellevue",f:"14256416749"},
      {n:"#024",l:"Ballard",f:"12067891234"},
      {n:"#025",l:"Burien",f:"12062438976"},
      {n:"#028",l:"Federal Way",f:"12538395612"},
      {n:"#030",l:"Kent",f:"12538542178"},
      {n:"#031",l:"Kirkland",f:"14258234561"},
      {n:"#035",l:"Lynnwood",f:"14257781234"},
      {n:"#040",l:"Newport Hills",f:"14256413287"},
      {n:"#041",l:"Redmond",f:"14258834521"},
      {n:"#049",l:"Renton",f:"14252268943"},
      {n:"#050",l:"Renton Highlands",f:"14252714568"},
      {n:"#053",l:"Auburn",f:"12538335127"},
      {n:"#060",l:"Tukwila",f:"12062432198"},
      {n:"#063",l:"University Village",f:"12065225874"},
      {n:"#070",l:"Shoreline",f:"12063632541"},
      {n:"#071",l:"Lake City",f:"12063652874"},
      {n:"#075",l:"Greenwood",f:"12067823145"},
      {n:"#090",l:"West Seattle",f:"12069373241"},
      {n:"#093",l:"Tacoma",f:"12534723698"},
      {n:"#111",l:"Puyallup",f:"12538453217"},
      {n:"#122",l:"Lacey",f:"13604562189"},
      {n:"#125",l:"Olympia",f:"13604913265"},
      {n:"#126",l:"Tumwater",f:"13607524831"},
      {n:"#127",l:"Centralia",f:"13603302178"},
      {n:"#135",l:"Vancouver Mall",f:"13602535498"},
      {n:"#140",l:"Hazel Dell",f:"13605743821"},
      {n:"#143",l:"Salmon Creek",f:"13605743295"},
      {n:"#150",l:"Orchards",f:"13608925431"},
      {n:"#153",l:"Battle Ground",f:"13606872543"},
      {n:"#156",l:"Camas",f:"13608345127"},
      {n:"#158",l:"Washougal",f:"13608352198"},
      {n:"#163",l:"Longview",f:"13604236587"},
      {n:"#165",l:"Kelso",f:"13605773214"},
      {n:"#171",l:"Woodland",f:"13602252148"},
      {n:"#180",l:"Beaverton",f:"15036443521"},
      {n:"#185",l:"Cedar Hills",f:"15036413287"},
      {n:"#186",l:"Sunset",f:"15035913254"},
      {n:"#195",l:"Tigard",f:"15036393241"},
      {n:"#196",l:"Lake Oswego",f:"15036364521"},
      {n:"#198",l:"West Linn",f:"15036573214"},
      {n:"#208",l:"Oregon City",f:"15036558741"},
      {n:"#209",l:"Milwaukie",f:"15036536298"},
      {n:"#210",l:"Clackamas",f:"15037865214"},
      {n:"#214",l:"Happy Valley",f:"15037983265"},
      {n:"#215",l:"Gresham",f:"15036653421"},
      {n:"#218",l:"Wood Village",f:"15036672198"},
      {n:"#220",l:"Troutdale",f:"15036693145"},
      {n:"#224",l:"Sandy",f:"15036682541"},
      {n:"#225",l:"Estacada",f:"15036306587"},
      {n:"#226",l:"Molalla",f:"15038296431"},
      {n:"#227",l:"Canby",f:"15032635498"},
      {n:"#236",l:"Hillsboro",f:"15036816543"},
      {n:"#240",l:"Forest Grove",f:"15033578214"},
      {n:"#242",l:"Cornelius",f:"15033572165"},
      {n:"#253",l:"Aloha",f:"15035912874"},
      {n:"#255",l:"Bethany",f:"15036452317"},
      {n:"#260",l:"Cedar Mill",f:"15036413698"},
      {n:"#265",l:"Rock Creek",f:"15036455431"},
      {n:"#281",l:"Sherwood",f:"15036257841"},
      {n:"#285",l:"Tualatin",f:"15036912365"},
      {n:"#286",l:"Wilsonville",f:"15035826431"},
      {n:"#325",l:"Salem Lancaster",f:"15033625874"},
      {n:"#328",l:"Salem Commercial",f:"15033913265"},
      {n:"#351",l:"Keizer",f:"15033905214"},
      {n:"#355",l:"Woodburn",f:"15039815432"},
      {n:"#360",l:"Silverton",f:"15038731254"},
      {n:"#372",l:"Dallas",f:"15036232541"},
      {n:"#375",l:"McMinnville",f:"15034726587"},
      {n:"#377",l:"Newberg",f:"15035381298"},
      {n:"#383",l:"Lincoln City",f:"15419962147"},
      {n:"#390",l:"Newport",f:"15412653874"},
      {n:"#391",l:"Toledo",f:"15413362541"},
      {n:"#393",l:"Corvallis",f:"15417523698"},
      {n:"#417",l:"Lebanon",f:"15412583214"},
      {n:"#424",l:"Sweet Home",f:"15413672865"},
      {n:"#439",l:"Eugene Coburg",f:"15413431254"},
      {n:"#449",l:"Eugene Delta",f:"15416878521"},
      {n:"#457",l:"Springfield",f:"15417260087"},
      {n:"#458",l:"Junction City",f:"15419983658"},
      {n:"#459",l:"Cottage Grove",f:"15419420147"},
      {n:"#460",l:"Creswell",f:"15418952365"},
      {n:"#462",l:"Roseburg",f:"15416734521"},
      {n:"#464",l:"Grants Pass",f:"15414761254"},
      {n:"#482",l:"Medford",f:"15417738965"},
      {n:"#485",l:"Ashland",f:"15414822541"},
      {n:"#486",l:"Central Point",f:"15416648752"},
      {n:"#516",l:"Klamath Falls",f:"15418849634"},
      {n:"#600",l:"Bend North",f:"15413892147"},
      {n:"#603",l:"Bend South",f:"15413172863"},
      {n:"#604",l:"Redmond OR",f:"15415260078"},
      {n:"#605",l:"Prineville",f:"15414477854"},
      {n:"#608",l:"Madras",f:"15414757523"},
      {n:"#613",l:"La Grande",f:"15419633247"},
      {n:"#614",l:"Baker City",f:"15415235417"},
      {n:"#615",l:"Ontario",f:"15418895632"},
      {n:"#649",l:"Hermiston",f:"15415641258"},
      {n:"#650",l:"Pendleton",f:"15412762541"},
      {n:"#651",l:"Walla Walla",f:"15095221478"},
      {n:"#652",l:"Kennewick",f:"15097352684"},
      {n:"#653",l:"Richland",f:"15099462175"},
      {n:"#654",l:"Pasco",f:"15095474158"},
      {n:"#655",l:"Yakima",f:"15094527836"},
      {n:"#656",l:"Sunnyside",f:"15098362514"},
      {n:"#657",l:"Toppenish",f:"15098652187"},
      {n:"#658",l:"Ellensburg",f:"15099253678"},
      {n:"#659",l:"Moses Lake",f:"15097641258"},
      {n:"#660",l:"Wenatchee",f:"15096622541"},
      {n:"#661",l:"East Wenatchee",f:"15098845214"},
      {n:"#662",l:"Omak",f:"15098262147"},
      {n:"#663",l:"Spokane Valley",f:"15099223541"},
      {n:"#665",l:"Spokane North",f:"15094864521"},
      {n:"#667",l:"Spokane South",f:"15095343287"},
      {n:"#668",l:"Cheney",f:"15092354178"},
      {n:"#681",l:"Coeur d'Alene",f:"12087658234"},
      {n:"#682",l:"Post Falls",f:"12087652874"},
      {n:"#683",l:"Moscow",f:"12088826541"},
      {n:"#685",l:"Lewiston",f:"12087462358"},
      {n:"#688",l:"Sandpoint",f:"12082633214"},
      {n:"#691",l:"Fairbanks",f:"19074564521"},
      {n:"#694",l:"Juneau",f:"19077805241"},
      {n:"#999",l:"Corporate HQ",f:"15032223344"}
    ];

    let drawing = false;
    let hasSig = false;
    let signatureMode = 'draw';
    let signatureEnabled = false;
    let signatureLocked = false;
    let signatureColor = '#0f172a';
    let signatureImage = '';
    let scanImage = '';
    let scanBaseImage = null;
    let scanEnhanced = false;
    let scanPoints = [
      { x: 0.08, y: 0.12 },
      { x: 0.92, y: 0.12 },
      { x: 0.92, y: 0.88 },
      { x: 0.08, y: 0.88 }
    ];

    // Legacy store dropdown population (kept for backwards compatibility)
    function populateStoreOptions(select) {
      if (!select) return;
      select.querySelectorAll('option[data-store]').forEach(opt => opt.remove());
      STORES.forEach(store => {
        const opt = document.createElement('option');
        opt.value = store.n;
        opt.textContent = `${store.n} - ${store.l}`;
        opt.setAttribute('data-store', '1');
        select.appendChild(opt);
      });
    }

    [faxStore, blankFaxStore, signedFaxStore].forEach(populateStoreOptions);

    // ═══════════════════════════════════════════════════════════
    // FAX MODAL
    // ═══════════════════════════════════════════════════════════
    let faxMode = 'blank'; // 'blank' or 'signed'
    let selectedStore = null;
    let faxSending = false;

    const faxModalOverlay = document.getElementById('faxModalOverlay');
    const faxModalTitle = document.getElementById('faxModalTitle');
    const faxModalSubtitle = document.getElementById('faxModalSubtitle');
    const faxStoreList = document.getElementById('faxStoreList');
    const faxStoreSearch = document.getElementById('faxStoreSearch');
    const faxDirectNumber = document.getElementById('faxDirectNumber');
    const faxSendBtn = document.getElementById('faxSendBtn');
    const faxSendBtnText = document.getElementById('faxSendBtnText');
    const faxStatusEl = document.getElementById('faxStatus');

    function openFaxModal(mode) {
      cleanupFaxListener();
      faxMode = mode;
      selectedStore = null;
      faxStoreSearch.value = '';
      faxDirectNumber.value = '';
      faxStatusEl.className = 'fax-status';
      faxStatusEl.textContent = '';
      updateFaxSendButton();

      if (mode === 'signed' && !generatedPDF) {
        showFaxStatus('error', 'No signed PDF available yet. Please submit the acknowledgement first.');
        return;
      }

      if (mode === 'blank') {
        faxModalTitle.textContent = 'Print Blank Form';
        faxModalSubtitle.textContent = 'Send a blank acknowledgement form to your store\'s printer for manual signing.';
      } else {
        faxModalTitle.textContent = 'Print Signed Copy';
        faxModalSubtitle.textContent = 'Send your signed acknowledgement to your store\'s printer.';
      }

      renderFaxStoreList(STORES);
      faxModalOverlay.classList.add('show');
      document.body.style.overflow = 'hidden';
      setTimeout(() => faxStoreSearch.focus(), 100);
    }

    function closeFaxModal() {
      // Only cleanup the fax listener if the floating overlay is NOT actively tracking
      if (!printOverlay.classList.contains('show')) {
        cleanupFaxListener();
      }
      faxModalOverlay.classList.remove('show');
      document.body.style.overflow = '';
    }

    function closeFaxModalOnBackdrop(e) {
      if (e.target === faxModalOverlay) closeFaxModal();
    }

    // ═══════════════════════════════════════════════════════════
    // FLOATING PRINT STATUS OVERLAY
    // ═══════════════════════════════════════════════════════════
    const printOverlay = document.getElementById('printStatusOverlay');
    const psoMinIcon = document.getElementById('psoMinIcon');
    const psoNotifyDot = document.getElementById('psoNotifyDot');
    const psoHeaderTitle = document.getElementById('psoHeaderTitle');
    const psoStatusIcon = document.getElementById('psoStatusIcon');
    const psoStatusTitle = document.getElementById('psoStatusTitle');
    const psoStatusSub = document.getElementById('psoStatusSub');
    const psoStatusTimer = document.getElementById('psoStatusTimer');
    const psoHeader = document.getElementById('psoHeader');

    let psoCurrentState = 'sending'; // sending | waiting | delivered | error
    let psoTimerInterval = null;
    let psoElapsedSeconds = 0;
    let psoDragData = { isDragging: false, startX: 0, startY: 0, origLeft: 0, origTop: 0 };
    let psoHasNotified = false;

    // SVG icons for overlay states
    const PSO_ICONS = {
      printer: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z"/></svg>',
      spinner: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.992 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182"/></svg>',
      clock: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>',
      check: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5"/></svg>',
      error: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"/></svg>'
    };

    function showPrintOverlay(target) {
      psoCurrentState = 'sending';
      psoElapsedSeconds = 0;
      psoHasNotified = false;
      psoNotifyDot.classList.remove('show');
      printOverlay.classList.remove('minimized', 'closing', 'delivered-glow', 'error-glow');
      printOverlay.classList.add('show');

      // Reset position to default bottom-right
      printOverlay.style.left = '';
      printOverlay.style.top = '';
      printOverlay.style.right = '16px';
      printOverlay.style.bottom = `calc(var(--bottom-nav-height) + 16px)`;

      psoHeaderTitle.textContent = 'Sending to Printer';
      updatePsoState('sending', 'Sending to print server...', `Routing ${faxMode} form to ${target}`, '');

      // Start timer
      clearInterval(psoTimerInterval);
      psoTimerInterval = setInterval(() => {
        psoElapsedSeconds++;
        const mins = Math.floor(psoElapsedSeconds / 60);
        const secs = psoElapsedSeconds % 60;
        psoStatusTimer.textContent = mins > 0
          ? `${mins}m ${secs.toString().padStart(2, '0')}s elapsed`
          : `${secs}s elapsed`;
      }, 1000);
    }

    function updatePsoState(state, title, sub, timer) {
      psoCurrentState = state;

      // Update status icon
      psoStatusIcon.className = `pso-status-icon ${state}`;
      if (state === 'sending') {
        psoStatusIcon.innerHTML = PSO_ICONS.spinner;
      } else if (state === 'waiting') {
        psoStatusIcon.innerHTML = PSO_ICONS.clock;
      } else if (state === 'delivered') {
        psoStatusIcon.innerHTML = PSO_ICONS.check;
      } else if (state === 'error') {
        psoStatusIcon.innerHTML = PSO_ICONS.error;
      } else if (state === 'info') {
        psoStatusIcon.innerHTML = PSO_ICONS.printer;
      }

      // Update minimized icon state
      psoMinIcon.className = `pso-minimized-icon ${state}`;

      // Update text
      psoStatusTitle.textContent = title;
      psoStatusSub.textContent = sub;
      if (timer !== undefined) psoStatusTimer.textContent = timer;

      // Update header
      if (state === 'delivered') {
        psoHeaderTitle.textContent = 'Print Complete';
        printOverlay.classList.add('delivered-glow');
        printOverlay.classList.remove('error-glow');
      } else if (state === 'error') {
        psoHeaderTitle.textContent = 'Print Failed';
        printOverlay.classList.add('error-glow');
        printOverlay.classList.remove('delivered-glow');
      } else if (state === 'waiting') {
        psoHeaderTitle.textContent = 'Waiting for Printer';
        printOverlay.classList.remove('delivered-glow', 'error-glow');
      } else if (state === 'info') {
        psoHeaderTitle.textContent = 'Print Job';
        printOverlay.classList.remove('delivered-glow', 'error-glow');
      } else {
        psoHeaderTitle.textContent = 'Sending to Printer';
        printOverlay.classList.remove('delivered-glow', 'error-glow');
      }
    }

    function notifyPrintComplete(success) {
      if (psoHasNotified) return;
      psoHasNotified = true;

      // Show notification dot when minimized
      if (printOverlay.classList.contains('minimized')) {
        psoNotifyDot.classList.add('show');
      }

      // Stop the timer
      clearInterval(psoTimerInterval);
      psoTimerInterval = null;

      // Try vibration API for mobile
      if (navigator.vibrate) {
        navigator.vibrate(success ? [100, 50, 100] : [200, 100, 200]);
      }

      // Auto-expand if minimized after a brief delay
      if (printOverlay.classList.contains('minimized')) {
        setTimeout(() => {
          expandPrintOverlay();
          psoNotifyDot.classList.remove('show');
        }, 800);
      }

      // Auto-dismiss after 30 seconds for success
      if (success) {
        setTimeout(() => {
          if (printOverlay.classList.contains('show') && psoCurrentState === 'delivered') {
            dismissPrintOverlay();
          }
        }, 30000);
      }
    }

    function minimizePrintOverlay() {
      printOverlay.classList.add('minimized');
    }

    function expandPrintOverlay() {
      printOverlay.classList.remove('minimized');
      psoNotifyDot.classList.remove('show');
    }

    function dismissPrintOverlay() {
      // Cleanup timers and listeners
      clearInterval(psoTimerInterval);
      psoTimerInterval = null;
      cleanupFaxListener();

      printOverlay.classList.add('closing');
      setTimeout(() => {
        printOverlay.classList.remove('show', 'closing', 'minimized', 'delivered-glow', 'error-glow');
      }, 250);
    }

    // ── Drag logic for the overlay ──
    function initPsoDrag(e) {
      // Only drag from header, ignore button clicks
      if (e.target.closest('.pso-action-btn')) return;
      if (printOverlay.classList.contains('minimized')) return;

      const touch = e.touches ? e.touches[0] : e;
      const rect = printOverlay.getBoundingClientRect();

      // Convert from right/bottom positioning to left/top
      if (!printOverlay.style.left || printOverlay.style.right) {
        printOverlay.style.left = rect.left + 'px';
        printOverlay.style.top = rect.top + 'px';
        printOverlay.style.right = 'auto';
        printOverlay.style.bottom = 'auto';
      }

      psoDragData = {
        isDragging: true,
        startX: touch.clientX,
        startY: touch.clientY,
        origLeft: rect.left,
        origTop: rect.top
      };

      document.addEventListener('mousemove', onPsoDrag);
      document.addEventListener('mouseup', endPsoDrag);
      document.addEventListener('touchmove', onPsoDrag, { passive: false });
      document.addEventListener('touchend', endPsoDrag);
    }

    function onPsoDrag(e) {
      if (!psoDragData.isDragging) return;
      e.preventDefault();
      const touch = e.touches ? e.touches[0] : e;
      const dx = touch.clientX - psoDragData.startX;
      const dy = touch.clientY - psoDragData.startY;

      let newLeft = psoDragData.origLeft + dx;
      let newTop = psoDragData.origTop + dy;

      // Keep within viewport
      const rect = printOverlay.getBoundingClientRect();
      const maxLeft = window.innerWidth - rect.width;
      const maxTop = window.innerHeight - rect.height;
      newLeft = Math.max(0, Math.min(newLeft, maxLeft));
      newTop = Math.max(0, Math.min(newTop, maxTop));

      printOverlay.style.left = newLeft + 'px';
      printOverlay.style.top = newTop + 'px';
    }

    function endPsoDrag() {
      psoDragData.isDragging = false;
      document.removeEventListener('mousemove', onPsoDrag);
      document.removeEventListener('mouseup', endPsoDrag);
      document.removeEventListener('touchmove', onPsoDrag);
      document.removeEventListener('touchend', endPsoDrag);
    }

    psoHeader.addEventListener('mousedown', initPsoDrag);
    psoHeader.addEventListener('touchstart', initPsoDrag, { passive: true });

    function renderFaxStoreList(stores) {
      if (stores.length === 0) {
        faxStoreList.innerHTML = '<div class="fax-no-results">No stores found</div>';
        return;
      }

      faxStoreList.innerHTML = stores.map(store => `
        <div class="fax-store-item${selectedStore && selectedStore.n === store.n ? ' selected' : ''}" 
             data-store="${store.n}" 
             onclick="selectFaxStore('${store.n}')">
          <div class="fax-store-radio">
            <div class="fax-store-radio-inner"></div>
          </div>
          <div class="fax-store-info">
            <div class="fax-store-number">${store.n}</div>
            <div class="fax-store-location">${store.l}</div>
          </div>
          <div class="fax-store-check">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5"/></svg>
          </div>
        </div>
      `).join('');
    }

    function filterFaxStores() {
      const query = faxStoreSearch.value.toLowerCase().trim();
      if (!query) {
        renderFaxStoreList(STORES);
        return;
      }

      const filtered = STORES.filter(store => 
        store.n.toLowerCase().includes(query) || 
        store.l.toLowerCase().includes(query)
      );
      renderFaxStoreList(filtered);
    }

    function selectFaxStore(storeNumber) {
      selectedStore = STORES.find(s => s.n === storeNumber) || null;
      faxDirectNumber.value = ''; // Clear direct number when selecting store

      // Update UI
      document.querySelectorAll('.fax-store-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.store === storeNumber);
      });

      updateFaxSendButton();
    }

    function onDirectFaxInput() {
      // Clear store selection when typing direct number
      if (faxDirectNumber.value.trim()) {
        selectedStore = null;
        document.querySelectorAll('.fax-store-item').forEach(item => {
          item.classList.remove('selected');
        });
      }
      updateFaxSendButton();
    }

    function updateFaxSendButton() {
      const directNum = faxDirectNumber.value.replace(/\D/g, '');
      const hasValidSelection = selectedStore || directNum.length >= 10;
      faxSendBtn.disabled = !hasValidSelection || faxSending;
    }

    function showFaxStatus(type, message) {
      faxStatusEl.className = `fax-status show ${type}`;
      faxStatusEl.textContent = message;
    }

    function showFaxStatusHtml(type, html) {
      faxStatusEl.className = `fax-status show ${type}`;
      faxStatusEl.innerHTML = html;
    }

    // ═══════════════════════════════════════════════════════════
    // REAL-TIME FAX DELIVERY TRACKING
    // ═══════════════════════════════════════════════════════════
    let unsubscribeFaxListener = null;
    let faxStatusTimeout = null;
    let faxWaitingTimer = null;
    let faxWaitingSeconds = 0;

    function cleanupFaxListener() {
      if (unsubscribeFaxListener) {
        unsubscribeFaxListener();
        unsubscribeFaxListener = null;
      }
      if (faxStatusTimeout) {
        clearTimeout(faxStatusTimeout);
        faxStatusTimeout = null;
      }
      if (faxWaitingTimer) {
        clearInterval(faxWaitingTimer);
        faxWaitingTimer = null;
      }
      faxWaitingSeconds = 0;
    }

    function listenForFaxStatus(trackingId, target) {
      // Clean up any previous listener
      cleanupFaxListener();

      // If Firebase is not configured, fall back to basic success on the overlay
      if (!firestore) {
        clearInterval(psoTimerInterval);
        psoTimerInterval = null;
        updatePsoState('delivered', 'Printed Successfully',
          `Your ${faxMode} form is being printed at ${target}.`, '');
        psoStatusTimer.textContent = '';
        notifyPrintComplete(true);
        return;
      }

      // The overlay is already showing "waiting" state from sendFax()
      // Listen for Firestore document changes on faxJobs/{trackingId}
      unsubscribeFaxListener = firestore.collection('faxJobs').doc(trackingId)
        .onSnapshot((doc) => {
          if (!doc.exists) return;
          const data = doc.data();
          const status = (data.status || '').trim();

          if (/^(success|delivered|completed)$/i.test(status)) {
            clearInterval(psoTimerInterval);
            psoTimerInterval = null;
            updatePsoState('delivered', 'Printed Successfully',
              `Your ${faxMode} form was printed at ${target}.`, '');
            psoStatusTimer.textContent = '';
            notifyPrintComplete(true);
            cleanupFaxListener();
          } else if (/^(fail|failed|error)$/i.test(status)) {
            clearInterval(psoTimerInterval);
            psoTimerInterval = null;
            updatePsoState('error', 'Print Failed',
              `The print job for ${target} could not be completed. Please try again.`, '');
            psoStatusTimer.textContent = '';
            notifyPrintComplete(false);
            cleanupFaxListener();
          }
          // 'Pending' or other statuses — keep listening
        }, (error) => {
          console.error('Firestore fax listener error:', error);
          // Fall back to success message on overlay
          clearInterval(psoTimerInterval);
          psoTimerInterval = null;
          updatePsoState('delivered', 'Sent to Printer',
            `Your ${faxMode} form is being printed at ${target}.`, '');
          psoStatusTimer.textContent = '';
          notifyPrintComplete(true);
          cleanupFaxListener();
        });

      // After 5 minutes, show a "still processing" hint (but keep listening)
      faxStatusTimeout = setTimeout(() => {
        if (unsubscribeFaxListener) {
          updatePsoState('waiting', `Sent to ${target}`,
            'No confirmation received yet. The print job may still be processing.', '');
        }
        faxStatusTimeout = null;
      }, 5 * 60 * 1000);
    }

    // Generate blank PDF for faxing
    function generateBlankPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'letter' });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 20;
      const contentW = pageW - margin * 2;
      let y = 20;

      // Header banner
      const bannerH = 26;
      doc.setFillColor(13, 27, 42);
      doc.rect(0, 0, pageW, bannerH, 'F');

      // Header logo if available
      const logo = getHeaderLogoData();
      if (logo) {
        const maxH = bannerH - 6;
        const logoH = Math.min(maxH, 10);
        const logoW = logoH * logo.aspect;
        doc.addImage(logo.dataUrl, 'PNG', pageW - margin - logoW, (bannerH - logoH) / 2, logoW, logoH);
      }

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.setTextColor(255, 255, 255);
      doc.text('ADV Teammate Handbook', margin, 12);
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(148, 163, 184);
      doc.text('Acknowledgement of Receipt  |  Current version revised February 2025', margin, 20);
      y = 34;

      // Section title
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.setTextColor(13, 27, 42);
      doc.text('Acknowledgement of Receipt', margin, y);
      y += 3;
      doc.setDrawColor(74, 144, 196);
      doc.setLineWidth(0.6);
      doc.line(margin, y, margin + 55, y);
      y += 7;

      // Condensed acknowledgement text
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8.5);
      doc.setTextColor(55, 65, 81);
      
      const condensedText = 'I have received a copy of the Company\'s Handbook and applicable Supplement(s). I agree to read and comply with the policies described within. I understand that failure to follow these policies may result in disciplinary action, up to and including termination. I acknowledge that my employment is "at-will" and that this Handbook does not create a contract of employment. By signing below, I acknowledge receipt of the Handbook and agree to abide by all policies within it.';
      
      const lines = doc.splitTextToSize(condensedText, contentW);
      doc.text(lines, margin, y);
      y += lines.length * 3.8 + 8;

      // Consent checkbox area
      doc.setFillColor(241, 245, 249);
      doc.roundedRect(margin, y, contentW, 14, 2, 2, 'F');
      doc.setDrawColor(100, 116, 139);
      doc.setLineWidth(0.3);
      doc.rect(margin + 4, y + 5, 4, 4);
      doc.setFont('helvetica', 'italic');
      doc.setFontSize(7.5);
      doc.setTextColor(100, 116, 139);
      const consentText = 'I agree that my signature below is the legal equivalent of my handwritten signature acknowledging receipt of the ADV Teammate Handbook.';
      doc.text(doc.splitTextToSize(consentText, contentW - 14), margin + 10, y + 7);
      y += 20;

      // Signature lines
      const colGap = 15;
      const colW = (contentW - colGap) / 2;

      // Printed Name
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(107, 114, 128);
      doc.text('PRINTED TEAMMATE NAME', margin, y);
      y += 4;
      doc.setDrawColor(180, 180, 180);
      doc.setLineWidth(0.4);
      doc.line(margin, y + 12, margin + contentW, y + 12);
      y += 20;

      // Signature and Date side by side
      const sigY = y;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(107, 114, 128);
      doc.text('TEAMMATE SIGNATURE', margin, sigY);
      doc.text('DATE', margin + colW + colGap, sigY);

      // Signature line
      doc.setDrawColor(0, 0, 0);
      doc.setLineWidth(0.5);
      doc.line(margin, sigY + 16, margin + colW, sigY + 16);

      // Date line
      doc.line(margin + colW + colGap, sigY + 16, margin + colW + colGap + colW, sigY + 16);

      // Footer
      const footerY = pageH - 12;
      doc.setDrawColor(209, 213, 219);
      doc.setLineWidth(0.3);
      doc.line(margin, footerY - 4, pageW - margin, footerY - 4);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      doc.setTextColor(156, 163, 175);
      doc.text('© 2026 Advantage Solutions Inc.  |  Confidential', margin, footerY);
      doc.text('Blank Form for Manual Signing', pageW - margin, footerY, { align: 'right' });

      return doc;
    }

    // Main send fax function
    async function sendFax() {
      if (faxSending) return;

      const directNum = faxDirectNumber.value.replace(/\D/g, '');
      const useDirectFax = !selectedStore && directNum.length >= 10;

      if (!selectedStore && !useDirectFax) {
        showFaxStatus('error', 'Please select a store or enter a valid printer number.');
        return;
      }

      // Capture target info before closing modal
      const targetLabel = useDirectFax 
        ? `printer ${formatPhoneNumber(directNum)}`
        : `${selectedStore.l} (${selectedStore.n})`;
      const capturedStore = selectedStore ? { ...selectedStore } : null;
      const capturedDirectNum = directNum;
      const capturedFaxMode = faxMode;

      faxSending = true;
      faxSendBtn.disabled = true;
      faxSendBtnText.innerHTML = '<span class="spinner"></span> Sending...';

      try {
        // Generate appropriate PDF
        let pdfDoc, fileName;
        if (capturedFaxMode === 'blank') {
          pdfDoc = generateBlankPDF();
          fileName = 'Blank_Handbook_Acknowledgement.pdf';
        } else {
          if (!generatedPDF) throw new Error('No signed PDF available. Please submit the form first.');
          // Use print-optimized variant (transparent header + black text)
          pdfDoc = generatePrintableSignedPDF();
          fileName = pdfFileName || 'Signed_Handbook_Acknowledgement.pdf';
        }

        // Convert to base64
        const pdfBase64 = pdfDoc.output('datauristring').split(',')[1];

        // Demo mode check
        if (!FUNCTIONS_BASE) {
          // Close modal, show floating overlay in demo mode
          closeFaxModal();
          showPrintOverlay(targetLabel);
          updatePsoState('info', 'Demo Mode',
            `Would print ${capturedFaxMode} form at ${targetLabel}. Set FUNCTIONS_BASE to enable.`, '');
          clearInterval(psoTimerInterval);
          psoTimerInterval = null;
          psoStatusTimer.textContent = '';
          faxSending = false;
          resetFaxSendBtn();
          return;
        }

        // Close the modal and show the floating overlay immediately
        closeFaxModal();
        showPrintOverlay(targetLabel);

        // Call appropriate Cloud Function
        let response;
        if (useDirectFax) {
          response = await fetch(`${FUNCTIONS_BASE}/sendFaxDirect`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              faxNumber: capturedDirectNum,
              pdfBase64: pdfBase64,
              fileName: fileName,
              type: capturedFaxMode
            })
          });
        } else {
          response = await fetch(`${FUNCTIONS_BASE}/sendFax`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              storeNumber: capturedStore.n,
              pdfBase64: pdfBase64,
              fileName: fileName,
              type: capturedFaxMode
            })
          });
        }

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to send to printer');
        }

        // Success — update overlay to waiting and start real-time delivery tracking
        const shortTarget = useDirectFax 
          ? formatPhoneNumber(capturedDirectNum)
          : `${capturedStore.l} (${capturedStore.n})`;

        updatePsoState('waiting', `Sent to ${shortTarget}`,
          'Waiting for print confirmation from the print server...', '');

        // Start listening for delivery confirmation via Firestore
        listenForFaxStatus(result.trackingId, shortTarget);

      } catch (error) {
        console.error('Fax error:', error);
        // If overlay is showing, update it with the error
        if (printOverlay.classList.contains('show')) {
          clearInterval(psoTimerInterval);
          psoTimerInterval = null;
          updatePsoState('error', 'Print Failed',
            error.message || 'Failed to send to printer. Please try again.', '');
          psoStatusTimer.textContent = '';
        } else {
          showFaxStatus('error', error.message || 'Failed to send to printer. Please try again.');
        }
      } finally {
        faxSending = false;
        resetFaxSendBtn();
      }
    }

    function resetFaxSendBtn() {
      faxSendBtn.disabled = false;
      faxSendBtnText.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/></svg> Send to Printer';
      updateFaxSendButton();
    }

    function formatPhoneNumber(num) {
      if (num.length === 10) {
        return `(${num.slice(0,3)}) ${num.slice(3,6)}-${num.slice(6)}`;
      } else if (num.length === 11 && num[0] === '1') {
        return `1 (${num.slice(1,4)}) ${num.slice(4,7)}-${num.slice(7)}`;
      }
      return num;
    }

    // Keyboard handler for modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && faxModalOverlay.classList.contains('show')) {
        closeFaxModal();
      }
    });

    // Keyboard handler for fax trigger card
    document.querySelectorAll('.fax-trigger-card').forEach((card) => {
      card.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter' && e.key !== ' ') return;
        if (card.getAttribute('aria-disabled') === 'true') return;
        e.preventDefault();
        if (card.id === 'faxSignedTrigger') openFaxModal('signed');
        else openFaxModal('blank');
      });
    });

    function resizeCanvas(preserve = true) {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      const previousImage = preserve ? signatureImage : '';
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.lineWidth = parseFloat(penSizeInput.value);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = signatureColor;
      if (previousImage) restoreSignatureImage(previousImage);
    }

    function restoreSignatureImage(dataUrl) {
      const img = new Image();
      img.onload = () => {
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, rect.width, rect.height);
      };
      img.src = dataUrl;
    }

    function updateOrientationHint() {
      const isPortrait = window.matchMedia('(orientation: portrait)').matches;
      const showHint = signatureMode === 'draw' && !hasSig && window.innerWidth <= 900 && isPortrait;
      orientationHint.classList.toggle('sig-hidden', !showHint);
    }

    function setSignatureMode(mode) {
      if (signatureLocked) return;
      signatureMode = mode;
      document.querySelectorAll('.sig-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      document.getElementById('drawControls').classList.toggle('sig-hidden', mode !== 'draw');
      document.getElementById('typeControls').classList.toggle('sig-hidden', mode !== 'type');
      document.getElementById('uploadControls').classList.toggle('sig-hidden', mode !== 'upload');
      document.getElementById('scanControls').classList.toggle('sig-hidden', mode !== 'scan');
      document.getElementById('faxControls').classList.toggle('sig-hidden', mode !== 'fax');
      placeholder.textContent = mode === 'draw' ? 'Sign here using your mouse or finger' : 'Signature preview will appear here';
      saveBtn.classList.toggle('visible', mode === 'draw' && hasSig);
      consentLabel.textContent = mode === 'fax'
        ? 'By checking this box, I confirm I have reviewed the ADV Teammate Handbook and my State Supplement and request this acknowledgement be printed at my selected store.'
        : mode === 'scan'
        ? 'By checking this box, I confirm the scanned document is my signed acknowledgement and I have reviewed the ADV Teammate Handbook and my State Supplement.'
        : 'By checking this box, I agree that my digital signature captured on this device (or uploaded signature image) is applied to this acknowledgement and is the legal equivalent of my handwritten signature. I confirm I have reviewed the ADV Teammate Handbook and my State Supplement and understand the policies and procedures described within them.';
      signatureEnabled = mode !== 'draw';
      signNowBtn.disabled = mode !== 'draw' || signatureEnabled;
      canvas.classList.toggle('disabled', mode !== 'draw' || (mode === 'draw' && !signatureEnabled));
      if (mode === 'fax' || mode === 'scan') {
        clearSignature();
      }
      if (mode === 'scan') {
        resizeScanCanvas();
      }
      updateOrientationHint();
      checkForm();
    }

    function setInkColor(color) {
      signatureColor = color;
      ctx.strokeStyle = signatureColor;
      document.getElementById('inkBlack').classList.toggle('active', color === '#0f172a');
      document.getElementById('inkBlue').classList.toggle('active', color === '#1d4ed8');
      if (signatureMode === 'type' && typedInput.value.trim()) applyTypedSignature();
    }

    function enableSignaturePad() {
      if (signatureLocked) return;
      signatureEnabled = true;
      canvas.classList.remove('disabled');
      signNowBtn.disabled = true;
      saveBtn.classList.toggle('visible', hasSig);
      updateOrientationHint();
    }

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      const cx = e.touches ? e.touches[0].clientX : e.clientX;
      const cy = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: cx - rect.left, y: cy - rect.top };
    }

    function startDraw(e) {
      if (signatureLocked || signatureMode !== 'draw' || !signatureEnabled) return;
      e.preventDefault();
      drawing = true;
      canvas.classList.add('active');
      const p = getPos(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    }

    function draw(e) {
      if (!drawing || signatureLocked) return;
      e.preventDefault();
      const p = getPos(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      if (!hasSig) {
        hasSig = true;
        placeholder.classList.add('hidden');
        clearBtn.classList.add('visible');
        saveBtn.classList.add('visible');
        canvas.classList.add('has-signature');
        checkForm();
      }
    }

    function stopDraw() {
      if (!drawing) return;
      drawing = false;
      canvas.classList.remove('active');
      if (hasSig) signatureImage = canvas.toDataURL('image/png');
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseleave', stopDraw);
    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDraw);

    function applyTypedSignature() {
      if (signatureLocked) return;
      const text = typedInput.value.trim();
      if (!text) {
        clearSignature();
        return;
      }
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let fontSize = Math.min(64, Math.max(28, rect.width * 0.18));
      ctx.fillStyle = signatureColor;
      ctx.textBaseline = 'middle';
      ctx.textAlign = 'left';
      ctx.font = `${fontSize}px ${typedFont.value}`;
      while (ctx.measureText(text).width > rect.width - 30 && fontSize > 20) {
        fontSize -= 2;
        ctx.font = `${fontSize}px ${typedFont.value}`;
      }
      ctx.fillText(text, 18, rect.height / 2);
      hasSig = true;
      signatureImage = canvas.toDataURL('image/png');
      placeholder.classList.add('hidden');
      clearBtn.classList.add('visible');
      saveBtn.classList.add('visible');
      canvas.classList.add('has-signature');
      checkForm();
    }

    function triggerSignatureUpload() {
      if (signatureLocked) return;
      sigFileInput.click();
    }

    function drawImageToCanvas(dataUrl) {
      const img = new Image();
      img.onload = () => {
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const scale = Math.min(rect.width / img.width, rect.height / img.height);
        const w = img.width * scale;
        const h = img.height * scale;
        const x = (rect.width - w) / 2;
        const y = (rect.height - h) / 2;
        ctx.drawImage(img, x, y, w, h);
        hasSig = true;
        signatureImage = canvas.toDataURL('image/png');
        placeholder.classList.add('hidden');
        clearBtn.classList.add('visible');
        saveBtn.classList.add('visible');
        canvas.classList.add('has-signature');
        checkForm();
      };
      img.src = dataUrl;
    }

    sigFileInput.addEventListener('change', (e) => {
      if (signatureLocked) return;
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => drawImageToCanvas(reader.result);
      reader.readAsDataURL(file);
      e.target.value = '';
    });

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      hasSig = false;
      signatureImage = '';
      placeholder.classList.remove('hidden');
      clearBtn.classList.remove('visible');
      saveBtn.classList.remove('visible');
      canvas.classList.remove('has-signature');
      checkForm();
    }

    function saveSignature() {
      if (signatureLocked || signatureMode !== 'draw' || !hasSig) return;
      signatureImage = canvas.toDataURL('image/png');
      signatureEnabled = false;
      canvas.classList.add('disabled');
      signNowBtn.disabled = false;
      saveBtn.classList.remove('visible');
    }

    /* ═══════════════════════════════════════════════════════════
       SCAN WORKFLOW
       ═══════════════════════════════════════════════════════════ */
    function resizeScanCanvas() {
      const rect = scanWrap.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      scanCanvas.width = rect.width * dpr;
      scanCanvas.height = rect.height * dpr;
      scanCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      renderScanCanvas();
    }

    function getScanDisplay() {
      const rect = scanCanvas.getBoundingClientRect();
      if (!scanBaseImage) return null;
      const scale = Math.min(rect.width / scanBaseImage.width, rect.height / scanBaseImage.height);
      const drawW = scanBaseImage.width * scale;
      const drawH = scanBaseImage.height * scale;
      const offsetX = (rect.width - drawW) / 2;
      const offsetY = (rect.height - drawH) / 2;
      return { scale, offsetX, offsetY, drawW, drawH, rect };
    }

    function renderScanCanvas() {
      const rect = scanCanvas.getBoundingClientRect();
      scanCtx.clearRect(0, 0, rect.width, rect.height);
      if (!scanBaseImage) {
        scanCtx.fillStyle = '#111827';
        scanCtx.fillRect(0, 0, rect.width, rect.height);
        scanCtx.fillStyle = '#64748b';
        scanCtx.font = '14px Plus Jakarta Sans';
        scanCtx.fillText('Capture a photo to begin', 16, 24);
        scanOverlay.style.display = 'none';
        scanHandles.forEach(h => h.style.display = 'none');
        return;
      }
      const display = getScanDisplay();
      if (!display) return;
      const off = document.createElement('canvas');
      off.width = scanBaseImage.width;
      off.height = scanBaseImage.height;
      const offCtx = off.getContext('2d');
      offCtx.drawImage(scanBaseImage, 0, 0);
      if (scanEnhanced) {
        const imgData = offCtx.getImageData(0, 0, off.width, off.height);
        autoEnhanceImageData(imgData);
        offCtx.putImageData(imgData, 0, 0);
      }
      scanCtx.drawImage(off, display.offsetX, display.offsetY, display.drawW, display.drawH);
      drawScanPolygon(display);
      scanOverlay.style.display = 'block';
      scanHandles.forEach(h => h.style.display = 'block');
      positionScanHandles();
    }

    function drawScanPolygon(display) {
      scanCtx.save();
      scanCtx.strokeStyle = 'rgba(74,144,196,0.8)';
      scanCtx.lineWidth = 2;
      scanCtx.beginPath();
      scanPoints.forEach((pt, idx) => {
        const x = pt.x * display.rect.width;
        const y = pt.y * display.rect.height;
        if (idx === 0) scanCtx.moveTo(x, y);
        else scanCtx.lineTo(x, y);
      });
      scanCtx.closePath();
      scanCtx.stroke();
      scanCtx.restore();
    }

    function positionScanHandles() {
      const rect = scanCanvas.getBoundingClientRect();
      scanHandles.forEach(handle => {
        const name = handle.dataset.handle;
        const idx = name === 'tl' ? 0 : name === 'tr' ? 1 : name === 'br' ? 2 : 3;
        const pt = scanPoints[idx];
        handle.style.left = `${pt.x * rect.width}px`;
        handle.style.top = `${pt.y * rect.height}px`;
      });
    }

    function triggerScanCapture() {
      if (signatureLocked) return;
      scanFileInput.click();
    }

    function resetScan() {
      scanBaseImage = null;
      scanImage = '';
      scanEnhanced = false;
      renderScanCanvas();
      checkForm();
    }

    function autoEnhanceImageData(imageData) {
      const data = imageData.data;
      const contrast = 1.15;
      const brightness = 12;
      for (let i = 0; i < data.length; i += 4) {
        data[i] = clampColor((data[i] - 128) * contrast + 128 + brightness);
        data[i + 1] = clampColor((data[i + 1] - 128) * contrast + 128 + brightness);
        data[i + 2] = clampColor((data[i + 2] - 128) * contrast + 128 + brightness);
      }
    }

    function clampColor(v) { return Math.max(0, Math.min(255, v)); }

    function autoEnhanceScan() {
      if (!scanBaseImage) return;
      scanEnhanced = true;
      renderScanCanvas();
    }

    function applyScanCrop() {
      if (!scanBaseImage) return;
      const display = getScanDisplay();
      if (!display) return;
      const srcPts = scanPoints.map(pt => {
        const x = (pt.x * display.rect.width - display.offsetX) / display.scale;
        const y = (pt.y * display.rect.height - display.offsetY) / display.scale;
        return { x: Math.max(0, Math.min(scanBaseImage.width, x)), y: Math.max(0, Math.min(scanBaseImage.height, y)) };
      });
      const outW = Math.max(distance(srcPts[0], srcPts[1]), distance(srcPts[2], srcPts[3]));
      const outH = Math.max(distance(srcPts[0], srcPts[3]), distance(srcPts[1], srcPts[2]));
      const warped = warpImage(scanBaseImage, srcPts, Math.round(outW), Math.round(outH), scanEnhanced);
      scanImage = warped.toDataURL('image/jpeg', 0.92);
      checkForm();
    }

    function distance(a, b) {
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function warpImage(image, srcPts, outW, outH, enhance) {
      const srcCanvas = document.createElement('canvas');
      srcCanvas.width = image.width;
      srcCanvas.height = image.height;
      const srcCtx = srcCanvas.getContext('2d');
      srcCtx.drawImage(image, 0, 0);
      if (enhance) {
        const imgData = srcCtx.getImageData(0, 0, srcCanvas.width, srcCanvas.height);
        autoEnhanceImageData(imgData);
        srcCtx.putImageData(imgData, 0, 0);
      }
      const srcData = srcCtx.getImageData(0, 0, srcCanvas.width, srcCanvas.height);
      const dstCanvas = document.createElement('canvas');
      dstCanvas.width = Math.max(1, outW);
      dstCanvas.height = Math.max(1, outH);
      const dstCtx = dstCanvas.getContext('2d');
      const dstData = dstCtx.createImageData(dstCanvas.width, dstCanvas.height);
      const dstPts = [
        { x: 0, y: 0 },
        { x: dstCanvas.width, y: 0 },
        { x: dstCanvas.width, y: dstCanvas.height },
        { x: 0, y: dstCanvas.height }
      ];
      const H = computeHomography(dstPts, srcPts);
      for (let y = 0; y < dstCanvas.height; y++) {
        for (let x = 0; x < dstCanvas.width; x++) {
          const denom = H[6] * x + H[7] * y + 1;
          const srcX = (H[0] * x + H[1] * y + H[2]) / denom;
          const srcY = (H[3] * x + H[4] * y + H[5]) / denom;
          const idx = (y * dstCanvas.width + x) * 4;
          const color = sampleBilinear(srcData, srcX, srcY);
          dstData.data[idx] = color[0];
          dstData.data[idx + 1] = color[1];
          dstData.data[idx + 2] = color[2];
          dstData.data[idx + 3] = 255;
        }
      }
      dstCtx.putImageData(dstData, 0, 0);
      return dstCanvas;
    }

    function sampleBilinear(imageData, x, y) {
      const w = imageData.width;
      const h = imageData.height;
      if (x < 0 || y < 0 || x >= w || y >= h) return [255, 255, 255];
      const x1 = Math.floor(x);
      const y1 = Math.floor(y);
      const x2 = Math.min(w - 1, x1 + 1);
      const y2 = Math.min(h - 1, y1 + 1);
      const dx = x - x1;
      const dy = y - y1;
      const i11 = (y1 * w + x1) * 4;
      const i12 = (y1 * w + x2) * 4;
      const i21 = (y2 * w + x1) * 4;
      const i22 = (y2 * w + x2) * 4;
      const c = [0, 0, 0];
      for (let i = 0; i < 3; i++) {
        const v11 = imageData.data[i11 + i];
        const v12 = imageData.data[i12 + i];
        const v21 = imageData.data[i21 + i];
        const v22 = imageData.data[i22 + i];
        const v1 = v11 * (1 - dx) + v12 * dx;
        const v2 = v21 * (1 - dx) + v22 * dx;
        c[i] = v1 * (1 - dy) + v2 * dy;
      }
      return c;
    }

    function computeHomography(src, dst) {
      const A = [];
      const b = [];
      for (let i = 0; i < 4; i++) {
        const xs = src[i].x;
        const ys = src[i].y;
        const xd = dst[i].x;
        const yd = dst[i].y;
        A.push([xs, ys, 1, 0, 0, 0, -xs * xd, -ys * xd]);
        b.push(xd);
        A.push([0, 0, 0, xs, ys, 1, -xs * yd, -ys * yd]);
        b.push(yd);
      }
      const h = solveLinearSystem(A, b);
      return [h[0], h[1], h[2], h[3], h[4], h[5], h[6], h[7]];
    }

    function solveLinearSystem(A, b) {
      const n = b.length;
      for (let i = 0; i < n; i++) {
        let maxRow = i;
        for (let k = i + 1; k < n; k++) {
          if (Math.abs(A[k][i]) > Math.abs(A[maxRow][i])) maxRow = k;
        }
        [A[i], A[maxRow]] = [A[maxRow], A[i]];
        [b[i], b[maxRow]] = [b[maxRow], b[i]];
        const pivot = A[i][i] || 1e-12;
        for (let j = i; j < n; j++) A[i][j] /= pivot;
        b[i] /= pivot;
        for (let k = 0; k < n; k++) {
          if (k === i) continue;
          const factor = A[k][i];
          for (let j = i; j < n; j++) A[k][j] -= factor * A[i][j];
          b[k] -= factor * b[i];
        }
      }
      return b;
    }

    let activeHandle = null;
    scanHandles.forEach(handle => {
      handle.addEventListener('pointerdown', (e) => {
        if (signatureLocked) return;
        activeHandle = handle.dataset.handle;
        handle.setPointerCapture(e.pointerId);
      });
    });

    window.addEventListener('pointermove', (e) => {
      if (!activeHandle || !scanBaseImage) return;
      const rect = scanCanvas.getBoundingClientRect();
      const x = Math.min(1, Math.max(0, (e.clientX - rect.left) / rect.width));
      const y = Math.min(1, Math.max(0, (e.clientY - rect.top) / rect.height));
      const idx = activeHandle === 'tl' ? 0 : activeHandle === 'tr' ? 1 : activeHandle === 'br' ? 2 : 3;
      scanPoints[idx] = { x, y };
      renderScanCanvas();
    });

    window.addEventListener('pointerup', () => {
      activeHandle = null;
    });

    scanFileInput.addEventListener('change', (e) => {
      if (signatureLocked) return;
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          scanBaseImage = img;
          scanEnhanced = true;
          scanImage = '';
          scanPoints = [
            { x: 0.08, y: 0.12 },
            { x: 0.92, y: 0.12 },
            { x: 0.92, y: 0.88 },
            { x: 0.08, y: 0.88 }
          ];
          resizeScanCanvas();
          checkForm();
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
      e.target.value = '';
    });
    function lockSignatureControls() {
      signatureLocked = true;
      canvas.classList.add('locked');
      signNowBtn.disabled = true;
      penSizeInput.disabled = true;
      typedInput.disabled = true;
      typedFont.disabled = true;
      faxStore.disabled = true;
      faxNumber.disabled = true;
      blankFaxStore.disabled = true;
      blankFaxNumber.disabled = true;
      signedFaxStore.disabled = true;
      signedFaxNumber.disabled = true;
      clearBtn.disabled = true;
      scanFileInput.disabled = true;
      scanHandles.forEach(handle => handle.style.pointerEvents = 'none');
      document.querySelectorAll('.sig-option, .sig-color, #penSize, #typedSignature, #typedFont').forEach(el => {
        if (el.tagName === 'BUTTON' || el.tagName === 'INPUT' || el.tagName === 'SELECT') {
          el.disabled = true;
        }
      });
    }

    penSizeInput.addEventListener('input', (e) => {
      ctx.lineWidth = parseFloat(e.target.value);
    });
    typedInput.addEventListener('input', () => {
      if (signatureMode === 'type') applyTypedSignature();
    });
    typedFont.addEventListener('change', () => {
      if (signatureMode === 'type') applyTypedSignature();
    });
    window.addEventListener('resize', () => {
      resizeCanvas(true);
      resizeScanCanvas();
      updateOrientationHint();
    });
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        resizeCanvas(true);
        resizeScanCanvas();
        updateOrientationHint();
      }, 200);
    });

    resizeCanvas(true);
    updateOrientationHint();

    /* ═══════════════════════════════════════════════════════════
       FORM VALIDATION
       ═══════════════════════════════════════════════════════════ */
    const dateInput = document.getElementById('signDate');
    const today = new Date();
    dateInput.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
    const nameInput = document.getElementById('printedName');
    const consentBox = document.getElementById('digiConsent');
    const submitBtn = document.getElementById('submitBtn');
    function checkForm() {
      const signatureRequired = signatureMode !== 'fax';
      const signatureOk = signatureMode === 'scan' ? !!scanImage : (signatureRequired ? hasSig : true);
      const faxOk = signatureMode === 'fax' ? (!!faxStore.value || !!faxNumber.value.trim()) : true;
      submitBtn.disabled = !(nameInput.value.trim().length > 0 && dateInput.value && consentBox.checked && signatureOk && faxOk);
    }
    nameInput.addEventListener('input', checkForm);
    dateInput.addEventListener('change', checkForm);
    consentBox.addEventListener('change', checkForm);
    faxStore.addEventListener('change', checkForm);
    faxNumber.addEventListener('input', checkForm);

    /* ═══════════════════════════════════════════════════════════
       PDF GENERATION
       ═══════════════════════════════════════════════════════════ */
    let generatedPDF = null, pdfFileName = '';

    function buildFileName() {
      const parts = nameInput.value.trim().split(/\s+/).filter(Boolean);
      const first = parts[0] || 'Unknown';
      const last = parts.length > 1 ? parts[parts.length - 1] : first;
      const dateParts = (dateInput.value || '').split('-');
      const safeFirst = first.replace(/[^a-zA-Z0-9]/g, '_');
      const safeLast = last.replace(/[^a-zA-Z0-9]/g, '_');
      const dateStamp = dateParts.length === 3 ? `${dateParts[0]}_${dateParts[1]}_${dateParts[2]}` : '0000_00_00';
      return `${safeLast}_${safeFirst}_${dateStamp}_Acknowledgement.pdf`;
    }

    function getHeaderLogoData() {
      const img = document.querySelector('.header-logo');
      if (!img || !img.complete || !img.naturalWidth) return null;
      const canvas = document.createElement('canvas');
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      return { dataUrl: canvas.toDataURL('image/png'), aspect: img.naturalWidth / img.naturalHeight };
    }

    function drawHeaderLogo(doc, bannerH, pageW, margin) {
      const logo = getHeaderLogoData();
      if (!logo) return;
      const maxH = bannerH - 4;
      const logoH = Math.min(maxH, 12);
      const logoW = logoH * logo.aspect;
      const x = pageW - margin - logoW;
      const y = (bannerH - logoH) / 2;
      doc.addImage(logo.dataUrl, 'PNG', x, y, logoW, logoH);
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'letter' });
      const pageW = doc.internal.pageSize.getWidth(); const margin = 20; const contentW = pageW - margin * 2; let y = 20;

      if (signatureMode === 'scan' && scanImage) {
        const bannerH = 18;
        doc.setFillColor(13, 27, 42); doc.rect(0, 0, pageW, bannerH, 'F');
        drawHeaderLogo(doc, bannerH, pageW, margin);
        doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.setTextColor(255, 255, 255);
        doc.text('Acknowledgement Scan', margin, 12);
        doc.setFont('helvetica', 'normal'); doc.setFontSize(8); doc.setTextColor(148, 163, 184);
        doc.text(nameInput.value.trim(), pageW - margin, 12, { align: 'right' });
        const imgProps = doc.getImageProperties(scanImage);
        const maxW = pageW - margin * 2;
        const pageH = doc.internal.pageSize.getHeight();
        const maxH = pageH - 30;
        const ratio = Math.min(maxW / imgProps.width, maxH / imgProps.height);
        const imgW = imgProps.width * ratio;
        const imgH = imgProps.height * ratio;
        doc.addImage(scanImage, 'JPEG', margin, 22, imgW, imgH);
        const footerY = pageH - 8;
        doc.setFontSize(7); doc.setTextColor(156, 163, 175);
        doc.text('Scan submitted via camera', margin, footerY);
        pdfFileName = buildFileName();
        generatedPDF = doc;
        return;
      }

      const bannerH = 30;
      doc.setFillColor(13, 27, 42); doc.rect(0, 0, pageW, bannerH, 'F');
      drawHeaderLogo(doc, bannerH, pageW, margin);
      doc.setFont('helvetica', 'bold'); doc.setFontSize(16); doc.setTextColor(255, 255, 255);
      doc.text('ADV Teammate Handbook', margin, 14);
      doc.setFontSize(10); doc.setFont('helvetica', 'normal'); doc.setTextColor(148, 163, 184);
      doc.text('Acknowledgement of Receipt  |  Current version revised February 2025', margin, 23);
      y = 40;

      doc.setFont('helvetica', 'bold'); doc.setFontSize(13); doc.setTextColor(13, 27, 42);
      doc.text('Acknowledgement of Receipt', margin, y); y += 3;
      doc.setDrawColor(74, 144, 196); doc.setLineWidth(0.8); doc.line(margin, y, margin + 60, y); y += 8;

      doc.setFont('helvetica', 'normal'); doc.setFontSize(9.5); doc.setTextColor(55, 65, 81);
      const paras = [
        'I have received a copy of the Company\'s Handbook and the applicable Supplement(s) for the locations in which I work. I agree to read it and to comply with the policies and procedures described in the Handbook and Supplement(s). If I have any questions regarding any of the Handbook\'s provisions, I will consult with my supervisor, manager or Human Resources. I understand that if I do not follow the policies and procedures contained herein that I may be subject to disciplinary action, up to and including termination of employment.',
        'I also understand that this Handbook is the most up-to-date version of the Company\'s policies and procedures and replaces any prior written and oral communications about the subjects contained in it.',
        'I acknowledge that my employment relationship with the Company is "at-will", meaning that, regardless of anything contained in this Handbook and regardless of any custom or practice, either I or the Company may terminate my employment at any time, for any reason or no reason, with or without cause, and with or without procedural requirements. I understand that no representatives of the Company, other than the CEO in a writing signed by him/her/them, may enter into any agreements, or make any representations, written or oral, to alter my at-will status or otherwise create any contractual obligation between me and the Company.',
        'I further acknowledge that this handbook and the policies contained herein are not intended to create (and shall not be construed as creating) a contract (express or implied) for employment between the Company and any Teammate and that said policies can be modified by the Company at any time, with or without notice to me, in its sole and absolute discretion.',
        'By signing below, I acknowledge that I have received and will abide by the Company\'s Handbook and all the policies within it, including those on harassment, discrimination, retaliation, and bringing complaints regarding the same.'
      ];
      paras.forEach(p => { const lines = doc.splitTextToSize(p, contentW); doc.text(lines, margin, y); y += lines.length * 4.2 + 4; });
      y += 4;

      const consentBoxSize = 4;
      doc.setFillColor(241, 245, 249); doc.roundedRect(margin, y, contentW, 16, 2, 2, 'F');
      doc.setDrawColor(100, 116, 139); doc.setLineWidth(0.4);
      doc.rect(margin + 4, y + 4, consentBoxSize, consentBoxSize);
      doc.setDrawColor(34, 197, 94); doc.setLineWidth(0.7);
      doc.line(margin + 4.6, y + 6.2, margin + 5.6, y + 7.2);
      doc.line(margin + 5.6, y + 7.2, margin + 7.6, y + 4.8);
      doc.setFont('helvetica', 'italic'); doc.setFontSize(8); doc.setTextColor(100, 116, 139);
      const ct = 'I agree that my digital signature captured on this device is applied to this acknowledgement and is the legal equivalent of my handwritten signature.';
      doc.text(doc.splitTextToSize(ct, contentW - 16), margin + 10, y + 7); y += 22;

      const colGap = 12;
      const colW = (contentW - colGap) / 2;
      const dateText = new Date(dateInput.value + 'T12:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

      doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.setTextColor(31, 41, 55);
      doc.text(nameInput.value.trim(), margin, y);
      doc.setDrawColor(209, 213, 219); doc.setLineWidth(0.4);
      doc.line(margin, y + 3, margin + contentW, y + 3);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(8); doc.setTextColor(107, 114, 128);
      doc.text('PRINTED TEAMMATE NAME', margin, y + 8);
      y += 16;

      const sigY = y;
      const sigBlockTop = sigY - 1;
      const sigBlockHeight = 14;
      if (signatureMode === 'fax') {
        const faxTarget = faxNumber.value.trim() || (faxStore.value ? `Store ${faxStore.value}` : 'N/A');
        doc.setFont('helvetica', 'italic'); doc.setFontSize(9); doc.setTextColor(100, 116, 139);
        doc.text(`Signature pending via print at ${faxTarget}`, margin, sigY + 8);
      } else if (signatureImage) {
        doc.addImage(signatureImage, 'PNG', margin, sigBlockTop, colW * 0.85, sigBlockHeight);
      }
      doc.setDrawColor(0, 0, 0); doc.setLineWidth(0.6);
      doc.line(margin, sigY + 12, margin + colW, sigY + 12);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(8); doc.setTextColor(107, 114, 128);
      doc.text('TEAMMATE SIGNATURE', margin, sigY + 17);

      doc.setFont('helvetica', 'normal'); doc.setFontSize(11); doc.setTextColor(31, 41, 55);
      doc.text(dateText, margin + colW + colGap, sigY + 8);
      doc.setDrawColor(0, 0, 0); doc.setLineWidth(0.6);
      doc.line(margin + colW + colGap, sigY + 12, margin + colW + colGap + colW, sigY + 12);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(8); doc.setTextColor(107, 114, 128);
      doc.text('DATE', margin + colW + colGap, sigY + 17);

      y = sigY + 24;

      const footerY = doc.internal.pageSize.getHeight() - 12;
      doc.setDrawColor(209, 213, 219); doc.setLineWidth(0.3); doc.line(margin, footerY - 4, pageW - margin, footerY - 4);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(7); doc.setTextColor(156, 163, 175);
      doc.text('\u00A9 2026 Advantage Solutions Inc.  |  Confidential', margin, footerY);
      doc.text('Page 55 of 56', pageW - margin, footerY, { align: 'right' });

      pdfFileName = buildFileName();
      generatedPDF = doc;
    }

    // Printable variant: same content as signed PDF, but with transparent header + black text
    function generatePrintableSignedPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'letter' });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 20;
      const contentW = pageW - margin * 2;
      let y = 20;

      if (signatureMode === 'scan' && scanImage) {
        doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.setTextColor(0, 0, 0);
        doc.text('Acknowledgement Scan', margin, 12);
        doc.setFont('helvetica', 'normal'); doc.setFontSize(9); doc.setTextColor(0, 0, 0);
        doc.text(nameInput.value.trim(), pageW - margin, 12, { align: 'right' });
        const imgProps = doc.getImageProperties(scanImage);
        const maxW = pageW - margin * 2;
        const maxH = pageH - 30;
        const ratio = Math.min(maxW / imgProps.width, maxH / imgProps.height);
        const imgW = imgProps.width * ratio;
        const imgH = imgProps.height * ratio;
        doc.addImage(scanImage, 'JPEG', margin, 22, imgW, imgH);
        const footerY = pageH - 8;
        doc.setFontSize(7); doc.setTextColor(0, 0, 0);
        doc.text('Scan submitted via camera', margin, footerY);
        return doc;
      }

      // Transparent header (no banner fill)
      const headerY = 14;
      const logo = getHeaderLogoData();
      if (logo) {
        const logoH = 12;
        const logoW = logoH * logo.aspect;
        const x = pageW - margin - logoW;
        const yLogo = 6;
        doc.addImage(logo.dataUrl, 'PNG', x, yLogo, logoW, logoH);
      }
      doc.setFont('helvetica', 'bold'); doc.setFontSize(16); doc.setTextColor(0, 0, 0);
      doc.text('ADV Teammate Handbook', margin, headerY);
      doc.setFontSize(10); doc.setFont('helvetica', 'normal'); doc.setTextColor(0, 0, 0);
      doc.text('Acknowledgement of Receipt  |  Current version revised February 2025', margin, 23);
      y = 36;

      // Body (matches signed PDF content)
      doc.setFont('helvetica', 'bold'); doc.setFontSize(13); doc.setTextColor(0, 0, 0);
      doc.text('Acknowledgement of Receipt', margin, y); y += 3;
      doc.setDrawColor(74, 144, 196); doc.setLineWidth(0.8); doc.line(margin, y, margin + 60, y); y += 8;

      doc.setFont('helvetica', 'normal'); doc.setFontSize(9.5); doc.setTextColor(0, 0, 0);
      const paras = [
        'I have received a copy of the Company\'s Handbook and the applicable Supplement(s) for the locations in which I work. I agree to read it and to comply with the policies and procedures described in the Handbook and Supplement(s). If I have any questions regarding any of the Handbook\'s provisions, I will consult with my supervisor, manager or Human Resources. I understand that if I do not follow the policies and procedures contained herein that I may be subject to disciplinary action, up to and including termination of employment.',
        'I also understand that this Handbook is the most up-to-date version of the Company\'s policies and procedures and replaces any prior written and oral communications about the subjects contained in it.',
        'I acknowledge that my employment relationship with the Company is "at-will", meaning that, regardless of anything contained in this Handbook and regardless of any custom or practice, either I or the Company may terminate my employment at any time, for any reason or no reason, with or without cause, and with or without procedural requirements. I understand that no representatives of the Company, other than the CEO in a writing signed by him/her/them, may enter into any agreements, or make any representations, written or oral, to alter my at-will status or otherwise create any contractual obligation between me and the Company.',
        'I further acknowledge that this handbook and the policies contained herein are not intended to create (and shall not be construed as creating) a contract (express or implied) for employment between the Company and any Teammate and that said policies can be modified by the Company at any time, with or without notice to me, in its sole and absolute discretion.',
        'By signing below, I acknowledge that I have received and will abide by the Company\'s Handbook and all the policies within it, including those on harassment, discrimination, retaliation, and bringing complaints regarding the same.'
      ];
      paras.forEach(p => { const lines = doc.splitTextToSize(p, contentW); doc.text(lines, margin, y); y += lines.length * 4.2 + 4; });
      y += 4;

      const consentBoxSize = 4;
      doc.setFillColor(241, 245, 249); doc.roundedRect(margin, y, contentW, 16, 2, 2, 'F');
      doc.setDrawColor(100, 116, 139); doc.setLineWidth(0.4);
      doc.rect(margin + 4, y + 4, consentBoxSize, consentBoxSize);
      doc.setDrawColor(34, 197, 94); doc.setLineWidth(0.7);
      doc.line(margin + 4.6, y + 6.2, margin + 5.6, y + 7.2);
      doc.line(margin + 5.6, y + 7.2, margin + 7.6, y + 4.8);
      doc.setFont('helvetica', 'italic'); doc.setFontSize(8); doc.setTextColor(0, 0, 0);
      const ct = 'I agree that my digital signature captured on this device is applied to this acknowledgement and is the legal equivalent of my handwritten signature.';
      doc.text(doc.splitTextToSize(ct, contentW - 16), margin + 10, y + 7); y += 22;

      const colGap = 12;
      const colW = (contentW - colGap) / 2;
      const dateText = new Date(dateInput.value + 'T12:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

      doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.setTextColor(0, 0, 0);
      doc.text(nameInput.value.trim(), margin, y);
      doc.setDrawColor(0, 0, 0); doc.setLineWidth(0.4);
      doc.line(margin, y + 3, margin + contentW, y + 3);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(8); doc.setTextColor(0, 0, 0);
      doc.text('PRINTED TEAMMATE NAME', margin, y + 8);
      y += 16;

      const sigY = y;
      const sigBlockTop = sigY - 1;
      const sigBlockHeight = 14;
      if (signatureMode === 'fax') {
        const faxTarget = faxNumber.value.trim() || (faxStore.value ? `Store ${faxStore.value}` : 'N/A');
        doc.setFont('helvetica', 'italic'); doc.setFontSize(9); doc.setTextColor(0, 0, 0);
        doc.text(`Signature pending via print at ${faxTarget}`, margin, sigY + 8);
      } else if (signatureImage) {
        doc.addImage(signatureImage, 'PNG', margin, sigBlockTop, colW * 0.85, sigBlockHeight);
      }
      doc.setDrawColor(0, 0, 0); doc.setLineWidth(0.6);
      doc.line(margin, sigY + 12, margin + colW, sigY + 12);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(8); doc.setTextColor(0, 0, 0);
      doc.text('TEAMMATE SIGNATURE', margin, sigY + 17);

      doc.setFont('helvetica', 'normal'); doc.setFontSize(11); doc.setTextColor(0, 0, 0);
      doc.text(dateText, margin + colW + colGap, sigY + 8);
      doc.setDrawColor(0, 0, 0); doc.setLineWidth(0.6);
      doc.line(margin + colW + colGap, sigY + 12, margin + colW + colGap + colW, sigY + 12);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(8); doc.setTextColor(0, 0, 0);
      doc.text('DATE', margin + colW + colGap, sigY + 17);

      const footerY = pageH - 12;
      doc.setDrawColor(0, 0, 0); doc.setLineWidth(0.3); doc.line(margin, footerY - 4, pageW - margin, footerY - 4);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(7); doc.setTextColor(0, 0, 0);
      doc.text('\u00A9 2026 Advantage Solutions Inc.  |  Confidential', margin, footerY);
      doc.text('Page 55 of 56', pageW - margin, footerY, { align: 'right' });

      return doc;
    }

    function updateCloudSaveStatus(state, message) {
      const statusEl = document.getElementById('cloudSaveStatus');
      if (!statusEl) return;
      statusEl.className = 'cloud-save-status';
      if (state) statusEl.classList.add(state);
      statusEl.textContent = message || '';
    }

    function getDeliveryMethod() {
      if (signatureMode === 'scan') return 'scan';
      if (signatureMode === 'fax') {
        const directNum = faxNumber.value.trim().replace(/\D/g, '');
        return directNum ? 'print-direct' : 'print-store';
      }
      return 'digital';
    }

    async function saveAcknowledgementRecord() {
      if (!generatedPDF) return;
      updateCloudSaveStatus('info', 'Saving your acknowledgement to the cloud...');

      if (!FUNCTIONS_BASE) {
        updateCloudSaveStatus('info', 'Cloud save disabled in demo mode.');
        return;
      }

      try {
        const pdfBase64 = generatedPDF.output('datauristring').split(',')[1];
        const payload = {
          employeeName: nameInput.value.trim(),
          signDate: dateInput.value,
          signatureMode: signatureMode,
          signatureDataUrl: signatureMode === 'scan' || signatureMode === 'fax' ? '' : signatureImage,
          scanImageUrl: signatureMode === 'scan' ? scanImage : '',
          pdfBase64,
          pdfFileName: pdfFileName || buildFileName(),
          deliveryMethod: getDeliveryMethod(),
          storeNumber: signatureMode === 'fax' ? (faxStore.value || '') : ''
        };

        const response = await fetch(`${FUNCTIONS_BASE}/saveAcknowledgement`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.error || 'Failed to save acknowledgement');
        }

        updateCloudSaveStatus('success', 'Saved to cloud.');
      } catch (error) {
        console.error('saveAcknowledgement error:', error);
        updateCloudSaveStatus('warn', 'Cloud save failed — you can still download or print.');
      }
    }

    /* ═══════════════════════════════════════════════════════════
       SUBMIT
       ═══════════════════════════════════════════════════════════ */
    function handleSubmit() {
      let err = false;
      let firstErrorEl = null;
      if (!nameInput.value.trim()) {
        document.getElementById('nameRow').classList.add('error');
        if (!firstErrorEl) firstErrorEl = document.getElementById('nameRow');
        err = true;
      } else { document.getElementById('nameRow').classList.remove('error'); }
      const sigError = document.getElementById('sigError');
      if (signatureMode === 'fax') {
        if (!faxStore.value && !faxNumber.value.trim()) {
          sigError.textContent = 'Please select a store or enter a printer number.';
          document.getElementById('sigRow').classList.add('error');
          if (!firstErrorEl) firstErrorEl = document.getElementById('sigRow');
          err = true;
        } else {
          document.getElementById('sigRow').classList.remove('error');
        }
      } else if (signatureMode === 'scan') {
        if (!scanImage) {
          sigError.textContent = 'Please capture and apply a scan of your signed document.';
          document.getElementById('sigRow').classList.add('error');
          if (!firstErrorEl) firstErrorEl = document.getElementById('sigRow');
          err = true;
        } else {
          document.getElementById('sigRow').classList.remove('error');
        }
      } else if (!hasSig) {
        sigError.textContent = 'Please provide your signature above.';
        document.getElementById('sigRow').classList.add('error');
        if (!firstErrorEl) firstErrorEl = document.getElementById('sigRow');
        err = true;
      } else {
        document.getElementById('sigRow').classList.remove('error');
      }
      if (!dateInput.value) {
        document.getElementById('dateRow').classList.add('error');
        if (!firstErrorEl) firstErrorEl = document.getElementById('dateRow');
        err = true;
      } else { document.getElementById('dateRow').classList.remove('error'); }
      if (err) {
        // Smooth scroll to first error on mobile
        if (firstErrorEl) {
          firstErrorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Haptic feedback if available
          if (navigator.vibrate) navigator.vibrate(100);
        }
        return;
      }

      generatePDF();
      lockSignatureControls();
      const signedTrigger = document.getElementById('faxSignedTrigger');
      if (signedTrigger) signedTrigger.setAttribute('aria-disabled', 'false');
      // Haptic feedback on successful submit
      if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
      const fd = new Date(dateInput.value + 'T12:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      let delivery = 'Digital signature';
      if (signatureMode === 'fax') {
        delivery = faxNumber.value.trim() ? `Print at ${faxNumber.value.trim()}` : `Print at store ${faxStore.value}`;
      } else if (signatureMode === 'scan') {
        delivery = 'Camera scan';
      }
      document.getElementById('signerDetail').innerHTML = `<span><strong>Name:</strong> ${nameInput.value.trim()}</span><span><strong>Date:</strong> ${fd}</span><span><strong>Delivery:</strong> ${delivery}</span><span><strong>File:</strong> ${pdfFileName}</span>`;

      const odBtn = document.getElementById('onedriveSaveBtn');
      const odSt = document.getElementById('onedriveStatus');
      if (!ONEDRIVE_CLIENT_ID || typeof OneDrive === 'undefined') {
        odBtn.style.opacity = '0.5'; odBtn.style.cursor = 'not-allowed';
        odSt.textContent = 'OneDrive integration pending — app registration required';
      } else { odBtn.style.opacity = '1'; odBtn.style.cursor = 'pointer'; odSt.textContent = ''; }

      document.getElementById('saveOverlay').classList.add('show');
      saveAcknowledgementRecord();
    }

    /* ═══════════════════════════════════════════════════════════
       ONEDRIVE SAVE
       ═══════════════════════════════════════════════════════════ */
    function saveToOneDrive() {
      if (!ONEDRIVE_CLIENT_ID) { alert('OneDrive integration is not configured yet.\n\nAn Azure AD App Registration (Client ID) is required.\nUse "Download PDF" for now.'); return; }
      if (typeof OneDrive === 'undefined') { alert('OneDrive SDK not loaded.\n\nEnsure the OneDrive.js script tag is uncommented in the HTML head.'); return; }
      const pdfBlob = generatedPDF.output('blob');
      const file = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });
      const dt = new DataTransfer(); dt.items.add(file);
      document.getElementById('hiddenFileInput').files = dt.files;
      OneDrive.save({
        clientId: ONEDRIVE_CLIENT_ID, action: 'save',
        sourceInputElementId: 'hiddenFileInput', fileName: pdfFileName,
        openInNewWindow: true,
        advanced: { redirectUri: window.location.href },
        success: function() { document.getElementById('onedriveStatus').textContent = '✅ Saved to OneDrive successfully.'; document.getElementById('onedriveStatus').style.color = '#22c55e'; },
        cancel: function() { document.getElementById('onedriveStatus').textContent = 'Save cancelled.'; },
        error: function(e) { console.error('OneDrive error:', e); document.getElementById('onedriveStatus').textContent = 'Error saving — try downloading instead.'; document.getElementById('onedriveStatus').style.color = '#ef4444'; }
      });
    }

    function downloadPDF() { if (generatedPDF) generatedPDF.save(pdfFileName); }

    function printLocally() {
      if (!generatedPDF) return;
      const pdfBlob = generatePrintableSignedPDF().output('blob');
      const blobUrl = URL.createObjectURL(pdfBlob);
      const printWindow = window.open(blobUrl, '_blank');
      if (printWindow) {
        printWindow.addEventListener('load', () => {
          printWindow.focus();
          printWindow.print();
        });
      } else {
        // Fallback if popup blocked: open in iframe
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = blobUrl;
        document.body.appendChild(iframe);
        iframe.addEventListener('load', () => {
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
          setTimeout(() => { document.body.removeChild(iframe); URL.revokeObjectURL(blobUrl); }, 1000);
        });
      }
    }
    function closeSaveOverlay() { document.getElementById('saveOverlay').classList.remove('show'); }
    // Legacy functions - now open the fax modal
    function sendBlankFax() {
      openFaxModal('blank');
    }
    function sendSignedFax() {
      openFaxModal('signed');
    }
    document.querySelectorAll('.option-dropdown').forEach(dropdown => dropdown.removeAttribute('open'));
    resizeScanCanvas();
    setSignatureMode('draw');
    checkForm();

    // Highlight the Sign button since we're on the acknowledgement page
    function highlightCurrentPage() {
      document.querySelectorAll('.home-bottom-nav .toolbar-btn, .app-toolbar .toolbar-btn').forEach(btn => {
        btn.classList.remove('active');
        const onclickAttr = btn.getAttribute('onclick');
        if (onclickAttr && onclickAttr.includes('goSign')) {
          btn.classList.add('active');
        }
      });
    }
    highlightCurrentPage();
  </script>
</body>
</html>
