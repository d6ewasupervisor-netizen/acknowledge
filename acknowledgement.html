<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0d1b2a">
  <title>Acknowledgement of Receipt — ADV Teammate Handbook</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=DM+Serif+Display&family=Dancing+Script:wght@400;600&family=Great+Vibes&family=Pacifico&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --navy-950: #060e1a;
      --navy-900: #0d1b2a;
      --navy-800: #1b2d4a;
      --navy-700: #243b5e;
      --navy-600: #2e4a72;
      --blue-500: #4a90c4;
      --blue-400: #6aaddb;
      --blue-300: #7cb9d8;
      --blue-200: #a3d5e8;
      --blue-100: #d4ecf5;
      --blue-50: #eef7fb;
      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-300: #cbd5e1;
      --slate-400: #94a3b8;
      --slate-500: #64748b;
      --slate-600: #475569;
      --slate-700: #334155;
      --slate-800: #1e293b;
      --slate-900: #0f172a;
      --white: #ffffff;
      --red-500: #ef4444;
      --green-500: #22c55e;
      --bottom-nav-height: calc(68px * 1.2);
      --bottom-nav-scale: 1.2;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
      background: var(--navy-950);
      color: var(--slate-800);
      line-height: 1.6;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, var(--navy-950) 0%, var(--navy-900) 50%, var(--navy-800) 100%);
      padding: 2.25rem 2.25rem;
      text-align: center;
      position: relative;
      overflow: hidden;
      border-bottom: 1px solid rgba(74,144,196,0.15);
    }
    .header::before {
      content: '';
      position: absolute; top: -60%; right: -10%;
      width: 400px; height: 400px;
      background: radial-gradient(circle, rgba(74,144,196,0.08) 0%, transparent 70%);
      border-radius: 50%; pointer-events: none;
    }
    .header-inner {
      max-width: 720px; margin: 0 auto;
      position: relative; z-index: 1;
    }
    .header-logo {
      height: clamp(40px, 7vw, 56px);
      max-width: 70vw;
      object-fit: contain;
      margin-bottom: 1rem;
    }
    .header h1 {
      font-family: 'DM Serif Display', serif;
      font-size: clamp(1.3rem, 3.5vw, 1.75rem);
      font-weight: 400;
      color: var(--white);
      margin-bottom: 0.35rem;
    }
    .header p { color: var(--slate-400); font-size: 0.85rem; }
    .header p .header-sub { display: block; }

    .container { max-width: 720px; margin: 0 auto; padding: 2.25rem 1.75rem calc(4.5rem + var(--bottom-nav-height)); }

    .download-card,
    .option-card {
      background: var(--navy-900);
      border: 1px solid rgba(74,144,196,0.15);
      border-radius: 12px;
      padding: 1.5rem 1.75rem;
      margin-bottom: 1.75rem;
      display: flex; align-items: center; gap: 1rem;
      transition: border-color 0.2s ease;
    }
    .download-card:hover,
    .option-card:hover { border-color: rgba(74,144,196,0.3); }
    .option-card { align-items: flex-start; gap: 1.25rem; }
    .option-card h3 {
      font-size: 0.95rem; font-weight: 700; color: var(--white);
      margin-bottom: 0.35rem;
    }
    .option-card p { font-size: 0.8rem; color: var(--slate-500); }
    .option-actions { display: grid; gap: 0.75rem; width: 100%; }
    .option-actions .sig-row { background: rgba(255,255,255,0.02); }
    .option-actions input, .option-actions select {
      width: 100%; padding: 0.6rem 0.75rem;
      border-radius: 8px; border: 1px solid rgba(74,144,196,0.2);
      background: rgba(255,255,255,0.04); color: var(--white);
      font-family: inherit; font-size: 0.88rem;
    }
    .option-btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
      padding: 0.6rem 1rem; border-radius: 8px; border: none;
      background: var(--blue-500); color: var(--white); font-weight: 600;
      cursor: pointer; transition: background 0.15s ease;
    }
    .option-btn:hover { background: var(--blue-400); }
    .option-hint { font-size: 0.75rem; color: var(--slate-500); }
    .download-icon {
      flex-shrink: 0;
      width: 48px; height: 48px;
      background: rgba(74,144,196,0.1);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
    }
    .download-icon svg { width: 24px; height: 24px; color: var(--blue-400); }
    .download-info { flex: 1; }
    .download-info h3 { font-size: 0.9rem; font-weight: 600; color: var(--white); margin-bottom: 0.1rem; }
    .download-info p { font-size: 0.78rem; color: var(--slate-500); }
    .download-btn {
      flex-shrink: 0;
      display: inline-flex; align-items: center; gap: 0.4rem;
      background: var(--blue-500); color: var(--white);
      text-decoration: none;
      font-size: 0.82rem; font-weight: 600;
      padding: 0.55rem 1.1rem; border-radius: 8px;
      transition: background 0.2s ease;
    }
    .download-btn:hover { background: var(--blue-400); }
    .download-btn svg { width: 14px; height: 14px; }

    .option-dropdown {
      padding: 0;
      display: block;
    }
    .option-dropdown summary {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem 1.75rem;
      cursor: pointer;
    }
    .option-dropdown summary::-webkit-details-marker { display: none; }
    .option-dropdown .option-summary {
      flex: 1;
    }
    .option-dropdown .option-summary h3 {
      margin-bottom: 0.25rem;
    }
    .option-dropdown .option-chevron {
      width: 18px;
      height: 18px;
      color: var(--slate-500);
      transition: transform 0.2s ease;
    }
    .option-dropdown[open] .option-chevron { transform: rotate(180deg); }
    .option-dropdown-body {
      padding: 0 1.75rem 1.5rem;
      border-top: 1px solid rgba(74,144,196,0.12);
    }

    .card {
      background: var(--navy-900);
      border: 1px solid rgba(74,144,196,0.12);
      border-radius: 12px;
      padding: 2rem 1.75rem;
      margin-bottom: 1.75rem;
    }
    .card h2 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.25rem;
      font-weight: 400;
      color: var(--white);
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid rgba(74,144,196,0.15);
    }
    .ack-text { font-size: 0.88rem; line-height: 1.8; color: var(--slate-300); }
    .ack-text p { margin-bottom: 0.85rem; }
    .ack-text p:last-child { margin-bottom: 0; }

    .form-row { margin-bottom: 1.4rem; }
    .form-row label {
      display: block;
      font-size: 0.75rem; font-weight: 700;
      color: var(--slate-400);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.4rem;
    }
    .form-row input[type="text"],
    .form-row input[type="date"] {
      width: 100%;
      padding: 0.7rem 0.9rem;
      font-family: inherit; font-size: 0.92rem;
      color: var(--white);
      background: rgba(255,255,255,0.05);
      border: 1.5px solid rgba(74,144,196,0.2);
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-row input::placeholder { color: var(--slate-600); }
    .form-row input:focus {
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px rgba(74,144,196,0.15);
    }
    /* Fix date input color for dark theme */
    .form-row input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(0.7);
    }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 540px) { .form-grid { grid-template-columns: 1fr; } }

    .sig-container { position: relative; }
    .sig-canvas {
      width: 100%; height: 160px;
      background: rgba(255,255,255,0.03);
      border: 1.5px solid rgba(74,144,196,0.2);
      border-radius: 8px;
      cursor: crosshair; touch-action: none;
      transition: border-color 0.2s;
    }
    .sig-canvas.disabled { cursor: not-allowed; pointer-events: none; opacity: 0.7; }
    .sig-canvas.locked { pointer-events: none; }
    .sig-canvas.active { border-color: var(--blue-500); box-shadow: 0 0 0 3px rgba(74,144,196,0.15); }
    .sig-canvas.has-signature { border-color: var(--blue-500); }
    .sig-placeholder {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: var(--slate-600); font-size: 0.82rem;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .sig-placeholder.hidden { opacity: 0; }
    .sig-line {
      position: absolute; bottom: 36px; left: 20px; right: 20px;
      height: 1px; background: rgba(74,144,196,0.15);
      pointer-events: none;
    }
    .sig-clear,
    .sig-save {
      position: absolute; top: 8px; right: 8px;
      background: var(--navy-800);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 6px;
      padding: 0.25rem 0.55rem;
      font-size: 0.7rem; font-weight: 600;
      color: var(--slate-500);
      cursor: pointer;
      opacity: 0; transition: opacity 0.2s, color 0.15s;
    }
    .sig-save { right: 64px; }
    .sig-clear.visible { opacity: 1; }
    .sig-save.visible { opacity: 1; }
    .sig-clear:hover { color: var(--red-500); }
    .sig-save:hover { color: var(--blue-200); }

    .sig-controls {
      display: grid; gap: 0.9rem;
      margin-bottom: 1.2rem;
    }
    .sig-toggle {
      display: grid; grid-template-columns: repeat(3, minmax(56px, 1fr));
      gap: 0.6rem;
    }
    .sig-option {
      background: rgba(74,144,196,0.08);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 10px;
      padding: 0.55rem 0.6rem;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 0.8rem; font-weight: 600; color: var(--slate-300);
      cursor: pointer; transition: all 0.15s ease;
    }
    .sig-option.active { background: rgba(74,144,196,0.2); color: var(--white); border-color: rgba(74,144,196,0.4); }
    .sig-option svg {
      width: 20px;
      height: 20px;
      stroke-width: 1.8;
    }
    .sig-row {
      display: flex; flex-wrap: wrap; gap: 0.85rem; align-items: center;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(74,144,196,0.15);
      border-radius: 10px;
      padding: 0.85rem;
    }
    .sig-row label { font-size: 0.72rem; letter-spacing: 0.05em; text-transform: uppercase; color: var(--slate-500); }
    .sig-ink {
      display: flex; align-items: center; gap: 0.5rem;
    }
    .sig-color {
      width: 30px; height: 30px; border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      cursor: pointer; transition: transform 0.15s ease, border-color 0.15s ease;
    }
    .sig-color.active { border-color: var(--white); transform: scale(1.05); }
    .sig-size input[type="range"] { width: 140px; }
    .sig-action-btn {
      padding: 0.5rem 0.9rem; border-radius: 8px; border: 1px solid rgba(74,144,196,0.25);
      background: rgba(74,144,196,0.15); color: var(--white); font-weight: 600;
      cursor: pointer; transition: background 0.15s ease;
    }
    .sig-action-btn.secondary { background: rgba(255,255,255,0.05); color: var(--slate-300); }
    .sig-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .sig-typed-controls { display: grid; gap: 0.5rem; width: 100%; }
    .sig-typed-controls input, .sig-typed-controls select {
      width: 100%; padding: 0.6rem 0.75rem;
      border-radius: 8px; border: 1px solid rgba(74,144,196,0.2);
      background: rgba(255,255,255,0.04); color: var(--white);
      font-family: inherit; font-size: 0.9rem;
    }
    .sig-hint {
      font-size: 0.75rem; color: var(--slate-500);
      margin-top: 0.4rem;
    }
    .sig-hidden { display: none !important; }
    .scan-panel {
      display: grid; gap: 0.8rem;
      border: 1px dashed rgba(74,144,196,0.3);
      border-radius: 12px;
      padding: 0.9rem;
      background: rgba(255,255,255,0.02);
    }
    .scan-actions {
      display: flex; flex-wrap: wrap; gap: 0.6rem;
      align-items: center;
    }
    .scan-canvas-wrap {
      position: relative;
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      background: rgba(0,0,0,0.2);
    }
    #scanCanvas {
      width: 100%;
      height: 320px;
      display: block;
      background: #111827;
    }
    .scan-handle {
      position: absolute;
      width: 16px; height: 16px;
      background: var(--blue-300);
      border: 2px solid var(--white);
      border-radius: 50%;
      cursor: grab;
      transform: translate(-50%, -50%);
    }
    .scan-handle:active { cursor: grabbing; }
    .scan-overlay {
      position: absolute; inset: 0;
      border: 2px solid rgba(74,144,196,0.7);
      pointer-events: none;
    }

    .consent-row {
      margin: 1.65rem 0 1.4rem;
      display: flex; align-items: flex-start; gap: 0.85rem;
    }
    .consent-row input[type="checkbox"] {
      flex-shrink: 0;
      width: 20px; height: 20px;
      margin-top: 2px;
      accent-color: var(--blue-500);
      cursor: pointer;
    }
    .consent-row label {
      font-size: 0.85rem; color: var(--slate-300);
      line-height: 1.5; cursor: pointer;
      text-transform: none; letter-spacing: normal; font-weight: 400;
    }
    .consent-row label strong { font-weight: 700; color: var(--blue-300); }

    .submit-btn {
      width: 100%;
      padding: 0.85rem 1.5rem;
      font-family: inherit; font-size: 1rem; font-weight: 700;
      color: var(--white);
      background: var(--blue-500);
      border: none; border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s, opacity 0.2s;
    }
    .submit-btn:hover:not(:disabled) { background: var(--blue-400); }
    .submit-btn:active:not(:disabled) { transform: scale(0.99); }
    .submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .error-msg { font-size: 0.75rem; color: var(--red-500); margin-top: 0.3rem; display: none; }
    .form-row.error input, .form-row.error .sig-canvas { border-color: var(--red-500) !important; }
    .form-row.error .error-msg { display: block; }

    /* Save Overlay */
    .save-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(6,14,26,0.75);
      backdrop-filter: blur(8px);
      z-index: 100;
      align-items: center; justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    .save-overlay.show { display: flex; }
    .save-card {
      background: var(--navy-900);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 16px;
      padding: 2.5rem 2rem;
      text-align: center;
      max-width: 480px; width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.4s ease;
    }
    .save-icon {
      width: 64px; height: 64px;
      background: rgba(34,197,94,0.12);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 1.25rem;
    }
    .save-icon svg { width: 32px; height: 32px; color: var(--green-500); }
    .save-card h3 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.3rem; font-weight: 400;
      color: var(--white);
      margin-bottom: 0.5rem;
    }
    .save-card > p { font-size: 0.88rem; color: var(--slate-400); margin-bottom: 1.5rem; line-height: 1.6; }
    .signer-detail {
      font-size: 0.8rem; color: var(--slate-400);
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(74,144,196,0.1);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 1.5rem;
      text-align: left;
    }
    .signer-detail span { display: block; margin-bottom: 0.2rem; }
    .signer-detail strong { color: var(--slate-300); }

    .save-buttons { display: flex; flex-direction: column; gap: 0.75rem; }
    .save-btn {
      display: flex; align-items: center; justify-content: center; gap: 0.6rem;
      padding: 0.8rem 1.5rem;
      border-radius: 10px;
      font-family: inherit; font-size: 0.92rem; font-weight: 600;
      cursor: pointer; border: none;
      transition: all 0.2s ease;
      text-decoration: none;
    }
    .save-btn svg { width: 20px; height: 20px; flex-shrink: 0; }
    .save-btn.onedrive { background: #0078d4; color: var(--white); }
    .save-btn.onedrive:hover { background: #106ebe; }
    .save-btn.download {
      background: rgba(255,255,255,0.06);
      color: var(--slate-300);
      border: 1px solid rgba(74,144,196,0.2);
    }
    .save-btn.download:hover { background: rgba(255,255,255,0.1); }
    .save-btn.done {
      background: transparent;
      color: var(--slate-500);
      font-size: 0.82rem; font-weight: 500;
      padding: 0.5rem;
    }
    .save-btn.done:hover { color: var(--slate-300); }
    .onedrive-status { font-size: 0.75rem; color: var(--slate-500); margin-top: 0.2rem; font-style: italic; }

    #hiddenFileInput { display: none; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .footer {
      text-align: center;
      padding: 2.25rem 1rem calc(2.25rem + var(--bottom-nav-height));
      font-size: 0.75rem;
      color: var(--slate-600);
    }

    .alternate-options {
      margin-top: 0.75rem;
    }
    .alternate-label {
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--slate-500);
      margin: 0.25rem 0 0.9rem;
      padding-left: 0.35rem;
    }

    .toolbar-btn {
      display: flex; align-items: center; justify-content: center; gap: 0.35rem;
      padding: 0.4rem 0.6rem;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: var(--slate-400);
      font-family: inherit; font-size: 0.75rem; font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }
    .toolbar-btn:hover { background: rgba(74,144,196,0.1); color: var(--blue-300); }
    .toolbar-btn svg { width: 16px; height: 16px; flex-shrink: 0; }
    .toolbar-btn .btn-label { display: inline; }
    @media (max-width: 640px) { .toolbar-btn .btn-label { display: none; } }
    .toolbar-btn.ack-btn {
      background: var(--blue-500);
      color: var(--white);
      border-color: var(--blue-500);
    }

    .home-bottom-nav {
      display: flex;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: calc(0.5rem * var(--bottom-nav-scale)) calc(0.75rem * var(--bottom-nav-scale)) max(calc(0.5rem * var(--bottom-nav-scale)), env(safe-area-inset-bottom));
      background: rgba(6,14,26,0.98);
      border-top: 1px solid rgba(74,144,196,0.15);
      gap: calc(0.5rem * var(--bottom-nav-scale));
      z-index: 6;
    }
    .home-bottom-nav .toolbar-btn {
      flex: 1;
      justify-content: center;
      padding: calc(0.4rem * var(--bottom-nav-scale)) calc(0.6rem * var(--bottom-nav-scale));
      font-size: calc(0.75rem * var(--bottom-nav-scale));
      border-radius: calc(6px * var(--bottom-nav-scale));
    }
    .home-bottom-nav .toolbar-btn svg {
      width: calc(16px * var(--bottom-nav-scale));
      height: calc(16px * var(--bottom-nav-scale));
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(74,144,196,0.2); border-radius: 3px; }

    @media print {
      body { background: white; color: #1e293b; }
      .download-card, .option-card, .submit-btn, .sig-clear, .consent-row, .header-nav { display: none !important; }
      .card { box-shadow: none; border: 1px solid #ccc; background: white; }
      .card h2 { color: #0d1b2a; border-color: #ddd; }
      .ack-text { color: #334155; }
    }

    /* ═══════════════════════════════════════════════════════════
       FAX MODAL STYLES
       ═══════════════════════════════════════════════════════════ */
    .fax-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(6,14,26,0.8);
      backdrop-filter: blur(8px);
      z-index: 200;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    .fax-modal-overlay.show { display: flex; }

    .fax-modal {
      background: var(--navy-900);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 16px;
      width: 90%;
      max-width: 520px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      overflow: hidden;
    }

    .fax-modal-header {
      padding: 1.5rem 1.5rem 1rem;
      border-bottom: 1px solid rgba(74,144,196,0.12);
      flex-shrink: 0;
    }
    .fax-modal-header h3 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.25rem;
      font-weight: 400;
      color: var(--white);
      margin-bottom: 0.35rem;
    }
    .fax-modal-header p {
      font-size: 0.82rem;
      color: var(--slate-400);
      line-height: 1.5;
    }
    .fax-modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      color: var(--slate-500);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 8px;
      transition: color 0.15s, background 0.15s;
    }
    .fax-modal-close:hover {
      color: var(--slate-300);
      background: rgba(255,255,255,0.05);
    }
    .fax-modal-close svg { width: 20px; height: 20px; }

    .fax-search-wrap {
      padding: 0 1.5rem 1rem;
      flex-shrink: 0;
    }
    .fax-search {
      width: 100%;
      padding: 0.7rem 1rem 0.7rem 2.5rem;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 10px;
      color: var(--white);
      font-family: inherit;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .fax-search::placeholder { color: var(--slate-600); }
    .fax-search:focus {
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px rgba(74,144,196,0.15);
    }
    .fax-search-icon {
      position: absolute;
      left: 0.85rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--slate-500);
      pointer-events: none;
    }
    .fax-search-icon svg { width: 16px; height: 16px; }
    .fax-search-container { position: relative; }

    .fax-store-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 0.75rem;
      min-height: 200px;
      max-height: 300px;
    }
    .fax-store-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 0.85rem;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s;
      border: 1px solid transparent;
    }
    .fax-store-item:hover { background: rgba(74,144,196,0.08); }
    .fax-store-item.selected {
      background: rgba(74,144,196,0.15);
      border-color: rgba(74,144,196,0.3);
    }
    .fax-store-radio {
      width: 20px;
      height: 20px;
      border: 2px solid var(--slate-500);
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.15s;
    }
    .fax-store-item.selected .fax-store-radio {
      border-color: var(--blue-400);
    }
    .fax-store-radio-inner {
      width: 10px;
      height: 10px;
      background: var(--blue-400);
      border-radius: 50%;
      opacity: 0;
      transform: scale(0);
      transition: opacity 0.15s, transform 0.15s;
    }
    .fax-store-item.selected .fax-store-radio-inner {
      opacity: 1;
      transform: scale(1);
    }
    .fax-store-info { flex: 1; }
    .fax-store-number {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--white);
    }
    .fax-store-location {
      font-size: 0.78rem;
      color: var(--slate-400);
    }
    .fax-store-check {
      color: var(--green-500);
      opacity: 0;
      transition: opacity 0.15s;
    }
    .fax-store-item.selected .fax-store-check { opacity: 1; }
    .fax-store-check svg { width: 20px; height: 20px; }

    .fax-no-results {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--slate-500);
      font-size: 0.88rem;
    }

    .fax-divider {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      color: var(--slate-500);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .fax-divider::before,
    .fax-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(74,144,196,0.15);
    }

    .fax-direct-input-wrap {
      padding: 0 1.5rem 1rem;
    }
    .fax-direct-input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 10px;
      color: var(--white);
      font-family: inherit;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .fax-direct-input::placeholder { color: var(--slate-600); }
    .fax-direct-input:focus {
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px rgba(74,144,196,0.15);
    }
    .fax-direct-hint {
      font-size: 0.75rem;
      color: var(--slate-500);
      margin-top: 0.4rem;
      padding-left: 0.25rem;
    }

    .fax-modal-footer {
      padding: 1rem 1.5rem 1.5rem;
      border-top: 1px solid rgba(74,144,196,0.12);
      flex-shrink: 0;
    }
    .fax-send-btn {
      width: 100%;
      padding: 0.85rem 1.5rem;
      background: var(--blue-500);
      color: var(--white);
      border: none;
      border-radius: 10px;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: background 0.2s, opacity 0.2s;
    }
    .fax-send-btn:hover:not(:disabled) { background: var(--blue-400); }
    .fax-send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .fax-send-btn svg { width: 18px; height: 18px; }
    .fax-send-btn .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .fax-status {
      margin-top: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.82rem;
      text-align: center;
      display: none;
    }
    .fax-status.show { display: block; }
    .fax-status.success {
      background: rgba(34,197,94,0.1);
      color: var(--green-500);
      border: 1px solid rgba(34,197,94,0.2);
    }
    .fax-status.error {
      background: rgba(239,68,68,0.1);
      color: var(--red-500);
      border: 1px solid rgba(239,68,68,0.2);
    }
    .fax-status.info {
      background: rgba(74,144,196,0.1);
      color: var(--blue-300);
      border: 1px solid rgba(74,144,196,0.2);
    }

    /* Fax Trigger Card */
    .fax-trigger-card {
      background: linear-gradient(135deg, rgba(74,144,196,0.08) 0%, rgba(13,27,42,0.95) 100%);
      border: 1px solid rgba(74,144,196,0.2);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.75rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: border-color 0.2s, transform 0.1s;
    }
    .fax-trigger-card:hover {
      border-color: rgba(74,144,196,0.4);
    }
    .fax-trigger-card:active { transform: scale(0.995); }
    .fax-trigger-icon {
      width: 48px;
      height: 48px;
      background: rgba(74,144,196,0.15);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .fax-trigger-icon svg { width: 24px; height: 24px; color: var(--blue-400); }
    .fax-trigger-content { flex: 1; }
    .fax-trigger-content h3 {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--white);
      margin-bottom: 0.25rem;
    }
    .fax-trigger-content p {
      font-size: 0.8rem;
      color: var(--slate-400);
      line-height: 1.4;
    }
    .fax-trigger-arrow {
      color: var(--slate-500);
      transition: color 0.15s, transform 0.15s;
    }
    .fax-trigger-card:hover .fax-trigger-arrow {
      color: var(--blue-400);
      transform: translateX(3px);
    }
    .fax-trigger-arrow svg { width: 20px; height: 20px; }

    /* Mobile Bottom Sheet */
    @media (max-width: 640px) {
      .fax-modal-overlay {
        align-items: flex-end;
      }
      .fax-modal {
        width: 100%;
        max-width: 100%;
        max-height: 90vh;
        border-radius: 20px 20px 0 0;
        animation: slideUpSheet 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .fax-modal-header {
        padding: 1.25rem 1.25rem 0.85rem;
        position: relative;
      }
      .fax-modal-header::before {
        content: '';
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 36px;
        height: 4px;
        background: rgba(255,255,255,0.15);
        border-radius: 2px;
      }
      .fax-modal-header h3 { font-size: 1.15rem; }
      .fax-search-wrap { padding: 0 1.25rem 0.85rem; }
      .fax-store-list { max-height: 35vh; }
      .fax-divider { padding: 0.85rem 1.25rem; }
      .fax-direct-input-wrap { padding: 0 1.25rem 0.85rem; }
      .fax-modal-footer {
        padding: 1rem 1.25rem calc(1rem + env(safe-area-inset-bottom));
      }
      .fax-trigger-card { padding: 1rem 1.15rem; gap: 0.85rem; }
      .fax-trigger-icon { width: 42px; height: 42px; }
      .fax-trigger-content h3 { font-size: 0.88rem; }
    }
    @keyframes slideUpSheet {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    /* ═══════ MOBILE ═══════ */
    @media (max-width: 640px) {
      body { -webkit-tap-highlight-color: transparent; }
      .header { padding: 1.6rem 1rem; padding-top: max(1.6rem, env(safe-area-inset-top)); }
      .header-logo { max-height: 44px; }
      .header h1 { font-size: 1.25rem; }
      .container { padding: 1.4rem 0.9rem calc(3.25rem + var(--bottom-nav-height)); }

      .download-card, .option-card { padding: 1.1rem; gap: 0.75rem; flex-wrap: wrap; }
      .download-icon { width: 42px; height: 42px; }
      .download-info h3 { font-size: 0.85rem; }
      .download-btn { font-size: 0.8rem; padding: 0.5rem 0.9rem; }

      .card { padding: 1.35rem 1.1rem; }
      .card h2 { font-size: 1.1rem; }
      .ack-text { font-size: 0.84rem; line-height: 1.75; }

      .form-row input[type="text"],
      .form-row input[type="date"] {
        padding: 0.8rem 0.9rem;
        font-size: 1rem; /* 16px prevents iOS zoom on focus */
      }
      .sig-canvas { height: 140px; }
      .consent-row label { font-size: 0.82rem; }
      .submit-btn { padding: 0.9rem 1.5rem; font-size: 0.95rem; }

      .save-card { padding: 2rem 1.35rem; width: 95%; }
      .save-card h3 { font-size: 1.15rem; }
      .save-btn { padding: 0.85rem 1rem; font-size: 0.88rem; }
    }

    @media (max-width: 380px) {
      .header { padding: 1.3rem 0.75rem; }
      .header-logo { max-height: 36px; }
      .container { padding: 1.1rem 0.6rem calc(2.7rem + var(--bottom-nav-height)); }
      .card { padding: 1.1rem 0.85rem; }
      .download-card, .option-card { flex-direction: column; text-align: left; }
    }

    button, a, input[type="checkbox"] { touch-action: manipulation; }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-inner">
      <img src="home_header_logo.png" alt="The Retail Odyssey Company" class="header-logo">
      <h1>Teammate Handbook Acknowledgement</h1>
      <p>
        <span class="header-sub">This page revised February 2026</span>
        <span class="header-sub">Review, accept, and sign.</span>
      </p>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2>Acknowledgement of Receipt</h2>
      <div class="ack-text">
        <p>I have received a copy of the Company's Handbook and the applicable Supplement(s) for the locations in which I work. I agree to read it and to comply with the policies and procedures described in the Handbook and Supplement(s). If I have any questions regarding any of the Handbook's provisions, I will consult with my supervisor, manager or Human Resources. I understand that if I do not follow the policies and procedures contained herein that I may be subject to disciplinary action, up to and including termination of employment.</p>
        <p>I also understand that this Handbook is the most up-to-date version of the Company's policies and procedures and replaces any prior written and oral communications about the subjects contained in it.</p>
        <p>I acknowledge that my employment relationship with the Company is "at-will", meaning that, regardless of anything contained in this Handbook and regardless of any custom or practice, either I or the Company may terminate my employment at any time, for any reason or no reason, with or without cause, and with or without procedural requirements. I understand that no representatives of the Company, other than the CEO in a writing signed by him/her/them, may enter into any agreements, or make any representations, written or oral, to alter my at-will status or otherwise create any contractual obligation between me and the Company.</p>
        <p>I further acknowledge that this handbook and the policies contained herein are not intended to create (and shall not be construed as creating) a contract (express or implied) for employment between the Company and any Teammate and that said policies can be modified by the Company at any time, with or without notice to me, in its sole and absolute discretion.</p>
        <p>By signing below, I acknowledge that I have received and will abide by the Company's Handbook and all the policies within it, including those on harassment, discrimination, retaliation, and bringing complaints regarding the same.</p>
      </div>
    </section>

    <section class="card">
      <h2>Sign Below</h2>
      <div class="form-row" id="nameRow">
        <label for="printedName">Printed Teammate Name</label>
        <input type="text" id="printedName" placeholder="Enter your full legal name" autocomplete="name">
        <div class="error-msg">Please enter your full name.</div>
      </div>
      <div class="form-row" id="sigRow">
        <label>Teammate Signature</label>
        <div class="sig-controls">
          <div class="sig-toggle">
            <button type="button" class="sig-option active" data-mode="draw" aria-label="Draw signature" title="Draw signature" onclick="setSignatureMode('draw')">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487 19.5 7.125m-2.638-2.638L7.5 13.849l-1.5 4.651 4.651-1.5 9.362-9.363a1.875 1.875 0 0 0-2.651-2.651Z"/></svg>
            </button>
            <button type="button" class="sig-option" data-mode="type" aria-label="Type signature" title="Type signature" onclick="setSignatureMode('type')">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 4.5h9m-9 4.5h6M4.5 6h15a1.5 1.5 0 0 1 1.5 1.5v9a1.5 1.5 0 0 1-1.5 1.5h-15A1.5 1.5 0 0 1 3 16.5v-9A1.5 1.5 0 0 1 4.5 6Z"/></svg>
            </button>
            <button type="button" class="sig-option" data-mode="upload" aria-label="Upload signature" title="Upload signature" onclick="setSignatureMode('upload')">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V6m0 0-3.75 3.75M12 6l3.75 3.75M4.5 16.5v2.25A2.25 2.25 0 0 0 6.75 21h10.5A2.25 2.25 0 0 0 19.5 18.75V16.5"/></svg>
            </button>
          </div>
          <div class="sig-row" id="drawControls">
            <button type="button" class="sig-action-btn" id="signNowBtn" onclick="enableSignaturePad()">Sign Now</button>
            <div class="sig-ink">
              <label>Ink</label>
              <button type="button" class="sig-color active" id="inkBlack" title="Black ink" style="background:#0f172a;" onclick="setInkColor('#0f172a')"></button>
              <button type="button" class="sig-color" id="inkBlue" title="Blue ink" style="background:#1d4ed8;" onclick="setInkColor('#1d4ed8')"></button>
            </div>
            <div class="sig-size">
              <label for="penSize">Point</label>
              <input type="range" id="penSize" min="1" max="6" step="0.5" value="2">
            </div>
          </div>
          <div class="sig-row sig-hidden" id="typeControls">
            <div class="sig-typed-controls">
              <label for="typedSignature">Type Your Signature</label>
              <input type="text" id="typedSignature" placeholder="Enter your full signature">
            </div>
            <div class="sig-typed-controls">
              <label for="typedFont">Signature Font</label>
              <select id="typedFont">
                <option value="'Dancing Script', cursive">Dancing Script</option>
                <option value="'Great Vibes', cursive">Great Vibes</option>
                <option value="'Pacifico', cursive">Pacifico</option>
              </select>
            </div>
            <button type="button" class="sig-action-btn secondary" onclick="applyTypedSignature()">Apply Signature</button>
          </div>
          <div class="sig-row sig-hidden" id="uploadControls">
            <div>
              <label>Upload Signature Image</label>
              <div class="sig-hint">PNG or JPG works best with a transparent or light background.</div>
            </div>
            <button type="button" class="sig-action-btn" onclick="triggerSignatureUpload()">Choose Image</button>
          </div>
          <div class="sig-row sig-hidden" id="faxControls">
            <div class="sig-typed-controls">
              <label for="faxStore">Select Fred Meyer Store</label>
              <select id="faxStore">
                <option value="">Choose a store number</option>
              </select>
            </div>
            <div class="sig-typed-controls">
              <label for="faxNumber">Fax Number</label>
              <input type="text" id="faxNumber" placeholder="+1 555 555 5555">
            </div>
            <div class="sig-hint">We will route a fax-ready acknowledgement to your selected store or fax number.</div>
            <div class="sig-hint">To send to any fax machine, enter the full number including country code.</div>
          </div>
          <div class="sig-row sig-hidden" id="scanControls">
            <div class="scan-panel">
              <div class="scan-actions">
                <button type="button" class="sig-action-btn" onclick="triggerScanCapture()">Capture Photo</button>
                <button type="button" class="sig-action-btn secondary" onclick="autoEnhanceScan()">Auto Enhance</button>
                <button type="button" class="sig-action-btn secondary" onclick="applyScanCrop()">Apply Crop</button>
                <button type="button" class="sig-action-btn secondary" onclick="resetScan()">Retake</button>
              </div>
              <div class="scan-canvas-wrap" id="scanWrap">
                <canvas id="scanCanvas"></canvas>
                <div class="scan-overlay" id="scanOverlay"></div>
                <div class="scan-handle" data-handle="tl"></div>
                <div class="scan-handle" data-handle="tr"></div>
                <div class="scan-handle" data-handle="br"></div>
                <div class="scan-handle" data-handle="bl"></div>
              </div>
              <div class="sig-hint">Drag the corner points to crop and straighten. Tap “Apply Crop” to save the refined scan.</div>
            </div>
          </div>
        </div>
        <div class="sig-container">
          <canvas id="sigCanvas" class="sig-canvas"></canvas>
          <div class="sig-line"></div>
          <span id="sigPlaceholder" class="sig-placeholder">Sign here using your mouse or finger</span>
          <button type="button" id="sigSave" class="sig-save" onclick="saveSignature()">Save</button>
          <button type="button" id="sigClear" class="sig-clear" onclick="clearSignature()">Clear</button>
        </div>
        <div class="sig-hint" id="orientationHint">Tip: rotate your device for more signing space.</div>
        <div class="error-msg" id="sigError">Please provide your signature above.</div>
      </div>
      <div class="form-grid">
        <div class="form-row" id="dateRow">
          <label for="signDate">Date</label>
          <input type="date" id="signDate">
          <div class="error-msg">Please select today's date.</div>
        </div>
      </div>
      <div class="consent-row">
        <input type="checkbox" id="digiConsent">
        <label for="digiConsent" id="consentLabel">By checking this box, I agree that my digital signature captured on this device (or uploaded signature image) is applied to this acknowledgement and is the legal equivalent of my handwritten signature. I confirm I have <strong>reviewed the ADV Teammate Handbook and my State Supplement</strong> and understand the policies and procedures described within them.</label>
      </div>
      <button type="button" class="submit-btn" id="submitBtn" disabled onclick="handleSubmit()">Submit Acknowledgement</button>
    </section>

    <!-- Fax Blank Form Trigger Card -->
    <div class="fax-trigger-card" onclick="openFaxModal('blank')" role="button" tabindex="0">
      <div class="fax-trigger-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z"/></svg>
      </div>
      <div class="fax-trigger-content">
        <h3>Print Blank Form at Your Store</h3>
        <p>Fax a blank acknowledgement form to your store's printer for manual signing.</p>
      </div>
      <div class="fax-trigger-arrow">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"/></svg>
      </div>
    </div>

    <section class="alternate-options">
      <div class="alternate-label">Alternate Options</div>

      <details class="option-card option-dropdown">
        <summary>
          <div class="download-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6.827 6.175 1.1-1.1a1.5 1.5 0 0 1 2.122 0l1.1 1.1h2.851a1.5 1.5 0 0 1 1.5 1.5v8.85a1.5 1.5 0 0 1-1.5 1.5H6.55a1.5 1.5 0 0 1-1.5-1.5v-8.85a1.5 1.5 0 0 1 1.5-1.5h1.277Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5Z"/></svg>
          </div>
          <div class="option-summary">
            <h3>Scan Signed Document</h3>
            <p>Use your camera to scan the signed acknowledgement and submit the enhanced image.</p>
          </div>
          <svg class="option-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6 9 6 6 6-6"/></svg>
        </summary>
        <div class="option-dropdown-body">
          <div class="option-actions">
            <button type="button" class="option-btn" onclick="setSignatureMode('scan'); document.getElementById('sigRow').scrollIntoView({ behavior: 'smooth' });">Start Scan</button>
          </div>
        </div>
      </details>
    </section>
  </main>

  <div class="home-bottom-nav" aria-label="Handbook navigation">
    <button class="toolbar-btn" type="button" onclick="goHome()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>
      <span class="btn-label">Home</span>
    </button>
    <button class="toolbar-btn" type="button" onclick="goHome()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/></svg>
      <span class="btn-label">Search</span>
    </button>
    <button class="toolbar-btn" type="button" onclick="goHandbook()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"/></svg>
      <span class="btn-label">Handbook</span>
    </button>
    <button class="toolbar-btn" type="button" onclick="goSupplements()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25"/></svg>
      <span class="btn-label">Supplements</span>
    </button>
    <button class="toolbar-btn ack-btn" type="button" onclick="goSign()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"/></svg>
      <span class="btn-label">Sign</span>
    </button>
  </div>

  <footer class="footer">&copy; 2025 Advantage Solutions Inc. &nbsp;·&nbsp; All rights reserved.</footer>

  <input type="file" id="hiddenFileInput" accept=".pdf">
  <input type="file" id="sigFileInput" accept="image/*">
  <input type="file" id="scanFileInput" accept="image/*" capture="environment">

  <div class="save-overlay" id="saveOverlay">
    <div class="save-card">
      <div class="save-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5"/></svg>
      </div>
      <h3>Acknowledgement Signed</h3>
      <p>Your signed acknowledgement PDF is ready. Choose how to save it.</p>
      <div class="signer-detail" id="signerDetail"></div>
      <div class="save-buttons">
        <button class="save-btn onedrive" id="onedriveSaveBtn" onclick="saveToOneDrive()">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.39 4.19c1.66-.89 3.73-.78 5.28.32a5.17 5.17 0 0 1 2.2 3.54 4.38 4.38 0 0 1 2.67 1.81 4.34 4.34 0 0 1 .72 3.1 4.36 4.36 0 0 1-1.67 2.85 4.4 4.4 0 0 1-3.14.94H6.13a5.07 5.07 0 0 1-3.55-1.38A4.91 4.91 0 0 1 1.1 12a4.94 4.94 0 0 1 2.1-3.07 5.03 5.03 0 0 1 3.56-.85c.54-1.71 1.78-3.07 3.43-3.59a5.89 5.89 0 0 1 2.2-.3Z"/></svg>
          Save to OneDrive
        </button>
        <div class="onedrive-status" id="onedriveStatus"></div>
        <button class="save-btn download" id="downloadBtn" onclick="downloadPDF()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
          Download PDF to Device
        </button>
        <button class="save-btn download" onclick="openFaxModal('signed')">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z"/></svg>
          Fax Signed Copy to Store
        </button>
        <button class="save-btn done" onclick="closeSaveOverlay()">Close</button>
      </div>
    </div>
  </div>

  <!-- Fax Modal -->
  <div class="fax-modal-overlay" id="faxModalOverlay" onclick="closeFaxModalOnBackdrop(event)">
    <div class="fax-modal" onclick="event.stopPropagation()">
      <div class="fax-modal-header">
        <h3 id="faxModalTitle">Fax to Store</h3>
        <p id="faxModalSubtitle">Select a store to send the acknowledgement form to their printer.</p>
        <button class="fax-modal-close" onclick="closeFaxModal()" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <div class="fax-search-wrap">
        <div class="fax-search-container">
          <span class="fax-search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/></svg>
          </span>
          <input type="text" class="fax-search" id="faxStoreSearch" placeholder="Search by store number or city..." oninput="filterFaxStores()">
        </div>
      </div>

      <div class="fax-store-list" id="faxStoreList">
        <!-- Store items rendered by JS -->
      </div>

      <div class="fax-divider">Or enter fax number</div>

      <div class="fax-direct-input-wrap">
        <input type="tel" class="fax-direct-input" id="faxDirectNumber" placeholder="1 555 555 5555" oninput="onDirectFaxInput()">
        <div class="fax-direct-hint">Enter the full fax number including area code</div>
      </div>

      <div class="fax-modal-footer">
        <button class="fax-send-btn" id="faxSendBtn" onclick="sendFax()" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/></svg>
          <span id="faxSendBtnText">Send Fax</span>
        </button>
        <div class="fax-status" id="faxStatus"></div>
      </div>
    </div>
  </div>

  <script>
    const ONEDRIVE_CLIENT_ID = '';

    function returnToHandbook(e) {
      if (e) e.preventDefault();
      const lastPage = localStorage.getItem('handbookLastPage');
      const lastView = localStorage.getItem('handbookLastView');
      const url = lastView === 'reader' && lastPage ? `index.html#page=${lastPage}` : 'index.html';
      window.location.href = url;
    }

    function goHome() {
      window.location.href = 'index.html';
    }

    function goHandbook() {
      returnToHandbook();
    }

    function goSupplements() {
      window.location.href = 'index.html#supplements';
    }

    function goSign() {
      window.location.href = 'acknowledgement.html';
    }

    /* ═══════════════════════════════════════════════════════════
       SIGNATURE PAD
       ═══════════════════════════════════════════════════════════ */
    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    const placeholder = document.getElementById('sigPlaceholder');
    const clearBtn = document.getElementById('sigClear');
    const saveBtn = document.getElementById('sigSave');
    const signNowBtn = document.getElementById('signNowBtn');
    const orientationHint = document.getElementById('orientationHint');
    const penSizeInput = document.getElementById('penSize');
    const typedInput = document.getElementById('typedSignature');
    const typedFont = document.getElementById('typedFont');
    const sigFileInput = document.getElementById('sigFileInput');
    const faxStore = document.getElementById('faxStore');
    const faxNumber = document.getElementById('faxNumber');
    const blankFaxStore = document.getElementById('blankFaxStore');
    const blankFaxNumber = document.getElementById('blankFaxNumber');
    const signedFaxStore = document.getElementById('signedFaxStore');
    const signedFaxNumber = document.getElementById('signedFaxNumber');
    const consentLabel = document.getElementById('consentLabel');
    const scanFileInput = document.getElementById('scanFileInput');
    const scanCanvas = document.getElementById('scanCanvas');
    const scanCtx = scanCanvas.getContext('2d');
    const scanWrap = document.getElementById('scanWrap');
    const scanOverlay = document.getElementById('scanOverlay');
    const scanHandles = Array.from(document.querySelectorAll('.scan-handle'));

    // ═══════════════════════════════════════════════════════════
    // FAX CONFIGURATION
    // ═══════════════════════════════════════════════════════════
    // Set to Cloud Functions base URL after deploying, e.g.:
    // 'https://us-central1-your-project.cloudfunctions.net'
    // Leave empty for demo mode (shows what would be sent without calling the function)
    const FUNCTIONS_BASE = '';

    // Embedded store data for instant dropdown load (no network call needed)
    // Format: n = storeNumber, l = location, f = faxNumber
    const STORES = [
      {n:"#005",l:"Albany",f:"15419243633"},
      {n:"#011",l:"Northern Lights",f:"19072587894"},
      {n:"#013",l:"Midtown Anchorage",f:"19072778541"},
      {n:"#017",l:"Dimond",f:"19073445621"},
      {n:"#018",l:"Abbott Loop",f:"19073367842"},
      {n:"#019",l:"Eagle River",f:"19076941235"},
      {n:"#021",l:"Wasilla",f:"19073762894"},
      {n:"#023",l:"Bellevue",f:"14256416749"},
      {n:"#024",l:"Ballard",f:"12067891234"},
      {n:"#025",l:"Burien",f:"12062438976"},
      {n:"#028",l:"Federal Way",f:"12538395612"},
      {n:"#030",l:"Kent",f:"12538542178"},
      {n:"#031",l:"Kirkland",f:"14258234561"},
      {n:"#035",l:"Lynnwood",f:"14257781234"},
      {n:"#040",l:"Newport Hills",f:"14256413287"},
      {n:"#041",l:"Redmond",f:"14258834521"},
      {n:"#049",l:"Renton",f:"14252268943"},
      {n:"#050",l:"Renton Highlands",f:"14252714568"},
      {n:"#053",l:"Auburn",f:"12538335127"},
      {n:"#060",l:"Tukwila",f:"12062432198"},
      {n:"#063",l:"University Village",f:"12065225874"},
      {n:"#070",l:"Shoreline",f:"12063632541"},
      {n:"#071",l:"Lake City",f:"12063652874"},
      {n:"#075",l:"Greenwood",f:"12067823145"},
      {n:"#090",l:"West Seattle",f:"12069373241"},
      {n:"#093",l:"Tacoma",f:"12534723698"},
      {n:"#111",l:"Puyallup",f:"12538453217"},
      {n:"#122",l:"Lacey",f:"13604562189"},
      {n:"#125",l:"Olympia",f:"13604913265"},
      {n:"#126",l:"Tumwater",f:"13607524831"},
      {n:"#127",l:"Centralia",f:"13603302178"},
      {n:"#135",l:"Vancouver Mall",f:"13602535498"},
      {n:"#140",l:"Hazel Dell",f:"13605743821"},
      {n:"#143",l:"Salmon Creek",f:"13605743295"},
      {n:"#150",l:"Orchards",f:"13608925431"},
      {n:"#153",l:"Battle Ground",f:"13606872543"},
      {n:"#156",l:"Camas",f:"13608345127"},
      {n:"#158",l:"Washougal",f:"13608352198"},
      {n:"#163",l:"Longview",f:"13604236587"},
      {n:"#165",l:"Kelso",f:"13605773214"},
      {n:"#171",l:"Woodland",f:"13602252148"},
      {n:"#180",l:"Beaverton",f:"15036443521"},
      {n:"#185",l:"Cedar Hills",f:"15036413287"},
      {n:"#186",l:"Sunset",f:"15035913254"},
      {n:"#195",l:"Tigard",f:"15036393241"},
      {n:"#196",l:"Lake Oswego",f:"15036364521"},
      {n:"#198",l:"West Linn",f:"15036573214"},
      {n:"#208",l:"Oregon City",f:"15036558741"},
      {n:"#209",l:"Milwaukie",f:"15036536298"},
      {n:"#210",l:"Clackamas",f:"15037865214"},
      {n:"#214",l:"Happy Valley",f:"15037983265"},
      {n:"#215",l:"Gresham",f:"15036653421"},
      {n:"#218",l:"Wood Village",f:"15036672198"},
      {n:"#220",l:"Troutdale",f:"15036693145"},
      {n:"#224",l:"Sandy",f:"15036682541"},
      {n:"#225",l:"Estacada",f:"15036306587"},
      {n:"#226",l:"Molalla",f:"15038296431"},
      {n:"#227",l:"Canby",f:"15032635498"},
      {n:"#236",l:"Hillsboro",f:"15036816543"},
      {n:"#240",l:"Forest Grove",f:"15033578214"},
      {n:"#242",l:"Cornelius",f:"15033572165"},
      {n:"#253",l:"Aloha",f:"15035912874"},
      {n:"#255",l:"Bethany",f:"15036452317"},
      {n:"#260",l:"Cedar Mill",f:"15036413698"},
      {n:"#265",l:"Rock Creek",f:"15036455431"},
      {n:"#281",l:"Sherwood",f:"15036257841"},
      {n:"#285",l:"Tualatin",f:"15036912365"},
      {n:"#286",l:"Wilsonville",f:"15035826431"},
      {n:"#325",l:"Salem Lancaster",f:"15033625874"},
      {n:"#328",l:"Salem Commercial",f:"15033913265"},
      {n:"#351",l:"Keizer",f:"15033905214"},
      {n:"#355",l:"Woodburn",f:"15039815432"},
      {n:"#360",l:"Silverton",f:"15038731254"},
      {n:"#372",l:"Dallas",f:"15036232541"},
      {n:"#375",l:"McMinnville",f:"15034726587"},
      {n:"#377",l:"Newberg",f:"15035381298"},
      {n:"#383",l:"Lincoln City",f:"15419962147"},
      {n:"#390",l:"Newport",f:"15412653874"},
      {n:"#391",l:"Toledo",f:"15413362541"},
      {n:"#393",l:"Corvallis",f:"15417523698"},
      {n:"#417",l:"Lebanon",f:"15412583214"},
      {n:"#424",l:"Sweet Home",f:"15413672865"},
      {n:"#439",l:"Eugene Coburg",f:"15413431254"},
      {n:"#449",l:"Eugene Delta",f:"15416878521"},
      {n:"#457",l:"Springfield",f:"15417260087"},
      {n:"#458",l:"Junction City",f:"15419983658"},
      {n:"#459",l:"Cottage Grove",f:"15419420147"},
      {n:"#460",l:"Creswell",f:"15418952365"},
      {n:"#462",l:"Roseburg",f:"15416734521"},
      {n:"#464",l:"Grants Pass",f:"15414761254"},
      {n:"#482",l:"Medford",f:"15417738965"},
      {n:"#485",l:"Ashland",f:"15414822541"},
      {n:"#486",l:"Central Point",f:"15416648752"},
      {n:"#516",l:"Klamath Falls",f:"15418849634"},
      {n:"#600",l:"Bend North",f:"15413892147"},
      {n:"#603",l:"Bend South",f:"15413172863"},
      {n:"#604",l:"Redmond OR",f:"15415260078"},
      {n:"#605",l:"Prineville",f:"15414477854"},
      {n:"#608",l:"Madras",f:"15414757523"},
      {n:"#613",l:"La Grande",f:"15419633247"},
      {n:"#614",l:"Baker City",f:"15415235417"},
      {n:"#615",l:"Ontario",f:"15418895632"},
      {n:"#649",l:"Hermiston",f:"15415641258"},
      {n:"#650",l:"Pendleton",f:"15412762541"},
      {n:"#651",l:"Walla Walla",f:"15095221478"},
      {n:"#652",l:"Kennewick",f:"15097352684"},
      {n:"#653",l:"Richland",f:"15099462175"},
      {n:"#654",l:"Pasco",f:"15095474158"},
      {n:"#655",l:"Yakima",f:"15094527836"},
      {n:"#656",l:"Sunnyside",f:"15098362514"},
      {n:"#657",l:"Toppenish",f:"15098652187"},
      {n:"#658",l:"Ellensburg",f:"15099253678"},
      {n:"#659",l:"Moses Lake",f:"15097641258"},
      {n:"#660",l:"Wenatchee",f:"15096622541"},
      {n:"#661",l:"East Wenatchee",f:"15098845214"},
      {n:"#662",l:"Omak",f:"15098262147"},
      {n:"#663",l:"Spokane Valley",f:"15099223541"},
      {n:"#665",l:"Spokane North",f:"15094864521"},
      {n:"#667",l:"Spokane South",f:"15095343287"},
      {n:"#668",l:"Cheney",f:"15092354178"},
      {n:"#681",l:"Coeur d'Alene",f:"12087658234"},
      {n:"#682",l:"Post Falls",f:"12087652874"},
      {n:"#683",l:"Moscow",f:"12088826541"},
      {n:"#685",l:"Lewiston",f:"12087462358"},
      {n:"#688",l:"Sandpoint",f:"12082633214"},
      {n:"#691",l:"Fairbanks",f:"19074564521"},
      {n:"#694",l:"Juneau",f:"19077805241"},
      {n:"#999",l:"Corporate HQ",f:"15032223344"}
    ];

    let drawing = false;
    let hasSig = false;
    let signatureMode = 'draw';
    let signatureEnabled = false;
    let signatureLocked = false;
    let signatureColor = '#0f172a';
    let signatureImage = '';
    let scanImage = '';
    let scanBaseImage = null;
    let scanEnhanced = false;
    let scanPoints = [
      { x: 0.08, y: 0.12 },
      { x: 0.92, y: 0.12 },
      { x: 0.92, y: 0.88 },
      { x: 0.08, y: 0.88 }
    ];

    // Legacy store dropdown population (kept for backwards compatibility)
    function populateStoreOptions(select) {
      if (!select) return;
      select.querySelectorAll('option[data-store]').forEach(opt => opt.remove());
      STORES.forEach(store => {
        const opt = document.createElement('option');
        opt.value = store.n;
        opt.textContent = `${store.n} - ${store.l}`;
        opt.setAttribute('data-store', '1');
        select.appendChild(opt);
      });
    }

    [faxStore, blankFaxStore, signedFaxStore].forEach(populateStoreOptions);

    // ═══════════════════════════════════════════════════════════
    // FAX MODAL
    // ═══════════════════════════════════════════════════════════
    let faxMode = 'blank'; // 'blank' or 'signed'
    let selectedStore = null;
    let faxSending = false;

    const faxModalOverlay = document.getElementById('faxModalOverlay');
    const faxModalTitle = document.getElementById('faxModalTitle');
    const faxModalSubtitle = document.getElementById('faxModalSubtitle');
    const faxStoreList = document.getElementById('faxStoreList');
    const faxStoreSearch = document.getElementById('faxStoreSearch');
    const faxDirectNumber = document.getElementById('faxDirectNumber');
    const faxSendBtn = document.getElementById('faxSendBtn');
    const faxSendBtnText = document.getElementById('faxSendBtnText');
    const faxStatusEl = document.getElementById('faxStatus');

    function openFaxModal(mode) {
      faxMode = mode;
      selectedStore = null;
      faxStoreSearch.value = '';
      faxDirectNumber.value = '';
      faxStatusEl.className = 'fax-status';
      faxStatusEl.textContent = '';
      updateFaxSendButton();

      if (mode === 'blank') {
        faxModalTitle.textContent = 'Fax Blank Form';
        faxModalSubtitle.textContent = 'Send a blank acknowledgement form to your store\'s printer for manual signing.';
      } else {
        faxModalTitle.textContent = 'Fax Signed Copy';
        faxModalSubtitle.textContent = 'Send your signed acknowledgement to your store\'s printer.';
      }

      renderFaxStoreList(STORES);
      faxModalOverlay.classList.add('show');
      document.body.style.overflow = 'hidden';
      setTimeout(() => faxStoreSearch.focus(), 100);
    }

    function closeFaxModal() {
      faxModalOverlay.classList.remove('show');
      document.body.style.overflow = '';
    }

    function closeFaxModalOnBackdrop(e) {
      if (e.target === faxModalOverlay) closeFaxModal();
    }

    function renderFaxStoreList(stores) {
      if (stores.length === 0) {
        faxStoreList.innerHTML = '<div class="fax-no-results">No stores found</div>';
        return;
      }

      faxStoreList.innerHTML = stores.map(store => `
        <div class="fax-store-item${selectedStore && selectedStore.n === store.n ? ' selected' : ''}" 
             data-store="${store.n}" 
             onclick="selectFaxStore('${store.n}')">
          <div class="fax-store-radio">
            <div class="fax-store-radio-inner"></div>
          </div>
          <div class="fax-store-info">
            <div class="fax-store-number">${store.n}</div>
            <div class="fax-store-location">${store.l}</div>
          </div>
          <div class="fax-store-check">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5"/></svg>
          </div>
        </div>
      `).join('');
    }

    function filterFaxStores() {
      const query = faxStoreSearch.value.toLowerCase().trim();
      if (!query) {
        renderFaxStoreList(STORES);
        return;
      }

      const filtered = STORES.filter(store => 
        store.n.toLowerCase().includes(query) || 
        store.l.toLowerCase().includes(query)
      );
      renderFaxStoreList(filtered);
    }

    function selectFaxStore(storeNumber) {
      selectedStore = STORES.find(s => s.n === storeNumber) || null;
      faxDirectNumber.value = ''; // Clear direct number when selecting store

      // Update UI
      document.querySelectorAll('.fax-store-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.store === storeNumber);
      });

      updateFaxSendButton();
    }

    function onDirectFaxInput() {
      // Clear store selection when typing direct number
      if (faxDirectNumber.value.trim()) {
        selectedStore = null;
        document.querySelectorAll('.fax-store-item').forEach(item => {
          item.classList.remove('selected');
        });
      }
      updateFaxSendButton();
    }

    function updateFaxSendButton() {
      const directNum = faxDirectNumber.value.replace(/\D/g, '');
      const hasValidSelection = selectedStore || directNum.length >= 10;
      faxSendBtn.disabled = !hasValidSelection || faxSending;
    }

    function showFaxStatus(type, message) {
      faxStatusEl.className = `fax-status show ${type}`;
      faxStatusEl.textContent = message;
    }

    // Generate blank PDF for faxing
    function generateBlankPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'letter' });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 20;
      const contentW = pageW - margin * 2;
      let y = 20;

      // Header banner
      const bannerH = 26;
      doc.setFillColor(13, 27, 42);
      doc.rect(0, 0, pageW, bannerH, 'F');

      // Header logo if available
      const logo = getHeaderLogoData();
      if (logo) {
        const maxH = bannerH - 6;
        const logoH = Math.min(maxH, 10);
        const logoW = logoH * logo.aspect;
        doc.addImage(logo.dataUrl, 'PNG', pageW - margin - logoW, (bannerH - logoH) / 2, logoW, logoH);
      }

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.setTextColor(255, 255, 255);
      doc.text('ADV Teammate Handbook', margin, 12);
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(148, 163, 184);
      doc.text('Acknowledgement of Receipt  |  Revised February 2025', margin, 20);
      y = 34;

      // Section title
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.setTextColor(13, 27, 42);
      doc.text('Acknowledgement of Receipt', margin, y);
      y += 3;
      doc.setDrawColor(74, 144, 196);
      doc.setLineWidth(0.6);
      doc.line(margin, y, margin + 55, y);
      y += 7;

      // Condensed acknowledgement text
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8.5);
      doc.setTextColor(55, 65, 81);
      
      const condensedText = 'I have received a copy of the Company\'s Handbook and applicable Supplement(s). I agree to read and comply with the policies described within. I understand that failure to follow these policies may result in disciplinary action, up to and including termination. I acknowledge that my employment is "at-will" and that this Handbook does not create a contract of employment. By signing below, I acknowledge receipt of the Handbook and agree to abide by all policies within it.';
      
      const lines = doc.splitTextToSize(condensedText, contentW);
      doc.text(lines, margin, y);
      y += lines.length * 3.8 + 8;

      // Consent checkbox area
      doc.setFillColor(241, 245, 249);
      doc.roundedRect(margin, y, contentW, 14, 2, 2, 'F');
      doc.setDrawColor(100, 116, 139);
      doc.setLineWidth(0.3);
      doc.rect(margin + 4, y + 5, 4, 4);
      doc.setFont('helvetica', 'italic');
      doc.setFontSize(7.5);
      doc.setTextColor(100, 116, 139);
      const consentText = 'I agree that my signature below is the legal equivalent of my handwritten signature acknowledging receipt of the ADV Teammate Handbook.';
      doc.text(doc.splitTextToSize(consentText, contentW - 14), margin + 10, y + 7);
      y += 20;

      // Signature lines
      const colGap = 15;
      const colW = (contentW - colGap) / 2;

      // Printed Name
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(107, 114, 128);
      doc.text('PRINTED TEAMMATE NAME', margin, y);
      y += 4;
      doc.setDrawColor(180, 180, 180);
      doc.setLineWidth(0.4);
      doc.line(margin, y + 12, margin + contentW, y + 12);
      y += 20;

      // Signature and Date side by side
      const sigY = y;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(107, 114, 128);
      doc.text('TEAMMATE SIGNATURE', margin, sigY);
      doc.text('DATE', margin + colW + colGap, sigY);

      // Signature line
      doc.setDrawColor(0, 0, 0);
      doc.setLineWidth(0.5);
      doc.line(margin, sigY + 16, margin + colW, sigY + 16);

      // Date line
      doc.line(margin + colW + colGap, sigY + 16, margin + colW + colGap + colW, sigY + 16);

      // Footer
      const footerY = pageH - 12;
      doc.setDrawColor(209, 213, 219);
      doc.setLineWidth(0.3);
      doc.line(margin, footerY - 4, pageW - margin, footerY - 4);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      doc.setTextColor(156, 163, 175);
      doc.text('© 2025 Advantage Solutions Inc.  |  Confidential', margin, footerY);
      doc.text('Blank Form for Manual Signing', pageW - margin, footerY, { align: 'right' });

      return doc;
    }

    // Main send fax function
    async function sendFax() {
      if (faxSending) return;

      const directNum = faxDirectNumber.value.replace(/\D/g, '');
      const useDirectFax = !selectedStore && directNum.length >= 10;

      if (!selectedStore && !useDirectFax) {
        showFaxStatus('error', 'Please select a store or enter a valid fax number.');
        return;
      }

      faxSending = true;
      faxSendBtn.disabled = true;
      faxSendBtnText.innerHTML = '<span class="spinner"></span> Sending...';

      try {
        // Generate appropriate PDF
        let pdfDoc, fileName;
        if (faxMode === 'blank') {
          pdfDoc = generateBlankPDF();
          fileName = 'Blank_Handbook_Acknowledgement.pdf';
        } else {
          // Use existing signed PDF
          if (!generatedPDF) {
            throw new Error('No signed PDF available. Please submit the form first.');
          }
          pdfDoc = generatedPDF;
          fileName = pdfFileName || 'Signed_Handbook_Acknowledgement.pdf';
        }

        // Convert to base64
        const pdfBase64 = pdfDoc.output('datauristring').split(',')[1];

        // Demo mode check
        if (!FUNCTIONS_BASE) {
          // Demo mode - show what would be sent
          const target = useDirectFax 
            ? `fax number ${formatPhoneNumber(directNum)}`
            : `${selectedStore.l} (${selectedStore.n})`;
          
          showFaxStatus('info', `DEMO MODE: Would send ${faxMode} form to ${target}. Set FUNCTIONS_BASE to enable.`);
          faxSending = false;
          faxSendBtn.disabled = false;
          faxSendBtnText.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/></svg> Send Fax';
          return;
        }

        // Call appropriate Cloud Function
        let response;
        if (useDirectFax) {
          response = await fetch(`${FUNCTIONS_BASE}/sendFaxDirect`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              faxNumber: directNum,
              pdfBase64: pdfBase64,
              fileName: fileName,
              type: faxMode
            })
          });
        } else {
          response = await fetch(`${FUNCTIONS_BASE}/sendFax`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              storeNumber: selectedStore.n,
              pdfBase64: pdfBase64,
              fileName: fileName,
              type: faxMode
            })
          });
        }

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to send fax');
        }

        // Success
        const target = useDirectFax 
          ? formatPhoneNumber(directNum)
          : `${selectedStore.l} (${selectedStore.n})`;
        showFaxStatus('success', `Sent! Your ${faxMode} form is being faxed to ${target}.`);

        // Reset after delay
        setTimeout(() => {
          closeFaxModal();
        }, 2500);

      } catch (error) {
        console.error('Fax error:', error);
        showFaxStatus('error', error.message || 'Failed to send fax. Please try again.');
      } finally {
        faxSending = false;
        faxSendBtn.disabled = false;
        faxSendBtnText.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/></svg> Send Fax';
        updateFaxSendButton();
      }
    }

    function formatPhoneNumber(num) {
      if (num.length === 10) {
        return `(${num.slice(0,3)}) ${num.slice(3,6)}-${num.slice(6)}`;
      } else if (num.length === 11 && num[0] === '1') {
        return `1 (${num.slice(1,4)}) ${num.slice(4,7)}-${num.slice(7)}`;
      }
      return num;
    }

    // Keyboard handler for modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && faxModalOverlay.classList.contains('show')) {
        closeFaxModal();
      }
    });

    // Keyboard handler for fax trigger card
    document.querySelector('.fax-trigger-card')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openFaxModal('blank');
      }
    });

    function resizeCanvas(preserve = true) {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      const previousImage = preserve ? signatureImage : '';
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.lineWidth = parseFloat(penSizeInput.value);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = signatureColor;
      if (previousImage) restoreSignatureImage(previousImage);
    }

    function restoreSignatureImage(dataUrl) {
      const img = new Image();
      img.onload = () => {
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, rect.width, rect.height);
      };
      img.src = dataUrl;
    }

    function updateOrientationHint() {
      const isPortrait = window.matchMedia('(orientation: portrait)').matches;
      const showHint = signatureMode === 'draw' && !hasSig && window.innerWidth <= 900 && isPortrait;
      orientationHint.classList.toggle('sig-hidden', !showHint);
    }

    function setSignatureMode(mode) {
      if (signatureLocked) return;
      signatureMode = mode;
      document.querySelectorAll('.sig-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      document.getElementById('drawControls').classList.toggle('sig-hidden', mode !== 'draw');
      document.getElementById('typeControls').classList.toggle('sig-hidden', mode !== 'type');
      document.getElementById('uploadControls').classList.toggle('sig-hidden', mode !== 'upload');
      document.getElementById('scanControls').classList.toggle('sig-hidden', mode !== 'scan');
      document.getElementById('faxControls').classList.toggle('sig-hidden', mode !== 'fax');
      placeholder.textContent = mode === 'draw' ? 'Sign here using your mouse or finger' : 'Signature preview will appear here';
      saveBtn.classList.toggle('visible', mode === 'draw' && hasSig);
      consentLabel.textContent = mode === 'fax'
        ? 'By checking this box, I confirm I have reviewed the ADV Teammate Handbook and my State Supplement and request this acknowledgement be faxed to my selected store.'
        : mode === 'scan'
        ? 'By checking this box, I confirm the scanned document is my signed acknowledgement and I have reviewed the ADV Teammate Handbook and my State Supplement.'
        : 'By checking this box, I agree that my digital signature captured on this device (or uploaded signature image) is applied to this acknowledgement and is the legal equivalent of my handwritten signature. I confirm I have reviewed the ADV Teammate Handbook and my State Supplement and understand the policies and procedures described within them.';
      signatureEnabled = mode !== 'draw';
      signNowBtn.disabled = mode !== 'draw' || signatureEnabled;
      canvas.classList.toggle('disabled', mode !== 'draw' || (mode === 'draw' && !signatureEnabled));
      if (mode === 'fax' || mode === 'scan') {
        clearSignature();
      }
      if (mode === 'scan') {
        resizeScanCanvas();
      }
      updateOrientationHint();
      checkForm();
    }

    function setInkColor(color) {
      signatureColor = color;
      ctx.strokeStyle = signatureColor;
      document.getElementById('inkBlack').classList.toggle('active', color === '#0f172a');
      document.getElementById('inkBlue').classList.toggle('active', color === '#1d4ed8');
      if (signatureMode === 'type' && typedInput.value.trim()) applyTypedSignature();
    }

    function enableSignaturePad() {
      if (signatureLocked) return;
      signatureEnabled = true;
      canvas.classList.remove('disabled');
      signNowBtn.disabled = true;
      saveBtn.classList.toggle('visible', hasSig);
      updateOrientationHint();
    }

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      const cx = e.touches ? e.touches[0].clientX : e.clientX;
      const cy = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: cx - rect.left, y: cy - rect.top };
    }

    function startDraw(e) {
      if (signatureLocked || signatureMode !== 'draw' || !signatureEnabled) return;
      e.preventDefault();
      drawing = true;
      canvas.classList.add('active');
      const p = getPos(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    }

    function draw(e) {
      if (!drawing || signatureLocked) return;
      e.preventDefault();
      const p = getPos(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      if (!hasSig) {
        hasSig = true;
        placeholder.classList.add('hidden');
        clearBtn.classList.add('visible');
        saveBtn.classList.add('visible');
        canvas.classList.add('has-signature');
        checkForm();
      }
    }

    function stopDraw() {
      if (!drawing) return;
      drawing = false;
      canvas.classList.remove('active');
      if (hasSig) signatureImage = canvas.toDataURL('image/png');
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseleave', stopDraw);
    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDraw);

    function applyTypedSignature() {
      if (signatureLocked) return;
      const text = typedInput.value.trim();
      if (!text) {
        clearSignature();
        return;
      }
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let fontSize = Math.min(64, Math.max(28, rect.width * 0.18));
      ctx.fillStyle = signatureColor;
      ctx.textBaseline = 'middle';
      ctx.textAlign = 'left';
      ctx.font = `${fontSize}px ${typedFont.value}`;
      while (ctx.measureText(text).width > rect.width - 30 && fontSize > 20) {
        fontSize -= 2;
        ctx.font = `${fontSize}px ${typedFont.value}`;
      }
      ctx.fillText(text, 18, rect.height / 2);
      hasSig = true;
      signatureImage = canvas.toDataURL('image/png');
      placeholder.classList.add('hidden');
      clearBtn.classList.add('visible');
      saveBtn.classList.add('visible');
      canvas.classList.add('has-signature');
      checkForm();
    }

    function triggerSignatureUpload() {
      if (signatureLocked) return;
      sigFileInput.click();
    }

    function drawImageToCanvas(dataUrl) {
      const img = new Image();
      img.onload = () => {
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const scale = Math.min(rect.width / img.width, rect.height / img.height);
        const w = img.width * scale;
        const h = img.height * scale;
        const x = (rect.width - w) / 2;
        const y = (rect.height - h) / 2;
        ctx.drawImage(img, x, y, w, h);
        hasSig = true;
        signatureImage = canvas.toDataURL('image/png');
        placeholder.classList.add('hidden');
        clearBtn.classList.add('visible');
        saveBtn.classList.add('visible');
        canvas.classList.add('has-signature');
        checkForm();
      };
      img.src = dataUrl;
    }

    sigFileInput.addEventListener('change', (e) => {
      if (signatureLocked) return;
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => drawImageToCanvas(reader.result);
      reader.readAsDataURL(file);
      e.target.value = '';
    });

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      hasSig = false;
      signatureImage = '';
      placeholder.classList.remove('hidden');
      clearBtn.classList.remove('visible');
      saveBtn.classList.remove('visible');
      canvas.classList.remove('has-signature');
      checkForm();
    }

    function saveSignature() {
      if (signatureLocked || signatureMode !== 'draw' || !hasSig) return;
      signatureImage = canvas.toDataURL('image/png');
      signatureEnabled = false;
      canvas.classList.add('disabled');
      signNowBtn.disabled = false;
      saveBtn.classList.remove('visible');
    }

    /* ═══════════════════════════════════════════════════════════
       SCAN WORKFLOW
       ═══════════════════════════════════════════════════════════ */
    function resizeScanCanvas() {
      const rect = scanWrap.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      scanCanvas.width = rect.width * dpr;
      scanCanvas.height = rect.height * dpr;
      scanCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      renderScanCanvas();
    }

    function getScanDisplay() {
      const rect = scanCanvas.getBoundingClientRect();
      if (!scanBaseImage) return null;
      const scale = Math.min(rect.width / scanBaseImage.width, rect.height / scanBaseImage.height);
      const drawW = scanBaseImage.width * scale;
      const drawH = scanBaseImage.height * scale;
      const offsetX = (rect.width - drawW) / 2;
      const offsetY = (rect.height - drawH) / 2;
      return { scale, offsetX, offsetY, drawW, drawH, rect };
    }

    function renderScanCanvas() {
      const rect = scanCanvas.getBoundingClientRect();
      scanCtx.clearRect(0, 0, rect.width, rect.height);
      if (!scanBaseImage) {
        scanCtx.fillStyle = '#111827';
        scanCtx.fillRect(0, 0, rect.width, rect.height);
        scanCtx.fillStyle = '#64748b';
        scanCtx.font = '14px Plus Jakarta Sans';
        scanCtx.fillText('Capture a photo to begin', 16, 24);
        scanOverlay.style.display = 'none';
        scanHandles.forEach(h => h.style.display = 'none');
        return;
      }
      const display = getScanDisplay();
      if (!display) return;
      const off = document.createElement('canvas');
      off.width = scanBaseImage.width;
      off.height = scanBaseImage.height;
      const offCtx = off.getContext('2d');
      offCtx.drawImage(scanBaseImage, 0, 0);
      if (scanEnhanced) {
        const imgData = offCtx.getImageData(0, 0, off.width, off.height);
        autoEnhanceImageData(imgData);
        offCtx.putImageData(imgData, 0, 0);
      }
      scanCtx.drawImage(off, display.offsetX, display.offsetY, display.drawW, display.drawH);
      drawScanPolygon(display);
      scanOverlay.style.display = 'block';
      scanHandles.forEach(h => h.style.display = 'block');
      positionScanHandles();
    }

    function drawScanPolygon(display) {
      scanCtx.save();
      scanCtx.strokeStyle = 'rgba(74,144,196,0.8)';
      scanCtx.lineWidth = 2;
      scanCtx.beginPath();
      scanPoints.forEach((pt, idx) => {
        const x = pt.x * display.rect.width;
        const y = pt.y * display.rect.height;
        if (idx === 0) scanCtx.moveTo(x, y);
        else scanCtx.lineTo(x, y);
      });
      scanCtx.closePath();
      scanCtx.stroke();
      scanCtx.restore();
    }

    function positionScanHandles() {
      const rect = scanCanvas.getBoundingClientRect();
      scanHandles.forEach(handle => {
        const name = handle.dataset.handle;
        const idx = name === 'tl' ? 0 : name === 'tr' ? 1 : name === 'br' ? 2 : 3;
        const pt = scanPoints[idx];
        handle.style.left = `${pt.x * rect.width}px`;
        handle.style.top = `${pt.y * rect.height}px`;
      });
    }

    function triggerScanCapture() {
      if (signatureLocked) return;
      scanFileInput.click();
    }

    function resetScan() {
      scanBaseImage = null;
      scanImage = '';
      scanEnhanced = false;
      renderScanCanvas();
      checkForm();
    }

    function autoEnhanceImageData(imageData) {
      const data = imageData.data;
      const contrast = 1.15;
      const brightness = 12;
      for (let i = 0; i < data.length; i += 4) {
        data[i] = clampColor((data[i] - 128) * contrast + 128 + brightness);
        data[i + 1] = clampColor((data[i + 1] - 128) * contrast + 128 + brightness);
        data[i + 2] = clampColor((data[i + 2] - 128) * contrast + 128 + brightness);
      }
    }

    function clampColor(v) { return Math.max(0, Math.min(255, v)); }

    function autoEnhanceScan() {
      if (!scanBaseImage) return;
      scanEnhanced = true;
      renderScanCanvas();
    }

    function applyScanCrop() {
      if (!scanBaseImage) return;
      const display = getScanDisplay();
      if (!display) return;
      const srcPts = scanPoints.map(pt => {
        const x = (pt.x * display.rect.width - display.offsetX) / display.scale;
        const y = (pt.y * display.rect.height - display.offsetY) / display.scale;
        return { x: Math.max(0, Math.min(scanBaseImage.width, x)), y: Math.max(0, Math.min(scanBaseImage.height, y)) };
      });
      const outW = Math.max(distance(srcPts[0], srcPts[1]), distance(srcPts[2], srcPts[3]));
      const outH = Math.max(distance(srcPts[0], srcPts[3]), distance(srcPts[1], srcPts[2]));
      const warped = warpImage(scanBaseImage, srcPts, Math.round(outW), Math.round(outH), scanEnhanced);
      scanImage = warped.toDataURL('image/jpeg', 0.92);
      checkForm();
    }

    function distance(a, b) {
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function warpImage(image, srcPts, outW, outH, enhance) {
      const srcCanvas = document.createElement('canvas');
      srcCanvas.width = image.width;
      srcCanvas.height = image.height;
      const srcCtx = srcCanvas.getContext('2d');
      srcCtx.drawImage(image, 0, 0);
      if (enhance) {
        const imgData = srcCtx.getImageData(0, 0, srcCanvas.width, srcCanvas.height);
        autoEnhanceImageData(imgData);
        srcCtx.putImageData(imgData, 0, 0);
      }
      const srcData = srcCtx.getImageData(0, 0, srcCanvas.width, srcCanvas.height);
      const dstCanvas = document.createElement('canvas');
      dstCanvas.width = Math.max(1, outW);
      dstCanvas.height = Math.max(1, outH);
      const dstCtx = dstCanvas.getContext('2d');
      const dstData = dstCtx.createImageData(dstCanvas.width, dstCanvas.height);
      const dstPts = [
        { x: 0, y: 0 },
        { x: dstCanvas.width, y: 0 },
        { x: dstCanvas.width, y: dstCanvas.height },
        { x: 0, y: dstCanvas.height }
      ];
      const H = computeHomography(dstPts, srcPts);
      for (let y = 0; y < dstCanvas.height; y++) {
        for (let x = 0; x < dstCanvas.width; x++) {
          const denom = H[6] * x + H[7] * y + 1;
          const srcX = (H[0] * x + H[1] * y + H[2]) / denom;
          const srcY = (H[3] * x + H[4] * y + H[5]) / denom;
          const idx = (y * dstCanvas.width + x) * 4;
          const color = sampleBilinear(srcData, srcX, srcY);
          dstData.data[idx] = color[0];
          dstData.data[idx + 1] = color[1];
          dstData.data[idx + 2] = color[2];
          dstData.data[idx + 3] = 255;
        }
      }
      dstCtx.putImageData(dstData, 0, 0);
      return dstCanvas;
    }

    function sampleBilinear(imageData, x, y) {
      const w = imageData.width;
      const h = imageData.height;
      if (x < 0 || y < 0 || x >= w || y >= h) return [255, 255, 255];
      const x1 = Math.floor(x);
      const y1 = Math.floor(y);
      const x2 = Math.min(w - 1, x1 + 1);
      const y2 = Math.min(h - 1, y1 + 1);
      const dx = x - x1;
      const dy = y - y1;
      const i11 = (y1 * w + x1) * 4;
      const i12 = (y1 * w + x2) * 4;
      const i21 = (y2 * w + x1) * 4;
      const i22 = (y2 * w + x2) * 4;
      const c = [0, 0, 0];
      for (let i = 0; i < 3; i++) {
        const v11 = imageData.data[i11 + i];
        const v12 = imageData.data[i12 + i];
        const v21 = imageData.data[i21 + i];
        const v22 = imageData.data[i22 + i];
        const v1 = v11 * (1 - dx) + v12 * dx;
        const v2 = v21 * (1 - dx) + v22 * dx;
        c[i] = v1 * (1 - dy) + v2 * dy;
      }
      return c;
    }

    function computeHomography(src, dst) {
      const A = [];
      const b = [];
      for (let i = 0; i < 4; i++) {
        const xs = src[i].x;
        const ys = src[i].y;
        const xd = dst[i].x;
        const yd = dst[i].y;
        A.push([xs, ys, 1, 0, 0, 0, -xs * xd, -ys * xd]);
        b.push(xd);
        A.push([0, 0, 0, xs, ys, 1, -xs * yd, -ys * yd]);
        b.push(yd);
      }
      const h = solveLinearSystem(A, b);
      return [h[0], h[1], h[2], h[3], h[4], h[5], h[6], h[7]];
    }

    function solveLinearSystem(A, b) {
      const n = b.length;
      for (let i = 0; i < n; i++) {
        let maxRow = i;
        for (let k = i + 1; k < n; k++) {
          if (Math.abs(A[k][i]) > Math.abs(A[maxRow][i])) maxRow = k;
        }
        [A[i], A[maxRow]] = [A[maxRow], A[i]];
        [b[i], b[maxRow]] = [b[maxRow], b[i]];
        const pivot = A[i][i] || 1e-12;
        for (let j = i; j < n; j++) A[i][j] /= pivot;
        b[i] /= pivot;
        for (let k = 0; k < n; k++) {
          if (k === i) continue;
          const factor = A[k][i];
          for (let j = i; j < n; j++) A[k][j] -= factor * A[i][j];
          b[k] -= factor * b[i];
        }
      }
      return b;
    }

    let activeHandle = null;
    scanHandles.forEach(handle => {
      handle.addEventListener('pointerdown', (e) => {
        if (signatureLocked) return;
        activeHandle = handle.dataset.handle;
        handle.setPointerCapture(e.pointerId);
      });
    });

    window.addEventListener('pointermove', (e) => {
      if (!activeHandle || !scanBaseImage) return;
      const rect = scanCanvas.getBoundingClientRect();
      const x = Math.min(1, Math.max(0, (e.clientX - rect.left) / rect.width));
      const y = Math.min(1, Math.max(0, (e.clientY - rect.top) / rect.height));
      const idx = activeHandle === 'tl' ? 0 : activeHandle === 'tr' ? 1 : activeHandle === 'br' ? 2 : 3;
      scanPoints[idx] = { x, y };
      renderScanCanvas();
    });

    window.addEventListener('pointerup', () => {
      activeHandle = null;
    });

    scanFileInput.addEventListener('change', (e) => {
      if (signatureLocked) return;
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          scanBaseImage = img;
          scanEnhanced = true;
          scanImage = '';
          scanPoints = [
            { x: 0.08, y: 0.12 },
            { x: 0.92, y: 0.12 },
            { x: 0.92, y: 0.88 },
            { x: 0.08, y: 0.88 }
          ];
          resizeScanCanvas();
          checkForm();
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
      e.target.value = '';
    });
    function lockSignatureControls() {
      signatureLocked = true;
      canvas.classList.add('locked');
      signNowBtn.disabled = true;
      penSizeInput.disabled = true;
      typedInput.disabled = true;
      typedFont.disabled = true;
      faxStore.disabled = true;
      faxNumber.disabled = true;
      blankFaxStore.disabled = true;
      blankFaxNumber.disabled = true;
      signedFaxStore.disabled = true;
      signedFaxNumber.disabled = true;
      clearBtn.disabled = true;
      scanFileInput.disabled = true;
      scanHandles.forEach(handle => handle.style.pointerEvents = 'none');
      document.querySelectorAll('.sig-option, .sig-color, #penSize, #typedSignature, #typedFont').forEach(el => {
        if (el.tagName === 'BUTTON' || el.tagName === 'INPUT' || el.tagName === 'SELECT') {
          el.disabled = true;
        }
      });
    }

    penSizeInput.addEventListener('input', (e) => {
      ctx.lineWidth = parseFloat(e.target.value);
    });
    typedInput.addEventListener('input', () => {
      if (signatureMode === 'type') applyTypedSignature();
    });
    typedFont.addEventListener('change', () => {
      if (signatureMode === 'type') applyTypedSignature();
    });
    window.addEventListener('resize', () => {
      resizeCanvas(true);
      resizeScanCanvas();
      updateOrientationHint();
    });
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        resizeCanvas(true);
        resizeScanCanvas();
        updateOrientationHint();
      }, 200);
    });

    resizeCanvas(true);
    updateOrientationHint();

    /* ═══════════════════════════════════════════════════════════
       FORM VALIDATION
       ═══════════════════════════════════════════════════════════ */
    const dateInput = document.getElementById('signDate');
    const today = new Date();
    dateInput.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
    const nameInput = document.getElementById('printedName');
    const consentBox = document.getElementById('digiConsent');
    const submitBtn = document.getElementById('submitBtn');
    function checkForm() {
      const signatureRequired = signatureMode !== 'fax';
      const signatureOk = signatureMode === 'scan' ? !!scanImage : (signatureRequired ? hasSig : true);
      const faxOk = signatureMode === 'fax' ? (!!faxStore.value || !!faxNumber.value.trim()) : true;
      submitBtn.disabled = !(nameInput.value.trim().length > 0 && dateInput.value && consentBox.checked && signatureOk && faxOk);
    }
    nameInput.addEventListener('input', checkForm);
    dateInput.addEventListener('change', checkForm);
    consentBox.addEventListener('change', checkForm);
    faxStore.addEventListener('change', checkForm);
    faxNumber.addEventListener('input', checkForm);

    /* ═══════════════════════════════════════════════════════════
       PDF GENERATION
       ═══════════════════════════════════════════════════════════ */
    let generatedPDF = null, pdfFileName = '';

    function buildFileName() {
      const parts = nameInput.value.trim().split(/\s+/).filter(Boolean);
      const first = parts[0] || 'Unknown';
      const last = parts.length > 1 ? parts[parts.length - 1] : first;
      const dateParts = (dateInput.value || '').split('-');
      const safeFirst = first.replace(/[^a-zA-Z0-9]/g, '_');
      const safeLast = last.replace(/[^a-zA-Z0-9]/g, '_');
      const dateStamp = dateParts.length === 3 ? `${dateParts[0]}_${dateParts[1]}_${dateParts[2]}` : '0000_00_00';
      return `${safeLast}_${safeFirst}_${dateStamp}_Acknowledgement.pdf`;
    }

    function getHeaderLogoData() {
      const img = document.querySelector('.header-logo');
      if (!img || !img.complete || !img.naturalWidth) return null;
      const canvas = document.createElement('canvas');
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      return { dataUrl: canvas.toDataURL('image/png'), aspect: img.naturalWidth / img.naturalHeight };
    }

    function drawHeaderLogo(doc, bannerH, pageW, margin) {
      const logo = getHeaderLogoData();
      if (!logo) return;
      const maxH = bannerH - 4;
      const logoH = Math.min(maxH, 12);
      const logoW = logoH * logo.aspect;
      const x = pageW - margin - logoW;
      const y = (bannerH - logoH) / 2;
      doc.addImage(logo.dataUrl, 'PNG', x, y, logoW, logoH);
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'letter' });
      const pageW = doc.internal.pageSize.getWidth(); const margin = 20; const contentW = pageW - margin * 2; let y = 20;

      if (signatureMode === 'scan' && scanImage) {
        const bannerH = 18;
        doc.setFillColor(13, 27, 42); doc.rect(0, 0, pageW, bannerH, 'F');
        drawHeaderLogo(doc, bannerH, pageW, margin);
        doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.setTextColor(255, 255, 255);
        doc.text('Acknowledgement Scan', margin, 12);
        doc.setFont('helvetica', 'normal'); doc.setFontSize(8); doc.setTextColor(148, 163, 184);
        doc.text(nameInput.value.trim(), pageW - margin, 12, { align: 'right' });
        const imgProps = doc.getImageProperties(scanImage);
        const maxW = pageW - margin * 2;
        const pageH = doc.internal.pageSize.getHeight();
        const maxH = pageH - 30;
        const ratio = Math.min(maxW / imgProps.width, maxH / imgProps.height);
        const imgW = imgProps.width * ratio;
        const imgH = imgProps.height * ratio;
        doc.addImage(scanImage, 'JPEG', margin, 22, imgW, imgH);
        const footerY = pageH - 8;
        doc.setFontSize(7); doc.setTextColor(156, 163, 175);
        doc.text('Scan submitted via camera', margin, footerY);
        pdfFileName = buildFileName();
        generatedPDF = doc;
        return;
      }

      const bannerH = 30;
      doc.setFillColor(13, 27, 42); doc.rect(0, 0, pageW, bannerH, 'F');
      drawHeaderLogo(doc, bannerH, pageW, margin);
      doc.setFont('helvetica', 'bold'); doc.setFontSize(16); doc.setTextColor(255, 255, 255);
      doc.text('ADV Teammate Handbook', margin, 14);
      doc.setFontSize(10); doc.setFont('helvetica', 'normal'); doc.setTextColor(148, 163, 184);
      doc.text('Acknowledgement of Receipt  |  Revised February 2025', margin, 23);
      y = 40;

      doc.setFont('helvetica', 'bold'); doc.setFontSize(13); doc.setTextColor(13, 27, 42);
      doc.text('Acknowledgement of Receipt', margin, y); y += 3;
      doc.setDrawColor(74, 144, 196); doc.setLineWidth(0.8); doc.line(margin, y, margin + 60, y); y += 8;

      doc.setFont('helvetica', 'normal'); doc.setFontSize(9.5); doc.setTextColor(55, 65, 81);
      const paras = [
        'I have received a copy of the Company\'s Handbook and the applicable Supplement(s) for the locations in which I work. I agree to read it and to comply with the policies and procedures described in the Handbook and Supplement(s). If I have any questions regarding any of the Handbook\'s provisions, I will consult with my supervisor, manager or Human Resources. I understand that if I do not follow the policies and procedures contained herein that I may be subject to disciplinary action, up to and including termination of employment.',
        'I also understand that this Handbook is the most up-to-date version of the Company\'s policies and procedures and replaces any prior written and oral communications about the subjects contained in it.',
        'I acknowledge that my employment relationship with the Company is "at-will", meaning that, regardless of anything contained in this Handbook and regardless of any custom or practice, either I or the Company may terminate my employment at any time, for any reason or no reason, with or without cause, and with or without procedural requirements. I understand that no representatives of the Company, other than the CEO in a writing signed by him/her/them, may enter into any agreements, or make any representations, written or oral, to alter my at-will status or otherwise create any contractual obligation between me and the Company.',
        'I further acknowledge that this handbook and the policies contained herein are not intended to create (and shall not be construed as creating) a contract (express or implied) for employment between the Company and any Teammate and that said policies can be modified by the Company at any time, with or without notice to me, in its sole and absolute discretion.',
        'By signing below, I acknowledge that I have received and will abide by the Company\'s Handbook and all the policies within it, including those on harassment, discrimination, retaliation, and bringing complaints regarding the same.'
      ];
      paras.forEach(p => { const lines = doc.splitTextToSize(p, contentW); doc.text(lines, margin, y); y += lines.length * 4.2 + 4; });
      y += 4;

      const consentBoxSize = 4;
      doc.setFillColor(241, 245, 249); doc.roundedRect(margin, y, contentW, 16, 2, 2, 'F');
      doc.setDrawColor(100, 116, 139); doc.setLineWidth(0.4);
      doc.rect(margin + 4, y + 4, consentBoxSize, consentBoxSize);
      doc.setDrawColor(34, 197, 94); doc.setLineWidth(0.7);
      doc.line(margin + 4.6, y + 6.2, margin + 5.6, y + 7.2);
      doc.line(margin + 5.6, y + 7.2, margin + 7.6, y + 4.8);
      doc.setFont('helvetica', 'italic'); doc.setFontSize(8); doc.setTextColor(100, 116, 139);
      const ct = 'I agree that my digital signature captured on this device is applied to this acknowledgement and is the legal equivalent of my handwritten signature.';
      doc.text(doc.splitTextToSize(ct, contentW - 16), margin + 10, y + 7); y += 22;

      const colGap = 12;
      const colW = (contentW - colGap) / 2;
      const dateText = new Date(dateInput.value + 'T12:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

      doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.setTextColor(31, 41, 55);
      doc.text(nameInput.value.trim(), margin, y);
      doc.setDrawColor(209, 213, 219); doc.setLineWidth(0.4);
      doc.line(margin, y + 3, margin + contentW, y + 3);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(8); doc.setTextColor(107, 114, 128);
      doc.text('PRINTED TEAMMATE NAME', margin, y + 8);
      y += 16;

      const sigY = y;
      const sigBlockTop = sigY - 1;
      const sigBlockHeight = 14;
      if (signatureMode === 'fax') {
        const faxTarget = faxNumber.value.trim() || (faxStore.value ? `Store ${faxStore.value}` : 'N/A');
        doc.setFont('helvetica', 'italic'); doc.setFontSize(9); doc.setTextColor(100, 116, 139);
        doc.text(`Signature pending via fax to ${faxTarget}`, margin, sigY + 8);
      } else if (signatureImage) {
        doc.addImage(signatureImage, 'PNG', margin, sigBlockTop, colW * 0.85, sigBlockHeight);
      }
      doc.setDrawColor(0, 0, 0); doc.setLineWidth(0.6);
      doc.line(margin, sigY + 12, margin + colW, sigY + 12);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(8); doc.setTextColor(107, 114, 128);
      doc.text('TEAMMATE SIGNATURE', margin, sigY + 17);

      doc.setFont('helvetica', 'normal'); doc.setFontSize(11); doc.setTextColor(31, 41, 55);
      doc.text(dateText, margin + colW + colGap, sigY + 8);
      doc.setDrawColor(0, 0, 0); doc.setLineWidth(0.6);
      doc.line(margin + colW + colGap, sigY + 12, margin + colW + colGap + colW, sigY + 12);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(8); doc.setTextColor(107, 114, 128);
      doc.text('DATE', margin + colW + colGap, sigY + 17);

      y = sigY + 24;

      const footerY = doc.internal.pageSize.getHeight() - 12;
      doc.setDrawColor(209, 213, 219); doc.setLineWidth(0.3); doc.line(margin, footerY - 4, pageW - margin, footerY - 4);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(7); doc.setTextColor(156, 163, 175);
      doc.text('\u00A9 2025 Advantage Solutions Inc.  |  Confidential', margin, footerY);
      doc.text('Page 55 of 56', pageW - margin, footerY, { align: 'right' });

      pdfFileName = buildFileName();
      generatedPDF = doc;
    }

    /* ═══════════════════════════════════════════════════════════
       SUBMIT
       ═══════════════════════════════════════════════════════════ */
    function handleSubmit() {
      let err = false;
      if (!nameInput.value.trim()) { document.getElementById('nameRow').classList.add('error'); err = true; } else { document.getElementById('nameRow').classList.remove('error'); }
      const sigError = document.getElementById('sigError');
      if (signatureMode === 'fax') {
        if (!faxStore.value && !faxNumber.value.trim()) {
          sigError.textContent = 'Please select a store or enter a fax number.';
          document.getElementById('sigRow').classList.add('error');
          err = true;
        } else {
          document.getElementById('sigRow').classList.remove('error');
        }
      } else if (signatureMode === 'scan') {
        if (!scanImage) {
          sigError.textContent = 'Please capture and apply a scan of your signed document.';
          document.getElementById('sigRow').classList.add('error');
          err = true;
        } else {
          document.getElementById('sigRow').classList.remove('error');
        }
      } else if (!hasSig) {
        sigError.textContent = 'Please provide your signature above.';
        document.getElementById('sigRow').classList.add('error');
        err = true;
      } else {
        document.getElementById('sigRow').classList.remove('error');
      }
      if (!dateInput.value) { document.getElementById('dateRow').classList.add('error'); err = true; } else { document.getElementById('dateRow').classList.remove('error'); }
      if (err) return;

      generatePDF();
      lockSignatureControls();
      const fd = new Date(dateInput.value + 'T12:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      let delivery = 'Digital signature';
      if (signatureMode === 'fax') {
        delivery = faxNumber.value.trim() ? `Fax to ${faxNumber.value.trim()}` : `Fax to store ${faxStore.value}`;
      } else if (signatureMode === 'scan') {
        delivery = 'Camera scan';
      }
      document.getElementById('signerDetail').innerHTML = `<span><strong>Name:</strong> ${nameInput.value.trim()}</span><span><strong>Date:</strong> ${fd}</span><span><strong>Delivery:</strong> ${delivery}</span><span><strong>File:</strong> ${pdfFileName}</span>`;

      const odBtn = document.getElementById('onedriveSaveBtn');
      const odSt = document.getElementById('onedriveStatus');
      if (!ONEDRIVE_CLIENT_ID || typeof OneDrive === 'undefined') {
        odBtn.style.opacity = '0.5'; odBtn.style.cursor = 'not-allowed';
        odSt.textContent = 'OneDrive integration pending — app registration required';
      } else { odBtn.style.opacity = '1'; odBtn.style.cursor = 'pointer'; odSt.textContent = ''; }

      document.getElementById('saveOverlay').classList.add('show');
    }

    /* ═══════════════════════════════════════════════════════════
       ONEDRIVE SAVE
       ═══════════════════════════════════════════════════════════ */
    function saveToOneDrive() {
      if (!ONEDRIVE_CLIENT_ID) { alert('OneDrive integration is not configured yet.\n\nAn Azure AD App Registration (Client ID) is required.\nUse "Download PDF" for now.'); return; }
      if (typeof OneDrive === 'undefined') { alert('OneDrive SDK not loaded.\n\nEnsure the OneDrive.js script tag is uncommented in the HTML head.'); return; }
      const pdfBlob = generatedPDF.output('blob');
      const file = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });
      const dt = new DataTransfer(); dt.items.add(file);
      document.getElementById('hiddenFileInput').files = dt.files;
      OneDrive.save({
        clientId: ONEDRIVE_CLIENT_ID, action: 'save',
        sourceInputElementId: 'hiddenFileInput', fileName: pdfFileName,
        openInNewWindow: true,
        advanced: { redirectUri: window.location.href },
        success: function() { document.getElementById('onedriveStatus').textContent = '✅ Saved to OneDrive successfully.'; document.getElementById('onedriveStatus').style.color = '#22c55e'; },
        cancel: function() { document.getElementById('onedriveStatus').textContent = 'Save cancelled.'; },
        error: function(e) { console.error('OneDrive error:', e); document.getElementById('onedriveStatus').textContent = 'Error saving — try downloading instead.'; document.getElementById('onedriveStatus').style.color = '#ef4444'; }
      });
    }

    function downloadPDF() { if (generatedPDF) generatedPDF.save(pdfFileName); }
    function closeSaveOverlay() { document.getElementById('saveOverlay').classList.remove('show'); }
    // Legacy functions - now open the fax modal
    function sendBlankFax() {
      openFaxModal('blank');
    }
    function sendSignedFax() {
      openFaxModal('signed');
    }
    document.querySelectorAll('.option-dropdown').forEach(dropdown => dropdown.removeAttribute('open'));
    resizeScanCanvas();
    setSignatureMode('draw');
    checkForm();
  </script>
</body>
</html>
